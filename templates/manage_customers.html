<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Contacts - Order Manager</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="manifest" href="/assets/site.webmanifest">
    <style>
        .back-to-settings-button {
            display: inline-block;
            padding: 0.5rem 1rem;
            color: #dd6b20; /* text-orange-600 */
            font-weight: 600; /* font-semibold */
            text-decoration: none;
            margin-bottom: 1rem;
        }
        .back-to-settings-button:hover {
            color: #c05621; /* text-orange-800 */
        }
        .modal-lg { max-width: 800px; }
        .action-buttons button { margin-left: 5px; }
        textarea { resize: vertical; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    {% include 'partials/navbar.html' %}
    <div class="container mt-6">
        <a href="/settings" target="_top" class="back-to-settings-button">&larr; Back to Settings</a>
        <h1>Manage Contacts</h1>
        <hr>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <button type="button" class="btn btn-primary mb-3" data-toggle="modal" data-target="#contactModal" onclick="prepareAddContactModal()">
            Add New Contact
        </button>

        <hr>
        <h5>Import Contacts from CSV</h5>
        <form id="importCsvForm" action="/api/import-contacts-csv" method="post" enctype="multipart/form-data" class="form-inline mb-3">
            <div class="form-group mr-2">
                <input type="file" class="form-control-file" name="csv_file" id="csv_file" accept=".csv" required>
            </div>
            <button type="submit" class="btn btn-secondary">Import CSV</button>
        </form>
        <hr>

        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Company Name</th>
                    <th>Contact Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="contactsTableBody">
                <!-- Contacts will be loaded here by JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Contact Modal (Add/Edit) -->
    <div class="modal fade" id="contactModal" tabindex="-1" role="dialog" aria-labelledby="contactModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contactModalLabel">Add Contact</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="contactForm">
                        <input type="hidden" id="contactId">
                        <div class="form-group">
                            <label for="contactCompanyName">Company Name</label>
                            <input type="text" class="form-control" id="contactCompanyName" required>
                        </div>
                        <div class="form-group">
                            <label for="contactContactName">Contact Name</label>
                            <input type="text" class="form-control" id="contactContactName">
                        </div>
                        <div class="form-group">
                            <label for="contactEmail">Email</label>
                            <input type="email" class="form-control" id="contactEmail">
                        </div>
                        <div class="form-group">
                            <label for="contactPhone">Phone</label>
                            <input type="tel" class="form-control" id="contactPhone">
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-12">
                                <label for="contactShippingAddress">Shipping Address</label>
                                <input type="text" class="form-control" id="contactShippingAddress">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="contactShippingCity">City</label>
                                <input type="text" class="form-control" id="contactShippingCity">
                            </div>
                            <div class="form-group col-md-4">
                                <label for="contactShippingState">State</label>
                                <input type="text" class="form-control" id="contactShippingState">
                            </div>
                            <div class="form-group col-md-2">
                                <label for="contactShippingZipCode">Zip Code</label>
                                <input type="text" class="form-control" id="contactShippingZipCode">
                            </div>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="sameAsShipping" onchange="toggleBillingAddress(this.checked)">
                            <label class="form-check-label" for="sameAsShipping">
                                Billing address is the same as shipping
                            </label>
                        </div>
                        <div id="billingAddressSection">
                            <div class="form-row">
                                <div class="form-group col-md-12">
                                    <label for="contactBillingAddress">Billing Address</label>
                                    <input type="text" class="form-control" id="contactBillingAddress">
                                </div>
                            </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="contactBillingCity">City</label>
                                <input type="text" class="form-control" id="contactBillingCity">
                            </div>
                            <div class="form-group col-md-4">
                                <label for="contactBillingState">State</label>
                                <input type="text" class="form-control" id="contactBillingState">
                            </div>
                            <div class="form-group col-md-2">
                                <label for="contactBillingZipCode">Zip Code</label>
                                <input type="text" class="form-control" id="contactBillingZipCode">
                            </div>
                        </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveContact()">Save Contact</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function() {
            loadContacts();
        });

        let allContacts = []; // To store contacts for editing

        function loadContacts() {
            fetch('/api/contacts')
                .then(response => response.json())
                .then(data => {
                    allContacts = data; // Store for later use
                    const tableBody = $('#contactsTableBody');
                    tableBody.empty(); 
                    allContacts.forEach(contact => {
                        const row = `
                            <tr>
                                <td>${contact.companyName || 'N/A'}</td>
                                <td>${contact.contactName || 'N/A'}</td>
                                <td>${contact.email || 'N/A'}</td>
                                <td>${contact.phone || 'N/A'}</td>
                                <td class="action-buttons">
                                    <button class="btn btn-sm btn-info" onclick="prepareEditContactModal('${contact.id}')">Edit</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteContact('${contact.id}')">Delete</button>
                                </td>
                            </tr>
                        `;
                        tableBody.append(row);
                    });
                })
                .catch(error => console.error('Error loading contacts:', error));
        }

        function prepareAddContactModal() {
            $('#contactModalLabel').text('Add New Contact');
            $('#contactForm')[0].reset();
            $('#contactId').val('');
        }

        function prepareEditContactModal(contactId) {
            const contact = allContacts.find(c => c.id === contactId);
            if (contact) {
                $('#contactModalLabel').text('Edit Contact');
                $('#contactId').val(contact.id);
                $('#contactCompanyName').val(contact.companyName || '');
                $('#contactContactName').val(contact.contactName || '');
                $('#contactEmail').val(contact.email || '');
                $('#contactPhone').val(contact.phone || '');
                $('#contactShippingAddress').val(contact.shippingAddress || '');
                $('#contactShippingCity').val(contact.shippingCity || '');
                $('#contactShippingState').val(contact.shippingState || '');
                $('#contactShippingZipCode').val(contact.shippingZipCode || '');

                const sameAsShipping = contact.shippingAddress === contact.billingAddress &&
                                     contact.shippingCity === contact.billingCity &&
                                     contact.shippingState === contact.billingState &&
                                     contact.shippingZipCode === contact.billingZipCode;

                $('#sameAsShipping').prop('checked', sameAsShipping);
                toggleBillingAddress(sameAsShipping);

                if (!sameAsShipping) {
                    $('#contactBillingAddress').val(contact.billingAddress || '');
                    $('#contactBillingCity').val(contact.billingCity || '');
                    $('#contactBillingState').val(contact.billingState || '');
                    $('#contactBillingZipCode').val(contact.billingZipCode || '');
                }

                $('#contactModal').modal('show');
            } else {
                alert('Contact not found for editing.');
            }
        }

        function saveContact() {
            const contactId = $('#contactId').val();
            const sameAsShipping = $('#sameAsShipping').is(':checked');
            const contactData = {
                companyName: $('#contactCompanyName').val().trim(),
                contactName: $('#contactContactName').val().trim(),
                email: $('#contactEmail').val().trim(),
                phone: $('#contactPhone').val().trim(),
                shippingAddress: $('#contactShippingAddress').val().trim(),
                shippingCity: $('#contactShippingCity').val().trim(),
                shippingState: $('#contactShippingState').val().trim(),
                shippingZipCode: $('#contactShippingZipCode').val().trim(),
                billingAddress: sameAsShipping ? $('#contactShippingAddress').val().trim() : $('#contactBillingAddress').val().trim(),
                billingCity: sameAsShipping ? $('#contactShippingCity').val().trim() : $('#contactBillingCity').val().trim(),
                billingState: sameAsShipping ? $('#contactShippingState').val().trim() : $('#contactBillingState').val().trim(),
                billingZipCode: sameAsShipping ? $('#contactShippingZipCode').val().trim() : $('#contactBillingZipCode').val().trim(),
            };

            if (!contactData.companyName) {
                alert('Company Name is required.');
                return;
            }

            let url = '/api/contacts';
            let method = 'POST';

            if (contactId) { // If contactId exists, it's an update (PUT)
                url = `/api/contacts/${contactId}`;
                method = 'PUT';
                contactData.id = contactId; 
            }

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(contactData),
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(result => {
                if (result.status === 200 || result.status === 201) {
                    $('#contactModal').modal('hide');
                    loadContacts(); 
                    alert(result.body.message || 'Contact saved successfully!');
                } else {
                    alert('Error saving contact: ' + (result.body.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error saving contact:', error);
                alert('Error saving contact. See console for details.');
            });
        }

        function deleteContact(contactId) {
            if (!confirm('Are you sure you want to delete this contact? This action cannot be undone.')) {
                return;
            }

            fetch(`/api/contacts/${contactId}`, {
                method: 'DELETE',
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(result => {
                if (result.status === 200) {
                    loadContacts(); 
                    alert(result.body.message || 'Contact deleted successfully!');
                } else {
                    alert('Error deleting contact: ' + (result.body.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error deleting contact:', error);
                alert('Error deleting contact. See console for details.');
            });
        }

        function toggleBillingAddress(isSame) {
            if (isSame) {
                $('#billingAddressSection').hide();
            } else {
                $('#billingAddressSection').show();
            }
        }
    </script>
</body>
</html>
