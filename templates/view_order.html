<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Order</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="/assets/css/styles.css">
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    <nav class="bg-slate-900 text-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex h-16 items-center justify-between">
                <div class="flex items-center space-x-10">
                    <a href="/dashboard" id="nav-home-link" class="text-lg font-semibold tracking-wide">FireCoast OMS</a>
                    <div class="hidden md:flex items-center space-x-6 text-sm font-medium">
                        <a href="/orders" id="nav-orders-link" class="text-orange-300">Orders</a>
                        <a href="/contacts" class="hover:text-orange-300 transition">Contacts</a>
                        <a href="/analytics" class="hover:text-orange-300 transition">Analytics</a>
                        <a href="/passwords" class="hover:text-orange-300 transition">Password Manager</a>
                    </div>
                </div>
                <div class="flex items-center space-x-3 text-sm font-medium">
                    <a href="/settings" class="hover:text-orange-300 transition">Settings</a>
                    <a href="#" id="nav-log-out" class="hover:text-orange-300 transition">Log Out</a>
                </div>
            </div>
        </div>
    </nav>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const brandLink = document.getElementById('nav-home-link');
            if (brandLink) {
                brandLink.addEventListener('click', (event) => {
                    event.preventDefault();
                    window.location.href = '/dashboard';
                });
            }

            const ordersLink = document.getElementById('nav-orders-link');
            if (ordersLink) {
                ordersLink.addEventListener('click', (event) => {
                    if (window.fireCoastNavigateTo) {
                        event.preventDefault();
                        window.fireCoastNavigateTo('dashboard');
                    }
                });
            }

            const logoutLink = document.getElementById('nav-log-out');
            if (logoutLink) {
                logoutLink.addEventListener('click', async (event) => {
                    event.preventDefault();
                    if (window.fireCoastLogout) {
                        window.fireCoastLogout();
                        return;
                    }
                    try {
                        const response = await fetch('/shutdown', { method: 'POST' });
                        if (response.ok) {
                            document.body.innerHTML = '<div class="min-h-screen flex items-center justify-center text-slate-700 text-lg">Application has been shut down. You can now close this tab.</div>';
                        } else {
                            alert('Failed to log out.');
                        }
                    } catch (error) {
                        console.error('Error logging out:', error);
                        alert('Error attempting to log out.');
                    }
                });
            }
        });
    </script>
    <main class="py-10">
        <div id="root" data-order-id="{{ order_id }}" class="orders-app"></div>
    </main>

    {% raw %}
    <script type="text/babel">
        const formatInTimeZone = (dateString, timeZone, options = {}) => {
            try {
                const date = new Date(dateString);
                return date.toLocaleString('en-US', { ...options, timeZone });
            } catch (e) {
                console.error("Error formatting date:", e);
                return "Invalid Date";
            }
        };

        const hexToRgb = (hex) => {
            if (typeof hex !== 'string') return null;
            let normalized = hex.trim();
            if (!/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(normalized)) return null;
            normalized = normalized.slice(1);
            if (normalized.length === 3) {
                normalized = normalized.split('').map(char => char + char).join('');
            }
            const intVal = parseInt(normalized, 16);
            return {
                r: (intVal >> 16) & 255,
                g: (intVal >> 8) & 255,
                b: intVal & 255,
            };
        };

const normalizePhoneDigits = (value = '') => (value || '').replace(/\D/g, '').slice(0, 10);

const formatPhoneNumber = (value = '') => {
    const digits = normalizePhoneDigits(value);
    if (!digits) return '';
            if (digits.length < 4) {
                const closing = digits.length === 3 ? ')' : '';
                return `(${digits}${closing}`;
            }
            if (digits.length < 7) {
                return `(${digits.slice(0, 3)}) ${digits.slice(3)}`;
            }
    return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)} ${digits.slice(6)}`;
};

const sanitizePlaceholderValue = (value) => {
    if (!value) return '';
    const trimmed = value.toString().trim();
    if (!trimmed) return '';
    const lowered = trimmed.toLowerCase();
    if (lowered === '[no contact found]' || lowered === 'no contact found') {
        return '';
    }
    return trimmed;
};

const parseCurrencyToNumber = (value) => {
    if (typeof value === 'number' && Number.isFinite(value)) {
        return value;
    }
    if (typeof value === 'string') {
        const cleaned = value.replace(/[^0-9.-]/g, '');
        const parsed = parseFloat(cleaned);
        return Number.isFinite(parsed) ? parsed : 0;
    }
    return 0;
};

const centsToCurrency = (cents) => {
    return (Math.round(cents) / 100).toFixed(2);
};

const normalizeDiscountsForTotals = (discounts, lineItems) => {
    const lineItemTotals = new Map();
    const orderedKeys = [];
    (Array.isArray(lineItems) ? lineItems : []).forEach((item) => {
        const key = item && item.id != null ? String(item.id) : null;
        if (!key || lineItemTotals.has(key)) {
            return;
        }
        const quantity = Number(item.quantity) || 0;
        const price = Number(item.price) || 0;
        const total = Math.max(0, quantity) * Math.max(0, price);
        lineItemTotals.set(key, total);
        orderedKeys.push(key);
    });

    const normalized = [];
    if (!Array.isArray(discounts)) {
        return normalized;
    }

    discounts.forEach((entry, index) => {
        const rawId = entry && entry.id != null ? entry.id : `discount-${index + 1}`;
        const id = String(rawId);
        const label = typeof entry?.label === 'string' ? entry.label.trim() : '';
        const type = entry?.type === 'percentage' ? 'percentage' : 'fixed';
        const rawValue = entry?.value ?? '';

        const appliesRaw = Array.isArray(entry?.appliesTo) ? entry.appliesTo : [];
        const appliesSanitized = [];
        const appliesKeys = [];
        appliesRaw.forEach((candidate) => {
            const key = String(candidate);
            if (lineItemTotals.has(key) && !appliesKeys.includes(key)) {
                appliesKeys.push(key);
                appliesSanitized.push(String(candidate));
            }
        });

        const baseKeys = appliesKeys.length ? appliesKeys : orderedKeys;
        const baseAmountCents = baseKeys.reduce((sum, key) => sum + (lineItemTotals.get(key) || 0), 0);
        let amountCents = 0;

        if (type === 'percentage') {
            let percentage = parseFloat(rawValue);
            if (!Number.isFinite(percentage) || percentage < 0) {
                percentage = 0;
            }
            amountCents = Math.round(baseAmountCents * (percentage / 100));
        } else {
            const numeric = parseCurrencyToNumber(rawValue);
            const fixedCents = Math.round(Math.max(0, numeric) * 100);
            amountCents = Math.min(fixedCents, baseAmountCents);
        }

        amountCents = Math.max(0, amountCents);

        normalized.push({
            id,
            label,
            type,
            value: rawValue,
            appliesTo: appliesSanitized,
            appliesToAll: appliesKeys.length === 0,
            amountCents,
            baseAmountCents,
        });
    });

    return normalized;
};

const ContactMentionTextarea = ({ label, placeholder, value, onChange, disabled = false, rows = 3, contacts = [] }) => {
    const { useState, useRef, useEffect, useMemo } = React;
    const textareaRef = useRef(null);
    const overlayRef = useRef(null);
    const [suggestions, setSuggestions] = useState([]);
    const [isOpen, setIsOpen] = useState(false);
    const [highlightIndex, setHighlightIndex] = useState(0);
    const lastCaretRef = useRef(0);

    const escapeHtml = (input = '') => String(input)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

    const formatSpaces = (input = '') => input.replace(/ {2,}/g, match => '&nbsp;'.repeat(match.length - 1) + ' ');

    const buildHighlightedHtml = useMemo(() => {
        const rawValue = value || '';
        if (!rawValue.trim()) {
            return `<span class="text-slate-400">${escapeHtml(placeholder || '')}</span>`;
        }
        const escaped = escapeHtml(rawValue);
        const withMentions = escaped.replace(/(@[a-z0-9_.-]+)/gi, '<span class="mention-pill inline-flex items-center gap-1 rounded-full bg-orange-100 px-2 py-0.5 text-xs font-semibold text-orange-700">$1</span>');
        const withBreaks = withMentions.replace(/\r?\n/g, '<br />');
        return formatSpaces(withBreaks);
    }, [value, placeholder]);

    const syncOverlayScroll = () => {
        const textarea = textareaRef.current;
        const overlay = overlayRef.current;
        if (!textarea || !overlay) return;
        overlay.scrollTop = textarea.scrollTop;
        overlay.scrollLeft = textarea.scrollLeft;
    };

    const findMentionQuery = (text, caretPosition) => {
        const uptoCaret = text.slice(0, caretPosition);
        const match = uptoCaret.match(/@([a-z0-9_.-]*)$/i);
        if (match) {
            return match[1].toLowerCase();
        }
        return null;
    };

    const updateSuggestions = (text, caret) => {
        const query = findMentionQuery(text, caret);
        if (query === null) {
            setSuggestions([]);
            setIsOpen(false);
            setHighlightIndex(0);
            return;
        }
        const filtered = contacts
            .filter(contact => contact.handle)
            .filter(contact => {
                if (!query) return true;
                const handle = contact.handle.toLowerCase();
                const name = (contact.contactName || '').toLowerCase();
                const company = (contact.companyName || '').toLowerCase();
                return handle.startsWith(query) || name.includes(query) || company.includes(query);
            })
            .slice(0, 8);
        setSuggestions(filtered);
        setIsOpen(filtered.length > 0);
        setHighlightIndex(0);
    };

    const applyMention = (contact) => {
        const textarea = textareaRef.current;
        if (!textarea) return;
        const caret = textarea.selectionStart;
        const text = textarea.value;
        const uptoCaret = text.slice(0, caret);
        const match = uptoCaret.match(/@([a-z0-9_.-]*)$/i);
        if (!match) return;
        const queryLength = match[1].length;
        const insertionPoint = caret - queryLength;
        const replacement = `@${contact.handle} `;
        const newValue = text.slice(0, insertionPoint) + replacement + text.slice(caret);
        onChange(newValue);
        requestAnimationFrame(() => {
            textarea.focus();
            const newCaret = insertionPoint + replacement.length;
            textarea.setSelectionRange(newCaret, newCaret);
        });
        setSuggestions([]);
        setIsOpen(false);
    };

    const handleChange = (event) => {
        const newValue = event.target.value;
        onChange(newValue);
        const caret = event.target.selectionStart;
        lastCaretRef.current = caret;
        updateSuggestions(newValue, caret);
    };

    const handleKeyDown = (event) => {
        if (!isOpen || suggestions.length === 0) return;
        if (event.key === 'ArrowDown') {
            event.preventDefault();
            setHighlightIndex(prev => (prev + 1) % suggestions.length);
        } else if (event.key === 'ArrowUp') {
            event.preventDefault();
            setHighlightIndex(prev => (prev - 1 + suggestions.length) % suggestions.length);
        } else if (event.key === 'Enter' || event.key === 'Tab') {
            const selected = suggestions[highlightIndex];
            if (selected) {
                event.preventDefault();
                applyMention(selected);
            }
        } else if (event.key === 'Escape') {
            setIsOpen(false);
        }
    };

    useEffect(() => {
        const textarea = textareaRef.current;
        if (!textarea) return;
        const handler = () => {
            const caret = textarea.selectionStart;
            lastCaretRef.current = caret;
            updateSuggestions(textarea.value, caret);
        };
        textarea.addEventListener('click', handler);
        textarea.addEventListener('keyup', handler);
        textarea.addEventListener('scroll', syncOverlayScroll);
        return () => {
            textarea.removeEventListener('click', handler);
            textarea.removeEventListener('keyup', handler);
            textarea.removeEventListener('scroll', syncOverlayScroll);
        };
    }, [contacts]);

    useEffect(() => {
        syncOverlayScroll();
    }, [value]);

    return (
        <div className="relative">
            {label !== undefined && label !== null && label !== '' && (
                <label className="block text-sm font-medium text-slate-700">{label}</label>
            )}
            <div className="relative mt-1">
                <div
                    ref={overlayRef}
                    aria-hidden="true"
                    className={`pointer-events-none absolute inset-0 px-3 py-2 text-sm leading-relaxed whitespace-pre-wrap break-words rounded-md ${disabled ? 'bg-slate-100 text-slate-500' : 'bg-white text-slate-700'}`}
                    dangerouslySetInnerHTML={{ __html: buildHighlightedHtml }}
                ></div>
                <textarea
                    ref={textareaRef}
                    rows={rows}
                    placeholder={placeholder}
                    value={value}
                    onChange={handleChange}
                    onKeyDown={handleKeyDown}
                    disabled={disabled}
                    className={`relative block w-full resize-y rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-transparent text-transparent placeholder-transparent caret-orange-500 selection:bg-orange-200 selection:text-transparent`}
                    style={{ WebkitTextFillColor: 'transparent' }}
                />
            </div>
            {isOpen && suggestions.length > 0 && (
                <div className="absolute z-20 mt-1 w-full max-h-56 overflow-y-auto rounded-md border border-slate-200 bg-white shadow-lg">
                    {suggestions.map((contact, index) => (
                        <button
                            type="button"
                            key={contact.id || contact.handle || index}
                            onMouseDown={(event) => { event.preventDefault(); applyMention(contact); }}
                            className={`w-full text-left px-3 py-2 text-sm ${highlightIndex === index ? 'bg-orange-100 text-orange-900' : 'text-slate-700 hover:bg-orange-50'}`}
                        >
                            <span className="font-semibold">@{contact.handle}</span>
                            <span className="ml-2 text-xs text-slate-500">{contact.contactName || contact.companyName}</span>
                        </button>
                    ))}
                </div>
            )}
        </div>
    );
};

const getContactDisplayName = (contact) => {
    if (!contact) {
        return 'Unnamed contact';
    }
    const name = sanitizePlaceholderValue(contact.contactName);
    const company = sanitizePlaceholderValue(contact.companyName);
    const email = (contact.email || '').trim();
    const handle = (contact.handle || '').trim();
    return name || company || email || (handle ? `@${handle}` : 'Unnamed contact');
};

const formatContactAddress = (address, city, state, zip) => {
    const parts = [];
    if (address && address.trim()) {
        parts.push(address.trim());
    }
    const cityState = [city, state].map(part => (part || '').trim()).filter(Boolean).join(', ');
    if (cityState) {
        parts.push(cityState);
    }
    if (zip && zip.trim()) {
        parts.push(zip.trim());
    }
    return parts.length > 0 ? parts.join(' ') : 'Not provided';
};

        const AddLogModal = ({ orderId, onClose, onLogAdded, contacts }) => {
            const { useState, useRef } = React;
            const [action, setAction] = useState('Manual Entry');
            const [details, setDetails] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const fileInputRef = useRef(null);

            const isStatusUpdate = ['status update', 'status'].includes(action.toLowerCase());

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);

                const formData = new FormData();
                formData.append('action', action);
                formData.append('details', details);
                if (fileInputRef.current.files[0]) {
                    formData.append('attachment', fileInputRef.current.files[0]);
                }

                try {
                    const response = await fetch(`/api/orders/${orderId}/logs`, {
                        method: 'POST',
                        body: formData, // No 'Content-Type' header, browser sets it for FormData
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'Failed to add log. Please check server logs.' }));
                        throw new Error(errorData.message);
                    }
                    const newLog = await response.json();
                    onLogAdded(newLog);
                    onClose();
                } catch (error) {
                    console.error("Error adding log:", error.message);
                    alert(`Failed to add log entry: ${error.message}`);
                } finally {
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
                    <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
                        <h2 className="text-xl font-bold mb-4">Add Order Log</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label htmlFor="action" className="block text-sm font-medium text-slate-700">Action</label>
                                <select id="action" value={action} onChange={e => setAction(e.target.value)} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500">
                                    <option value="Manual Entry">Manual Entry</option>
                                    <option value="Status Update">Status Update</option>
                                    <option value="Phone Call">Phone Call</option>
                                    <option value="Email">Email</option>
                                    <option value="Internal Note">Internal Note</option>
                                </select>
                            </div>
                            <div className="mb-4">
                                <label htmlFor="details" className="block text-sm font-medium text-slate-700">{isStatusUpdate ? 'New Status' : 'Details'}</label>
                                <ContactMentionTextarea
                                    label={isStatusUpdate ? 'New Status' : 'Details'}
                                    value={details}
                                    onChange={setDetails}
                                    placeholder={isStatusUpdate ? 'Enter the new status...' : 'Enter details about the log...'}
                                    rows={3}
                                    contacts={contacts}
                                />
                            </div>
                            <div className="mb-4">
                                <label htmlFor="attachment" className="block text-sm font-medium text-slate-700">Attachment</label>
                                <input type="file" id="attachment" ref={fileInputRef} className="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100" />
                            </div>
                            <div className="flex justify-end gap-3 mt-6">
                                <button type="button" onClick={onClose} disabled={isSubmitting} className="px-4 py-2 bg-slate-200 text-slate-800 font-semibold rounded-md hover:bg-slate-300 transition-colors">Cancel</button>
                                <button type="submit" disabled={isSubmitting} className="px-4 py-2 bg-orange-600 text-white font-semibold rounded-md hover:bg-orange-700 transition-colors disabled:bg-orange-300">{isSubmitting ? 'Saving...' : 'Add Log'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const generateInvoicePdf = (order, itemsIndex = {}, brandingOverride = {}, action = 'preview') => {
            if (!order) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const safeItems = itemsIndex || {};
            const safeOrder = order || {};
            const displayId = typeof safeOrder.display_id === 'string' ? safeOrder.display_id : null;
            const orderId = safeOrder.id || '';
            const orderTitle = (safeOrder.title || '').trim();
            const orderNumber = (displayId && displayId.trim()) || orderId;
            const timeZone = "America/Chicago";
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = safeOrder.date ? formatInTimeZone(safeOrder.date, timeZone, dateOptions) : '—';

            const mergedBranding = {
                ...(window.fireCoastBranding || {}),
                ...(brandingOverride || {}),
            };
            const accentRgb = hexToRgb(mergedBranding.invoice_brand_color) || { r: 249, g: 115, b: 22 };
            const businessName = (mergedBranding.invoice_business_name || '').trim();
            const businessDetails = (mergedBranding.invoice_business_details || '').trim();
            const invoiceFooter = (mergedBranding.invoice_footer || '').trim();
            const logoDataUrl = (mergedBranding.invoice_logo_data_url || '').trim();
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            const businessDetailLines = businessDetails
                ? doc.splitTextToSize(businessDetails, 90)
                : [];
            const invoiceInfoLines = [
                `Order #: ${orderNumber || '—'}`,
                orderTitle ? `Title: ${orderTitle}` : null,
                `Date: ${formattedDate}`,
            ].filter(Boolean);
            const logoHeight = logoDataUrl ? 24 : 0;
            const nameHeight = businessName ? 7 : 0;
            const detailHeight = businessDetailLines.length * 4;
            const invoiceInfoHeight = 10 + (invoiceInfoLines.length * 5);
            const topSectionContentHeight = Math.max(logoHeight, nameHeight + detailHeight, invoiceInfoHeight) || 0;
            const backgroundTop = 14;
            const backgroundHeight = topSectionContentHeight + 16;
            doc.setDrawColor(226, 232, 240);
            doc.setFillColor(248, 250, 252);
            doc.roundedRect(12, backgroundTop, 186, Math.max(backgroundHeight, 28), 4, 4, 'FD');

            const contentLeft = 14;
            const contentTop = backgroundTop + 12;
            let leftTextX = contentLeft;
            let leftTextY = contentTop;
            if (logoDataUrl) {
                try {
                    doc.addImage(logoDataUrl, 'PNG', leftTextX, contentTop - 6, 32, 24);
                    leftTextX += 36;
                } catch (error) {
                    console.error('Unable to render invoice logo:', error);
                }
            }
            if (businessName) {
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.text(businessName, leftTextX, leftTextY);
                leftTextY += 7;
            }
            if (businessDetailLines.length) {
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                businessDetailLines.forEach((line) => {
                    doc.text(line, leftTextX, leftTextY);
                    leftTextY += 4;
                });
            }

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.setTextColor(accentRgb.r, accentRgb.g, accentRgb.b);
            doc.text('Invoice', 196, contentTop, { align: 'right' });
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            let invoiceLineY = contentTop + 6;
            invoiceInfoLines.forEach((line) => {
                doc.text(line, 196, invoiceLineY, { align: 'right' });
                invoiceLineY += 5;
            });

            const topSectionBottom = backgroundTop + Math.max(backgroundHeight, 28);

            const baseContact = safeOrder.contactInfo || {};
            const contactInfo = {
                companyName: '',
                contactName: '',
                email: '',
                phone: '',
                billingAddress: '',
                billingCity: '',
                billingState: '',
                billingZipCode: '',
                shippingAddress: '',
                shippingCity: '',
                shippingState: '',
                shippingZipCode: '',
                ...baseContact
            };

            const renderBlock = (label, lines, x, y, wrapWidth = null) => {
                doc.setFontSize(12);
                doc.text(label, x, y);
                y += 6;
                doc.setFontSize(10);
                if (!lines.length) {
                    doc.text('—', x, y);
                    return y + 7;
                }
                if (wrapWidth) {
                    const wrapped = doc.splitTextToSize(lines.join('\n'), wrapWidth);
                    doc.text(wrapped, x, y);
                    return y + (wrapped.length * 4) + 2;
                }
                lines.forEach((line) => {
                    doc.text(line, x, y);
                    y += 5;
                });
                return y + 2;
            };

            const buildAddressLines = (address, city, state, zip) => {
                const lines = [];
                if (address) lines.push(address);
                const locality = [city, state].filter(Boolean).join(', ');
                const postalLine = [locality, zip].filter(Boolean).join(' ');
                if (postalLine.trim()) lines.push(postalLine.trim());
                return lines;
            };

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(12);
            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.2);

            let leftColumnY = topSectionBottom + 10;
            let rightColumnY = topSectionBottom + 10;
            const leftColumnX = 14;
            const rightColumnX = 105;

            const customerPhone = formatPhoneNumber(contactInfo.phone);
            const customerLines = [contactInfo.companyName, contactInfo.contactName, contactInfo.email, customerPhone].filter(Boolean);
            leftColumnY = renderBlock("Bill To", customerLines, leftColumnX, leftColumnY);

            const billingLines = buildAddressLines(contactInfo.billingAddress, contactInfo.billingCity, contactInfo.billingState, contactInfo.billingZipCode);
            if (billingLines.length) {
                rightColumnY = renderBlock("Billing Address", billingLines, rightColumnX, rightColumnY, 90);
            }

            const shippingLines = buildAddressLines(contactInfo.shippingAddress, contactInfo.shippingCity, contactInfo.shippingState, contactInfo.shippingZipCode);
            if (shippingLines.length) {
                rightColumnY = renderBlock("Shipping Address", shippingLines, rightColumnX, rightColumnY, 90);
            }

            let tableStartY = Math.max(leftColumnY, rightColumnY, topSectionBottom + 20) + 5;

            const safeLineItems = Array.isArray(safeOrder.lineItems) ? safeOrder.lineItems : [];
            const tableHead = ["Name", "Description", "Units", "Unit Price", "Total"];
            const tableBody = safeLineItems.map((item) => {
                const catalogItem = item?.catalogItemId ? safeItems[item.catalogItemId] : null;
                const displayName = (item?.name && item.name.trim()) || catalogItem?.name || 'Item';
                const description = (item?.description && item.description.trim()) || catalogItem?.description || '';
                const quantity = Number(item?.quantity) || 0;
                const unitPriceCents = Number(item?.price) || 0;
                const lineTotalCents = quantity * unitPriceCents;
                return [
                    displayName,
                    description || '—',
                    `${quantity}`,
                    `$${(unitPriceCents / 100).toFixed(2)}`,
                    `$${(lineTotalCents / 100).toFixed(2)}`
                ];
            });

            doc.autoTable({ head: [tableHead], body: tableBody, startY: tableStartY });

            const subtotalCents = safeLineItems.reduce((acc, item) => {
                const quantity = Number(item?.quantity) || 0;
                const unitPriceCents = Number(item?.price) || 0;
                return acc + (quantity * unitPriceCents);
            }, 0);
            const shippingCents = Math.max(0, Math.round(parseCurrencyToNumber(safeOrder.estimatedShipping) * 100));
            const taxCents = Math.max(0, Math.round(parseCurrencyToNumber(safeOrder.taxAmount) * 100));
            const normalizedDiscounts = normalizeDiscountsForTotals(safeOrder.discounts, safeLineItems);
            const discountTotalCents = Math.min(
                normalizedDiscounts.reduce((acc, discount) => acc + discount.amountCents, 0),
                subtotalCents
            );
            const subtotalAfterDiscounts = Math.max(0, subtotalCents - discountTotalCents);
            const totalCents = subtotalAfterDiscounts + shippingCents + taxCents;

            const tableResult = doc.lastAutoTable;
            let summaryY = (tableResult ? tableResult.finalY : tableStartY) + 10;

            doc.setFontSize(10);
            doc.text(`Subtotal: $${(subtotalCents / 100).toFixed(2)}`, 14, summaryY);
            summaryY += 7;

            if (taxCents > 0) {
                doc.text(`Taxes: $${(taxCents / 100).toFixed(2)}`, 14, summaryY);
                summaryY += 7;
            }

            if (shippingCents > 0) {
                doc.text(`Shipping: $${(shippingCents / 100).toFixed(2)}`, 14, summaryY);
                summaryY += 7;
            }

            if (discountTotalCents > 0) {
                doc.text(`Discounts: -$${(discountTotalCents / 100).toFixed(2)}`, 14, summaryY);
                summaryY += 7;
                normalizedDiscounts.forEach((discount) => {
                    const label = discount.label || 'Discount';
                    doc.text(`  ${label}: -$${(discount.amountCents / 100).toFixed(2)}`, 14, summaryY);
                    summaryY += 6;
                });
            }

            doc.setFontSize(12);
            doc.text(`Total: $${(totalCents / 100).toFixed(2)}`, 14, summaryY);
            summaryY += 10;

            doc.setFontSize(10);
            if (safeOrder.estimatedShippingDate) {
                doc.text(`Est. Ship Date: ${formatInTimeZone(safeOrder.estimatedShippingDate, timeZone, dateOptions)}`, 14, summaryY);
                summaryY += 5;
            }

            if (safeOrder.priorityLevel) {
                doc.text(`Priority: ${safeOrder.priorityLevel}`, 14, summaryY);
                summaryY += 5;
            }

            if (safeOrder.fulfillmentChannel) {
                doc.text(`Fulfillment: ${safeOrder.fulfillmentChannel}`, 14, summaryY);
                summaryY += 5;
            }

            if (safeOrder.customerReference) {
                doc.text(`Customer Reference: ${safeOrder.customerReference}`, 14, summaryY);
                summaryY += 5;
            }

            const trimmedNotes = (safeOrder.notes || '').trim();
            if (trimmedNotes) {
                summaryY += 5;
                doc.text("Notes:", 14, summaryY);
                summaryY += 5;
                const wrappedNotes = doc.splitTextToSize(trimmedNotes, 180);
                doc.text(wrappedNotes, 14, summaryY);
                summaryY += wrappedNotes.length * 4;
            }

            summaryY += 15;
            if (summaryY > 260) {
                doc.addPage();
                summaryY = 20;
            }

            doc.setFontSize(10);
            doc.text("Authorized Signature:", 14, summaryY);

            const signatureDataUrl = safeOrder.signatureDataUrl;
            if (signatureDataUrl) {
                try {
                    if (signatureDataUrl.startsWith('data:image')) {
                        const base64Data = signatureDataUrl.substring(signatureDataUrl.indexOf(',') + 1);
                        if (base64Data.length > 150) {
                            const signatureImgWidth = 70;
                            const signatureImgHeight = 20;
                            doc.addImage(signatureDataUrl, 'PNG', 50, summaryY - (signatureImgHeight / 2) + 2, signatureImgWidth, signatureImgHeight);
                        } else {
                            doc.line(50, summaryY, 120, summaryY);
                        }
                    } else {
                        doc.line(50, summaryY, 120, summaryY);
                    }
                } catch (error) {
                    console.error('Error rendering signature image for PDF:', error);
                    doc.line(50, summaryY, 120, summaryY);
                }
            } else {
                doc.line(50, summaryY, 120, summaryY);
            }

            let footerY = summaryY + 20;
            if (invoiceFooter) {
                if (footerY > 260) {
                    doc.addPage();
                    footerY = 20;
                }
                doc.setFontSize(9);
                const wrappedFooter = doc.splitTextToSize(invoiceFooter, 180);
                doc.text(wrappedFooter, 14, footerY);
                doc.setFontSize(10);
            }

            if (action === 'save') {
                doc.save(`Invoice_${orderId || 'Order'}.pdf`);
            } else if (action === 'datauristring') {
                return doc.output('datauristring');
            } else {
                doc.output('dataurlnewwindow');
            }
        };

        const ViewOrderPage = ({ orderId }) => {
            const { useState, useEffect } = React;
            const [order, setOrder] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [isLogModalOpen, setIsLogModalOpen] = useState(false);
            const [contacts, setContacts] = useState([]);
            const [itemsIndex, setItemsIndex] = useState({});
            const [branding, setBranding] = useState({});

            const fetchOrder = async () => {
                try {
                    const response = await fetch(`/api/orders/${orderId}`);
                    if (!response.ok) {
                        throw new Error('Order not found');
                    }
                    const data = await response.json();
                    const normalizedOrder = {
                        ...data,
                        lineItems: Array.isArray(data?.lineItems)
                            ? data.lineItems.map((item, index) => ({
                                id: item?.id ?? item?.line_item_id ?? index + 1,
                                catalogItemId: item?.catalogItemId ?? item?.catalog_item_id ?? null,
                                name: item?.name || '',
                                description: item?.description || '',
                                quantity: Number(item?.quantity) || 0,
                                price: Number(item?.price) || 0,
                                packageId: item?.packageId ?? item?.package_id ?? null,
                            }))
                            : [],
                    };
                    setOrder(normalizedOrder);
                } catch (error) {
                    console.error("Failed to fetch order:", error);
                } finally {
                    setIsLoading(false);
                }
            };

            useEffect(() => {
                fetchOrder();
            }, [orderId]);

            useEffect(() => {
                const fetchContactsAndItems = async () => {
                    try {
                        const [contactsRes, itemsRes] = await Promise.all([
                            fetch('/api/contacts'),
                            fetch('/api/items')
                        ]);
                        if (contactsRes.ok) {
                            const contactsData = await contactsRes.json();
                            setContacts(Array.isArray(contactsData) ? contactsData : []);
                        }
                        if (itemsRes.ok) {
                            const itemsData = await itemsRes.json();
                            const nextIndex = {};
                            if (Array.isArray(itemsData)) {
                                itemsData.forEach(item => {
                                    if (item && item.id) {
                                        nextIndex[item.id] = {
                                            ...item,
                                            name: item.name || '',
                                            description: item.description || '',
                                            price: typeof item.price === 'number' ? item.price : Number(item.price) || 0,
                                        };
                                    }
                                });
                            }
                            setItemsIndex(nextIndex);
                        }
                    } catch (error) {
                        console.error('Failed to fetch contacts or items:', error);
                    }
                };
                fetchContactsAndItems();
            }, []);

            useEffect(() => {
                const loadBranding = async () => {
                    try {
                        const response = await fetch('/api/settings');
                        if (response.ok) {
                            const settingsData = await response.json();
                            setBranding(settingsData);
                            window.fireCoastBranding = settingsData;
                        }
                    } catch (error) {
                        console.error('Failed to load settings for invoice branding:', error);
                    }
                };
                loadBranding();
            }, []);

            if (isLoading) {
                return <div className="text-center p-8">Loading order details...</div>;
            }

            if (!order) {
                return <div className="text-center p-8 text-red-500">Failed to load order. It may not exist.</div>;
            }

            const handleLogAdded = () => {
                fetchOrder();
            };

            const subtotalCents = (order.lineItems || []).reduce((acc, item) => {
                const quantity = Number(item.quantity) || 0;
                const price = Number(item.price) || 0;
                return acc + (quantity * price);
            }, 0);
            const shippingCents = Math.max(0, Math.round(parseCurrencyToNumber(order.estimatedShipping) * 100));
            const taxCents = Math.max(0, Math.round(parseCurrencyToNumber(order.taxAmount) * 100));
            const normalizedDiscounts = normalizeDiscountsForTotals(order.discounts, order.lineItems || []);
            const discountTotalCents = Math.min(
                normalizedDiscounts.reduce((acc, discount) => acc + discount.amountCents, 0),
                subtotalCents
            );
            const subtotalAfterDiscounts = Math.max(0, subtotalCents - discountTotalCents);
            const totalCents = subtotalAfterDiscounts + shippingCents + taxCents;
            const orderTotals = {
                subtotal: subtotalCents,
                shippingCents,
                taxCents,
                discounts: normalizedDiscounts,
                discountTotalCents,
                total: totalCents,
            };

            const orderTitle = order.title || order.display_id || order.id;
            const primaryContact = order.contactInfo || {};
            const contactDisplayName = getContactDisplayName(primaryContact);
            const companyName = sanitizePlaceholderValue(primaryContact.companyName);
            const showCompanyLine = Boolean(companyName && companyName !== contactDisplayName);
            const contactHandle = (primaryContact.handle || '').trim();
            const formattedPhone = formatPhoneNumber(primaryContact.phone);
            const formattedShipping = formatContactAddress(
                primaryContact.shippingAddress,
                primaryContact.shippingCity,
                primaryContact.shippingState,
                primaryContact.shippingZipCode
            );
            const formattedBilling = formatContactAddress(
                primaryContact.billingAddress,
                primaryContact.billingCity,
                primaryContact.billingState,
                primaryContact.billingZipCode
            );


            return (
                <div className="bg-slate-50 min-h-screen font-sans">
                <div className="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
                    <div className="mb-6 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                        <div>
                            <a href="/orders" className="text-orange-600 hover:text-orange-800 font-semibold">&larr; Back to Orders</a>
                            <h1 className="text-3xl font-bold text-slate-800 mt-2">View Order: {orderTitle}</h1>
                            <p className="text-sm text-slate-500 mt-1">Order ID: {order.id}</p>
                        </div>
                        <div className="flex flex-wrap gap-3">
                            <button
                                type="button"
                                onClick={() => generateInvoicePdf(order, itemsIndex, branding)}
                                className="px-4 py-2 bg-white text-slate-700 font-semibold rounded-md border border-slate-300 hover:bg-slate-100 transition-colors shadow-sm"
                            >
                                Preview Invoice
                            </button>
                            <a href={`/orders?order_id=${order.id}&mode=edit`} className="px-4 py-2 bg-orange-600 text-white font-semibold rounded-md hover:bg-orange-700 transition-colors shadow">Edit Order</a>
                        </div>
                    </div>

                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6">
                            <div className="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                                <div>
                                    <p className="text-xs font-semibold uppercase tracking-wide text-slate-500">Primary Contact</p>
                                    <h2 className="mt-1 text-2xl font-semibold text-slate-800">{contactDisplayName}</h2>
                                    {showCompanyLine && <p className="text-sm text-slate-500">{companyName}</p>}
                                    {contactHandle && (
                                        <div className="mt-3">
                                            <span className="inline-flex items-center rounded-full bg-orange-100 px-2.5 py-0.5 text-xs font-semibold text-orange-700">@{contactHandle}</span>
                                        </div>
                                    )}
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {primaryContact.id && (
                                        <a
                                            href={`/contacts?contact_id=${primaryContact.id}`}
                                            className="inline-flex items-center rounded-md border border-slate-300 px-3 py-1.5 text-sm font-semibold text-slate-700 hover:bg-slate-100"
                                        >
                                            View in Contacts
                                        </a>
                                    )}
                                </div>
                            </div>
                            <div className="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-slate-600">
                                <div>
                                    <p className="font-semibold text-slate-700">Email</p>
                                    <p>{primaryContact.email || 'Not provided'}</p>
                                </div>
                                <div>
                                    <p className="font-semibold text-slate-700">Phone</p>
                                    <p>{formattedPhone || 'Not provided'}</p>
                                </div>
                                <div>
                                    <p className="font-semibold text-slate-700">Shipping Address</p>
                                    <p>{formattedShipping}</p>
                                </div>
                                <div>
                                    <p className="font-semibold text-slate-700">Billing Address</p>
                                    <p>{formattedBilling}</p>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-lg shadow-sm border border-slate-200 mb-6">
                            <div className="flex justify-between items-center border-b pb-3 mb-4">
                                <h2 className="text-xl font-semibold text-slate-700">Order Logs</h2>
                                <button onClick={() => setIsLogModalOpen(true)} className="px-3 py-1 bg-orange-600 text-white font-semibold rounded-md hover:bg-orange-700 transition-colors shadow text-sm">Add Log</button>
                            </div>
                            {order.orderLogs && order.orderLogs.length > 0 ? (
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left text-slate-500">
                                        <thead className="text-xs text-slate-700 uppercase bg-slate-100">
                                            <tr>
                                                <th className="px-4 py-3">Timestamp</th>
                                                <th className="px-4 py-3">Action</th>
                                                <th className="px-4 py-3">Details</th>
                                                <th className="px-4 py-3">Attachment</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {order.orderLogs.map(log => (
                                                <tr key={log.log_id} className="bg-white border-b hover:bg-slate-50">
                                                    <td className="px-4 py-3 font-medium text-slate-800">{log.timestamp ? new Date(log.timestamp).toLocaleString() : '—'}</td>
                                                    <td className="px-4 py-3">{log.action || '—'}</td>
                                                    <td className="px-4 py-3 whitespace-pre-wrap">{log.details || log.note || ''}</td>
                                                    <td className="px-4 py-3">
                                                        {log.attachment_path ?
                                                            <a href={`/data/${log.attachment_path}`} target="_blank" className="text-orange-600 hover:underline">View File</a> : ''}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            ) : <p className="text-slate-500 italic">No logs for this order yet.</p>}
                        </div>

                        {isLogModalOpen && <AddLogModal orderId={order.id} onClose={() => setIsLogModalOpen(false)} onLogAdded={handleLogAdded} contacts={contacts} />}

                        <div className="bg-white rounded-lg shadow-sm border border-slate-200">
                            <div className="p-6 border-b"><h2 className="text-xl font-semibold text-slate-700">Line Items</h2></div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-slate-500">
                                    <thead className="text-xs text-slate-700 uppercase bg-slate-100">
                                        <tr>
                                            <th scope="col" className="px-4 py-3">Name</th>
                                            <th scope="col" className="px-4 py-3">Description</th>
                                            <th scope="col" className="px-4 py-3 text-center">Units</th>
                                            <th scope="col" className="px-4 py-3 text-right">Unit Price</th>
                                            <th scope="col" className="px-4 py-3 text-right">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {order.lineItems.map((item, index) => {
                                            const lookup = item.catalogItemId ? itemsIndex[item.catalogItemId] || {} : {};
                                            const displayName = (item.name && item.name.trim()) || lookup.name || 'Line Item';
                                            const description = (item.description && item.description.trim()) || lookup.description || '';
                                            const quantity = Number(item.quantity) || 0;
                                            const unitPriceCents = Number(item.price) || 0;
                                            const lineTotalCents = quantity * unitPriceCents;
                                            return (
                                                <tr key={index} className="border-b align-middle">
                                                    <td className="px-4 py-2">{displayName}</td>
                                                    <td className="px-4 py-2 text-slate-600">{description || <span className="text-slate-400">No description</span>}</td>
                                                    <td className="px-4 py-2 text-center">{quantity}</td>
                                                    <td className="px-4 py-2 text-right">${(unitPriceCents / 100).toFixed(2)}</td>
                                                    <td className="px-4 py-2 text-right font-medium text-slate-800">${(lineTotalCents / 100).toFixed(2)}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                            <div className="space-y-6">
                                <div className="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                                     <h2 className="text-xl font-semibold text-slate-700 border-b pb-3 mb-4">Order Metadata</h2>
                                    <div className="space-y-4">
                                        <div><p className="text-sm font-medium text-slate-500">Est. Shipping Date</p><p>{order.estimatedShippingDate ? formatInTimeZone(order.estimatedShippingDate, "America/Chicago", { year: 'numeric', month: 'long', day: 'numeric' }) : 'Not set'}</p></div>
                                        <div><p className="text-sm font-medium text-slate-500">Priority Level</p><p>{order.priorityLevel || 'Not set'}</p></div>
                                        <div><p className="text-sm font-medium text-slate-500">Fulfillment Channel</p><p>{order.fulfillmentChannel || 'Not specified'}</p></div>
                                        <div><p className="text-sm font-medium text-slate-500">Customer Reference</p><p>{order.customerReference || '—'}</p></div>
                                    </div>
                                </div>
                                <div className="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                                    <h2 className="text-xl font-semibold text-slate-700 mb-3">Notes</h2>
                                    <p className="text-slate-600 whitespace-pre-wrap">{order.notes || 'No notes for this order.'}</p>
                                </div>
                            </div>
                            <div className="space-y-6">
                                 <div className="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                                    <h2 className="text-xl font-semibold text-slate-700 mb-3">Signature</h2>
                                    {order.signatureDataUrl ? <img src={order.signatureDataUrl} alt="Signature" className="max-w-full h-auto border rounded"/> : <p>No signature provided.</p>}
                                </div>
                                <div className="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                                    <div className="border-b border-slate-200 pb-3">
                                        <h2 className="text-xl font-semibold text-slate-700">Order Summary</h2>
                                    </div>
                                    <div className="mt-4 ml-auto max-w-xs space-y-2 text-right text-sm text-slate-600">
                                        <div className="flex justify-between gap-4">
                                            <span>Subtotal</span>
                                            <span className="font-medium text-slate-700">${centsToCurrency(orderTotals.subtotal)}</span>
                                        </div>
                                        <div className="flex justify-between gap-4">
                                            <span>Taxes</span>
                                            <span className="font-medium text-slate-700">${centsToCurrency(orderTotals.taxCents)}</span>
                                        </div>
                                        <div className="flex justify-between gap-4">
                                            <span>Shipping</span>
                                            <span className="font-medium text-slate-700">${centsToCurrency(orderTotals.shippingCents)}</span>
                                        </div>
                                        <div className={`flex justify-between gap-4 ${orderTotals.discountTotalCents > 0 ? 'text-rose-600' : 'text-slate-600'}`}>
                                            <span>Discounts</span>
                                            <span className="font-medium">{orderTotals.discountTotalCents > 0 ? '-' : ''}${centsToCurrency(orderTotals.discountTotalCents)}</span>
                                        </div>
                                        {orderTotals.discounts.length > 0 && (
                                            <div className="space-y-1 text-xs text-rose-500">
                                                {orderTotals.discounts.map(discount => (
                                                    <div key={discount.id} className="flex justify-between gap-3">
                                                        <span className="truncate">{discount.label || 'Discount'}</span>
                                                        <span>- ${centsToCurrency(discount.amountCents)}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                        <div className="flex justify-between items-center gap-4 border-t border-slate-200 pt-2 text-lg font-semibold text-slate-800">
                                            <span>Total</span>
                                            <span>${centsToCurrency(orderTotals.total)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const container = document.getElementById('root');
        const orderId = container.dataset.orderId;
        const root = ReactDOM.createRoot(container);
        root.render(<ViewOrderPage orderId={orderId} />);
    </script>
    {% endraw %}
</body>
</html>
