<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    {% include 'partials/navbar.html' %}
    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12 space-y-12">
        <header class="space-y-3">
            <p class="text-sm uppercase tracking-[0.3em] text-slate-500">Performance Insights</p>
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-800">Analytics Overview</h1>
            <p class="text-slate-600 max-w-3xl">Stay on top of the health of your order pipeline. Review revenue, volume, and order value trends in one place to inform your next operational decisions.</p>
        </header>
        <section>
            <div id="analytics-root"></div>
        </section>
    </main>
    {% raw %}
    <script type="text/babel">
const { useEffect, useState, useMemo, useCallback } = React;

const formatValue = (value, formatHint) => {
    if (value === undefined || value === null || value === '') {
        return '—';
    }
    if (Array.isArray(value)) {
        return value.length ? value.join(', ') : '—';
    }
    if (formatHint === 'currency') {
        try {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(Number(value));
        } catch (error) {
            return `$${Number(value || 0).toFixed(2)}`;
        }
    }
    if (formatHint === 'number') {
        try {
            return new Intl.NumberFormat('en-US').format(Number(value));
        } catch (error) {
            return `${value}`;
        }
    }
    if (formatHint === 'duration') {
        const totalSeconds = Math.max(0, Math.round(Number(value) || 0));
        if (totalSeconds < 60) {
            return `${totalSeconds}s`;
        }
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        if (minutes < 60) {
            return `${minutes}m ${seconds}s`;
        }
        const hours = Math.floor(minutes / 60);
        const remainingMinutes = minutes % 60;
        if (hours < 24) {
            return `${hours}h ${remainingMinutes}m`;
        }
        const days = Math.floor(hours / 24);
        const remainingHours = hours % 24;
        return `${days}d ${remainingHours}h`;
    }
    if (typeof value === 'string' && /\d{4}-\d{2}-\d{2}/.test(value)) {
        const parsed = new Date(value);
        if (!Number.isNaN(parsed.getTime())) {
            return parsed.toLocaleString();
        }
    }
    return `${value}`;
};

const SummaryCard = ({ entry }) => {
    return (
        <div className="bg-white border border-slate-200 rounded-xl shadow-sm p-6">
            <p className="text-sm font-medium text-slate-500">{entry.label}</p>
            <p className="mt-2 text-3xl font-semibold text-slate-800">{entry.display || formatValue(entry.value, entry.format)}</p>
            {entry.description && <p className="mt-2 text-xs text-slate-500">{entry.description}</p>}
        </div>
    );
};

const SummaryGrid = ({ summary }) => {
    if (!summary || summary.length === 0) {
        return null;
    }
    return (
        <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
            {summary.map((entry) => (
                <SummaryCard key={entry.id || entry.label} entry={entry} />
            ))}
        </div>
    );
};

const ReportMetaChips = ({ meta }) => {
    const applied = meta?.appliedParameters || {};
    const filters = Object.entries(applied).filter(([_, value]) => !(value === null || value === '' || (Array.isArray(value) && value.length === 0)));
    if (!filters.length) {
        return null;
    }
    return (
        <div className="flex flex-wrap gap-2 text-xs text-slate-600">
            {filters.map(([key, value]) => (
                <span key={key} className="bg-slate-100 border border-slate-200 px-3 py-1 rounded-full">
                    <span className="font-semibold mr-1 uppercase tracking-wide">{key.replace(/_/g, ' ')}</span>
                    <span>{formatValue(value, Array.isArray(value) ? 'text' : undefined)}</span>
                </span>
            ))}
        </div>
    );
};

const ReportChart = ({ chart, onRegister }) => {
    const canvasRef = React.useRef(null);
    const chartRef = React.useRef(null);

    React.useEffect(() => {
        if (!window.Chart || !canvasRef.current) {
            return undefined;
        }
        const { type = 'line', labels = [], datasets = [], options = {} } = chart;
        const ctx = canvasRef.current.getContext('2d');
        if (chartRef.current) {
            chartRef.current.destroy();
        }
        const chartConfig = {
            type,
            data: {
                labels,
                datasets: datasets.map((dataset) => ({
                    fill: dataset.fill ?? false,
                    tension: dataset.tension ?? 0.25,
                    ...dataset,
                })),
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: { mode: 'index', intersect: false },
                },
                ...options,
            },
        };
        chartRef.current = new window.Chart(ctx, chartConfig);
        let unregister;
        if (onRegister) {
            unregister = onRegister(chart.id, () => chartRef.current);
        }
        return () => {
            if (chartRef.current) {
                chartRef.current.destroy();
                chartRef.current = null;
            }
            if (unregister) {
                unregister();
            }
        };
    }, [chart, onRegister]);

    return (
        <div className="bg-white border border-slate-200 rounded-xl shadow-sm p-6">
            <div className="flex items-center justify-between mb-4">
                <div>
                    <h3 className="text-lg font-semibold text-slate-800">{chart.title}</h3>
                    {chart.subtitle && <p className="text-xs text-slate-500 mt-1">{chart.subtitle}</p>}
                </div>
                {chart.description && <p className="text-xs text-slate-500 max-w-xs text-right">{chart.description}</p>}
            </div>
            <div className="h-80">
                <canvas ref={canvasRef} role="img" aria-label={chart.title}></canvas>
            </div>
        </div>
    );
};

const ReportTable = ({ table }) => {
    if (!table || !table.rows || table.rows.length === 0) {
        return null;
    }
    const columns = table.columns || [];
    const rows = table.rows;
    return (
        <div className="bg-white border border-slate-200 rounded-xl shadow-sm">
            <div className="px-6 py-4 border-b border-slate-200">
                <h3 className="text-lg font-semibold text-slate-800">{table.title}</h3>
                {table.subtitle && <p className="text-xs text-slate-500 mt-1">{table.subtitle}</p>}
            </div>
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-slate-200">
                    <thead className="bg-slate-50">
                        <tr>
                            {columns.map((column) => (
                                <th key={column.key} scope="col" className="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">
                                    {column.label}
                                </th>
                            ))}
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100 bg-white">
                        {rows.map((row, index) => (
                            <tr key={row.id || index} className="hover:bg-slate-50">
                                {columns.map((column) => (
                                    <td key={column.key} className="px-4 py-3 text-sm text-slate-700">
                                        {formatValue(row[column.key], column.format)}
                                    </td>
                                ))}
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

const ReportParameterInput = ({ parameter, value, onChange }) => {
    const id = `param-${parameter.name}`;
    const sharedClasses = 'mt-1 block w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 focus:border-orange-400 focus:ring-2 focus:ring-orange-200';

    const handleSelectChange = (event) => {
        const { options } = event.target;
        const selected = [];
        for (let index = 0; index < options.length; index += 1) {
            if (options[index].selected) {
                selected.push(options[index].value);
            }
        }
        onChange(selected);
    };

    if (parameter.type === 'date') {
        return (
            <div>
                <label htmlFor={id} className="text-xs font-semibold uppercase tracking-wide text-slate-500">
                    {parameter.label}
                </label>
                <input
                    id={id}
                    type="date"
                    value={value || ''}
                    onChange={(event) => onChange(event.target.value)}
                    className={sharedClasses}
                />
                {parameter.description && <p className="mt-1 text-xs text-slate-500">{parameter.description}</p>}
            </div>
        );
    }

    if (parameter.type === 'enum') {
        return (
            <div>
                <label htmlFor={id} className="text-xs font-semibold uppercase tracking-wide text-slate-500">
                    {parameter.label}
                </label>
                <select
                    id={id}
                    value={value ?? (parameter.options?.[0]?.value ?? '')}
                    onChange={(event) => onChange(event.target.value)}
                    className={sharedClasses}
                >
                    {(parameter.options || []).map((option) => (
                        <option key={option.value} value={option.value}>{option.label}</option>
                    ))}
                </select>
                {parameter.description && <p className="mt-1 text-xs text-slate-500">{parameter.description}</p>}
            </div>
        );
    }

    if (parameter.type === 'multi_enum' || parameter.multiple) {
        return (
            <div>
                <label htmlFor={id} className="text-xs font-semibold uppercase tracking-wide text-slate-500">
                    {parameter.label}
                </label>
                <select
                    id={id}
                    multiple
                    value={Array.isArray(value) ? value : []}
                    onChange={handleSelectChange}
                    className={`${sharedClasses} min-h-[120px]`}
                >
                    {(parameter.options || []).map((option) => (
                        <option key={option.value} value={option.value}>{option.label}</option>
                    ))}
                </select>
                {parameter.description && <p className="mt-1 text-xs text-slate-500">{parameter.description}</p>}
            </div>
        );
    }

    if (parameter.type === 'integer' || parameter.type === 'number') {
        return (
            <div>
                <label htmlFor={id} className="text-xs font-semibold uppercase tracking-wide text-slate-500">
                    {parameter.label}
                </label>
                <input
                    id={id}
                    type="number"
                    value={value ?? (parameter.default ?? '')}
                    onChange={(event) => onChange(event.target.value === '' ? '' : Number(event.target.value))}
                    className={sharedClasses}
                />
                {parameter.description && <p className="mt-1 text-xs text-slate-500">{parameter.description}</p>}
            </div>
        );
    }

    if (parameter.type === 'boolean') {
        return (
            <div className="flex items-center gap-3 border border-slate-200 rounded-lg px-4 py-3">
                <input
                    id={id}
                    type="checkbox"
                    className="h-4 w-4 text-orange-500 focus:ring-orange-400"
                    checked={Boolean(value)}
                    onChange={(event) => onChange(event.target.checked)}
                />
                <div>
                    <label htmlFor={id} className="text-sm font-semibold text-slate-700">{parameter.label}</label>
                    {parameter.description && <p className="text-xs text-slate-500">{parameter.description}</p>}
                </div>
            </div>
        );
    }

    return (
        <div>
            <label htmlFor={id} className="text-xs font-semibold uppercase tracking-wide text-slate-500">
                {parameter.label}
            </label>
            <input
                id={id}
                type="text"
                value={value ?? ''}
                placeholder={parameter.placeholder || ''}
                onChange={(event) => onChange(event.target.value)}
                className={sharedClasses}
            />
            {parameter.description && <p className="mt-1 text-xs text-slate-500">{parameter.description}</p>}
        </div>
    );
};

const ReportParameterForm = ({ definition, values, onChange, onSubmit, isRunning }) => {
    if (!definition.parameters.length) {
        return null;
    }
    return (
        <form
            onSubmit={(event) => {
                event.preventDefault();
                onSubmit();
            }}
            className="bg-slate-50 border border-slate-200 rounded-xl p-4 space-y-4"
        >
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {definition.parameters.map((parameter) => (
                    <ReportParameterInput
                        key={parameter.name}
                        parameter={parameter}
                        value={values[parameter.name]}
                        onChange={(nextValue) => onChange(parameter.name, nextValue)}
                    />
                ))}
            </div>
            <div className="flex items-center justify-end gap-3">
                <button
                    type="submit"
                    className="inline-flex items-center rounded-lg bg-orange-500 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-300 disabled:cursor-not-allowed disabled:opacity-60"
                    disabled={isRunning}
                >
                    {isRunning ? 'Running…' : 'Run Report'}
                </button>
            </div>
        </form>
    );
};

const exportReportToPdf = (report, chartRefs) => {
    if (!window.jspdf || !window.jspdf.jsPDF) {
        alert('PDF export is not available in this browser.');
        return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'letter' });
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    let cursorY = 72;

    const ensureSpace = (required) => {
        if (cursorY + required > pageHeight - 60) {
            doc.addPage();
            cursorY = 60;
        }
    };

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(18);
    doc.text(report.name || 'Analytics Report', 60, cursorY);
    cursorY += 18;
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Generated ${new Date(report.generatedAt || Date.now()).toLocaleString()}`, 60, cursorY);
    cursorY += 24;

    if (report.summary && report.summary.length) {
        const tableRows = report.summary.map((entry) => [entry.label, entry.display || formatValue(entry.value, entry.format)]);
        doc.autoTable({
            startY: cursorY,
            head: [['Metric', 'Value']],
            body: tableRows,
            theme: 'grid',
            styles: { fontSize: 9, cellPadding: 4 },
            headStyles: { fillColor: [249, 115, 22] },
        });
        cursorY = doc.lastAutoTable.finalY + 20;
    }

    if (report.notes && report.notes.length) {
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(12);
        doc.text('Notes', 60, cursorY);
        cursorY += 14;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
        report.notes.forEach((note) => {
            const lines = doc.splitTextToSize(`• ${note}`, pageWidth - 120);
            ensureSpace(lines.length * 12 + 10);
            doc.text(lines, 60, cursorY);
            cursorY += lines.length * 12 + 6;
        });
        cursorY += 10;
    }

    if (report.charts && report.charts.length) {
        report.charts.forEach((chart) => {
            const getter = chartRefs.get(chart.id);
            if (!getter) {
                return;
            }
            const instance = getter();
            if (!instance) {
                return;
            }
            const imageData = instance.toBase64Image();
            const canvas = instance.canvas;
            const aspectRatio = canvas.height / canvas.width;
            const imageWidth = pageWidth - 120;
            const imageHeight = imageWidth * aspectRatio;
            ensureSpace(imageHeight + 40);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(chart.title || 'Chart', 60, cursorY);
            cursorY += 16;
            doc.addImage(imageData, 'PNG', 60, cursorY, imageWidth, imageHeight);
            cursorY += imageHeight + 20;
        });
    }

    if (report.tables && report.tables.length) {
        report.tables.forEach((table) => {
            const columns = table.columns || [];
            const body = (table.rows || []).map((row) => columns.map((column) => formatValue(row[column.key], column.format)));
            if (!columns.length || !body.length) {
                return;
            }
            doc.autoTable({
                startY: cursorY,
                head: [columns.map((column) => column.label)],
                body,
                styles: { fontSize: 9, cellPadding: 3 },
                headStyles: { fillColor: [15, 23, 42], textColor: 255 },
            });
            cursorY = doc.lastAutoTable.finalY + 24;
        });
    }

    doc.save(`${report.id || 'analytics_report'}_${new Date().toISOString().slice(0, 10)}.pdf`);
};

const ReportSection = ({ instance, onChangeParameter, onRunReport, onRemoveReport }) => {
    const chartRefs = React.useRef(new Map());

    const registerChart = useCallback((chartId, getter) => {
        chartRefs.current.set(chartId, getter);
        return () => chartRefs.current.delete(chartId);
    }, []);

    const handleExport = () => {
        if (!instance.result) {
            return;
        }
        exportReportToPdf(instance.result, chartRefs.current);
    };

    return (
        <section className="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
            <div className="flex flex-col gap-4 border-b border-slate-200 bg-slate-900/90 px-6 py-5 text-white md:flex-row md:items-center md:justify-between">
                <div>
                    <h2 className="text-xl font-semibold tracking-tight">{instance.definition.name}</h2>
                    <p className="mt-1 text-sm text-slate-200 max-w-2xl">{instance.definition.description}</p>
                </div>
                <div className="flex flex-wrap gap-2">
                    <button
                        type="button"
                        onClick={() => onRunReport(instance.id)}
                        className="inline-flex items-center rounded-full border border-white/30 px-4 py-1.5 text-sm font-medium text-white transition hover:bg-white/10 disabled:cursor-not-allowed disabled:opacity-60"
                        disabled={instance.status === 'loading'}
                    >
                        Refresh
                    </button>
                    <button
                        type="button"
                        onClick={handleExport}
                        className="inline-flex items-center rounded-full border border-white/30 px-4 py-1.5 text-sm font-medium text-white transition hover:bg-white/10 disabled:cursor-not-allowed disabled:opacity-60"
                        disabled={!instance.result || instance.status === 'loading'}
                    >
                        Export PDF
                    </button>
                    <button
                        type="button"
                        onClick={() => onRemoveReport(instance.id)}
                        className="inline-flex items-center rounded-full border border-white/30 px-4 py-1.5 text-sm font-medium text-white transition hover:bg-white/10"
                    >
                        Remove
                    </button>
                </div>
            </div>
            <div className="p-6 space-y-6 bg-slate-50">
                <ReportParameterForm
                    definition={instance.definition}
                    values={instance.draftParams}
                    onChange={(name, value) => onChangeParameter(instance.id, name, value)}
                    onSubmit={() => onRunReport(instance.id)}
                    isRunning={instance.status === 'loading'}
                />
                <div className="space-y-6">
                    {instance.status === 'loading' && (
                        <div className="flex items-center justify-center rounded-xl border border-dashed border-slate-300 bg-white py-16 text-slate-500">
                            <span className="animate-pulse">Running analytics…</span>
                        </div>
                    )}
                    {instance.status === 'error' && (
                        <div className="rounded-xl border border-red-200 bg-red-50 p-6 text-red-700">
                            <p className="font-semibold">{instance.error || 'Unable to generate report.'}</p>
                            <p className="mt-1 text-sm">Please adjust filters or try again.</p>
                        </div>
                    )}
                    {instance.status === 'idle' && !instance.result && (
                        <div className="rounded-xl border border-slate-200 bg-white p-6 text-slate-600">
                            Configure parameters above and run the report to generate insights.
                        </div>
                    )}
                    {instance.result && instance.status !== 'loading' && (
                        <div className="space-y-6">
                            <SummaryGrid summary={instance.result.summary} />
                            <ReportMetaChips meta={instance.result.meta} />
                            {instance.result.dataSources && instance.result.dataSources.length > 0 && (
                                <div className="flex flex-wrap gap-2 text-xs text-slate-500">
                                    <span className="font-semibold uppercase tracking-wide text-slate-600">Data Sources:</span>
                                    {instance.result.dataSources.map((source) => (
                                        <span key={source} className="rounded-full border border-slate-200 bg-white px-3 py-1">{source}</span>
                                    ))}
                                </div>
                            )}
                            {(instance.result.charts || []).map((chart) => (
                                <ReportChart key={chart.id || chart.title} chart={chart} onRegister={registerChart} />
                            ))}
                            {(instance.result.tables || []).map((table) => (
                                <ReportTable key={table.id || table.title} table={table} />
                            ))}
                            {instance.result.notes && instance.result.notes.length > 0 && (
                                <div className="rounded-xl border border-slate-200 bg-white p-6">
                                    <h3 className="text-sm font-semibold uppercase tracking-wide text-slate-500">Insights</h3>
                                    <ul className="mt-3 list-disc space-y-2 pl-5 text-sm text-slate-600">
                                        {instance.result.notes.map((note, index) => (
                                            <li key={index}>{note}</li>
                                        ))}
                                    </ul>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            </div>
        </section>
    );
};

const ReportLibrary = ({ definitions, onAddReport }) => {
    return (
        <div className="space-y-4">
            <div>
                <h2 className="text-lg font-semibold text-slate-800">Report Library</h2>
                <p className="text-sm text-slate-500">Browse available analytics modules and add them to your workspace.</p>
            </div>
            <div className="space-y-3">
                {definitions.map((definition) => (
                    <div key={definition.id} className="border border-slate-200 bg-white rounded-xl p-4 shadow-sm">
                        <div className="flex items-start justify-between gap-4">
                            <div>
                                <h3 className="text-sm font-semibold text-slate-800">{definition.name}</h3>
                                <p className="mt-1 text-xs text-slate-500">{definition.description}</p>
                            </div>
                            <button
                                type="button"
                                onClick={() => onAddReport(definition)}
                                className="inline-flex items-center rounded-full bg-orange-500 px-3 py-1 text-xs font-semibold text-white shadow-sm transition hover:bg-orange-600"
                            >
                                Add
                            </button>
                        </div>
                        {definition.tags && definition.tags.length > 0 && (
                            <div className="mt-3 flex flex-wrap gap-2 text-[11px] uppercase tracking-wide text-slate-400">
                                {definition.tags.map((tag) => (
                                    <span key={tag} className="rounded-full border border-slate-200 px-2 py-0.5">{tag}</span>
                                ))}
                            </div>
                        )}
                    </div>
                ))}
            </div>
        </div>
    );
};

const buildInitialParams = (definition) => {
    const initial = {};
    definition.parameters.forEach((parameter) => {
        if (parameter.type === 'multi_enum' || parameter.multiple) {
            initial[parameter.name] = Array.isArray(parameter.default) ? parameter.default : [];
        } else if (parameter.type === 'boolean') {
            initial[parameter.name] = Boolean(parameter.default);
        } else if (parameter.default !== undefined && parameter.default !== null) {
            initial[parameter.name] = parameter.default;
        } else {
            initial[parameter.name] = '';
        }
    });
    return initial;
};

const sanitiseParamsForRequest = (definition, params) => {
    const payload = {};
    definition.parameters.forEach((parameter) => {
        const rawValue = params[parameter.name];
        if (rawValue === undefined || rawValue === null || rawValue === '') {
            if (parameter.type === 'boolean') {
                payload[parameter.name] = false;
            }
            return;
        }
        if (parameter.type === 'integer' || parameter.type === 'number') {
            payload[parameter.name] = Number(rawValue);
        } else if (parameter.type === 'boolean') {
            payload[parameter.name] = Boolean(rawValue);
        } else if (parameter.type === 'multi_enum' || parameter.multiple) {
            payload[parameter.name] = Array.isArray(rawValue) ? rawValue : [rawValue];
        } else {
            payload[parameter.name] = rawValue;
        }
    });
    return payload;
};

const AnalyticsApp = () => {
    const [definitions, setDefinitions] = useState([]);
    const [catalogLoading, setCatalogLoading] = useState(true);
    const [catalogError, setCatalogError] = useState(null);
    const [reports, setReports] = useState([]);

    useEffect(() => {
        const loadDefinitions = async () => {
            setCatalogLoading(true);
            setCatalogError(null);
            try {
                const response = await fetch('/api/analytics/reports');
                if (!response.ok) {
                    const result = await response.json().catch(() => ({}));
                    throw new Error(result.message || 'Failed to load analytics definitions.');
                }
                const result = await response.json();
                const fetched = Array.isArray(result.reports) ? result.reports : [];
                setDefinitions(fetched);
            } catch (error) {
                console.error('Failed to load analytics definitions', error);
                setCatalogError(error.message || 'Failed to load analytics definitions.');
            } finally {
                setCatalogLoading(false);
            }
        };
        loadDefinitions();
    }, []);

    useEffect(() => {
        if (!catalogLoading && !catalogError && definitions.length && reports.length === 0) {
            const preferred = definitions.filter((definition) => ['orders_overview', 'line_item_performance', 'customer_performance'].includes(definition.id));
            const seeds = preferred.length ? preferred : definitions.slice(0, 2);
            seeds.forEach((definition) => addReport(definition));
        }
        // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [catalogLoading, catalogError, definitions.length]);

    const addReport = useCallback((definition) => {
        const instanceId = `report-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
        const defaults = buildInitialParams(definition);
        setReports((previous) => [
            ...previous,
            {
                id: instanceId,
                definition,
                draftParams: { ...defaults },
                params: { ...defaults },
                status: 'loading',
                result: null,
                error: null,
            },
        ]);
        setTimeout(() => runReport(instanceId, definition, defaults));
    }, []);

    const updateReportState = (instanceId, updater) => {
        setReports((previous) => previous.map((instance) => (instance.id === instanceId ? updater(instance) : instance)));
    };

    const runReport = useCallback((instanceId, definitionOverride, paramsOverride) => {
        const instance = reports.find((entry) => entry.id === instanceId);
        const definition = definitionOverride || instance?.definition;
        const params = paramsOverride || instance?.draftParams;
        if (!definition || !params) {
            return;
        }
        const payload = sanitiseParamsForRequest(definition, params);
        updateReportState(instanceId, (current) => ({ ...current, status: 'loading', error: null }));
        fetch('/api/analytics/reports/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reportId: definition.id, params: payload }),
        })
            .then(async (response) => {
                if (!response.ok) {
                    const result = await response.json().catch(() => ({}));
                    throw new Error(result.message || 'Failed to generate report.');
                }
                return response.json();
            })
            .then((result) => {
                updateReportState(instanceId, (current) => ({
                    ...current,
                    status: 'ready',
                    params: JSON.parse(JSON.stringify(params)),
                    draftParams: { ...current.draftParams },
                    result: result.report,
                    error: null,
                }));
            })
            .catch((error) => {
                console.error('Failed to run analytics report', error);
                updateReportState(instanceId, (current) => ({
                    ...current,
                    status: 'error',
                    error: error.message || 'Failed to generate report.',
                }));
            });
    }, [reports]);

    const handleChangeParameter = useCallback((instanceId, name, value) => {
        updateReportState(instanceId, (current) => ({
            ...current,
            draftParams: { ...current.draftParams, [name]: value },
        }));
    }, []);

    const handleRunReport = useCallback((instanceId) => {
        const instance = reports.find((entry) => entry.id === instanceId);
        if (!instance) {
            return;
        }
        runReport(instanceId, instance.definition, instance.draftParams);
    }, [reports, runReport]);

    const handleRemoveReport = useCallback((instanceId) => {
        setReports((previous) => previous.filter((instance) => instance.id !== instanceId));
    }, []);

    const activeReports = useMemo(() => reports, [reports]);

    if (catalogLoading) {
        return <div className="text-slate-600">Loading analytics workspace…</div>;
    }

    if (catalogError) {
        return (
            <div className="rounded-xl border border-red-200 bg-red-50 p-6 text-red-700">
                <p className="font-semibold">{catalogError}</p>
                <p className="mt-1 text-sm">Refresh to try again or check the application logs.</p>
            </div>
        );
    }

    return (
        <div className="grid grid-cols-1 gap-8 lg:grid-cols-4">
            <aside className="lg:col-span-1 space-y-6">
                <ReportLibrary definitions={definitions} onAddReport={addReport} />
            </aside>
            <section className="lg:col-span-3 space-y-8">
                {activeReports.length === 0 && (
                    <div className="rounded-2xl border border-dashed border-slate-300 bg-white p-10 text-center text-slate-600">
                        <p className="text-lg font-semibold">Add a report to start exploring analytics.</p>
                        <p className="mt-2 text-sm">Use the report library to bring insights into your workspace.</p>
                    </div>
                )}
                {activeReports.map((instance) => (
                    <ReportSection
                        key={instance.id}
                        instance={instance}
                        onChangeParameter={handleChangeParameter}
                        onRunReport={handleRunReport}
                        onRemoveReport={handleRemoveReport}
                    />
                ))}
            </section>
        </div>
    );
};

const container = document.getElementById('analytics-root');
const root = ReactDOM.createRoot(container);
root.render(<AnalyticsApp />);
    </script>
    {% endraw %}
</body>
</html>
