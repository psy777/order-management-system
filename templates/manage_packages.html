<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Packages - FireNotes OMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/assets/css/styles.css">
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    {% include 'partials/navbar.html' %}

    <main class="page-main page-main--wide space-y-10">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="mb-6 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-slate-500"><a href="/settings" class="text-orange-600 hover:text-orange-700">&larr; Back to Settings</a></p>
                    <h1 class="text-2xl font-semibold text-slate-800 mt-1">Manage Packages</h1>
                    <p class="text-sm text-slate-500 mt-1">Packages bundle catalog items together so you can quickly add them to orders.</p>
                </div>
                <button id="addPackageButton" class="inline-flex items-center rounded-md bg-orange-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2">
                    + New Package
                </button>
            </div>

            <div class="bg-white shadow-sm border border-slate-200 rounded-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-100">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">Package</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">Package ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">Contents</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wide text-slate-500">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="packagesTable" class="divide-y divide-slate-200 bg-white"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="packageModal" class="fixed inset-0 z-40 hidden">
        <div class="absolute inset-0 bg-black/40" aria-hidden="true"></div>
        <div class="absolute inset-0 flex items-center justify-center px-4">
            <div class="w-full max-w-2xl rounded-lg bg-white shadow-xl">
                <div class="flex items-center justify-between border-b border-slate-200 px-6 py-4">
                    <h2 id="packageModalTitle" class="text-lg font-semibold text-slate-800">New Package</h2>
                    <button id="closeModalButton" class="text-slate-400 hover:text-slate-600 text-xl leading-none">&times;</button>
                </div>
                <form id="packageForm" class="px-6 py-5 space-y-4">
                    <input type="hidden" id="originalPackageId">
                    <div>
                        <label for="packageName" class="block text-sm font-medium text-slate-700">Name</label>
                        <input type="text" id="packageName" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500" required>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="packageId" class="block text-sm font-medium text-slate-700">Package ID</label>
                            <input type="number" id="packageId" min="0" step="1" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500" required>
                            <p class="mt-1 text-xs text-slate-400">Use the same ID you scan when adding packages to orders.</p>
                        </div>
                        <div>
                            <label for="packageContents" class="block text-sm font-medium text-slate-700">Contents</label>
                            <textarea id="packageContents" rows="6" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500" placeholder="Example:
ITEM-ID-123:2
Holiday Candle:1"></textarea>
                            <p class="mt-1 text-xs text-slate-400">One item per line using <span class="font-semibold">item identifier:quantity</span>. Identifiers can be item IDs or exact item names.</p>
                        </div>
                    </div>
                </form>
                <div class="flex items-center justify-between border-t border-slate-200 px-6 py-4">
                    <div id="packageMeta" class="text-xs text-slate-400"></div>
                    <div class="space-x-2">
                        <button id="cancelPackageButton" class="rounded-md border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100">Cancel</button>
                        <button id="savePackageButton" class="rounded-md bg-orange-600 px-4 py-2 text-sm font-semibold text-white hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2">Save Package</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const packagesTable = document.getElementById('packagesTable');
        const packageModal = document.getElementById('packageModal');
        const packageForm = document.getElementById('packageForm');
        const packageModalTitle = document.getElementById('packageModalTitle');
        const packageMeta = document.getElementById('packageMeta');

        const packageNameInput = document.getElementById('packageName');
        const packageIdInput = document.getElementById('packageId');
        const packageContentsInput = document.getElementById('packageContents');
        const originalPackageIdInput = document.getElementById('originalPackageId');

        const addPackageButton = document.getElementById('addPackageButton');
        const closeModalButton = document.getElementById('closeModalButton');
        const cancelPackageButton = document.getElementById('cancelPackageButton');
        const savePackageButton = document.getElementById('savePackageButton');

        let packagesCache = {};

        const showModal = () => { packageModal.classList.remove('hidden'); };
        const hideModal = () => { packageModal.classList.add('hidden'); };

        const escapeHtml = (value = '') => String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');

        const resetForm = () => {
            packageForm.reset();
            originalPackageIdInput.value = '';
            packageMeta.textContent = '';
        };

        const formatContentsSummary = (pkg) => {
            if (!pkg.contents || pkg.contents.length === 0) {
                return '<span class="text-slate-400">No items</span>';
            }
            return pkg.contents.map(entry => {
                const label = entry.name ? entry.name : entry.itemId;
                return `${escapeHtml(label)} <span class=\"text-slate-400\">(x${entry.quantity})</span>`;
            }).join('<br>');
        };

        const renderPackages = (packages) => {
            packagesTable.innerHTML = '';
            if (!packages || packages.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="4" class="px-6 py-6 text-center text-sm text-slate-500">No packages yet. Create one to get started.</td>`;
                packagesTable.appendChild(emptyRow);
                return;
            }

            packages.forEach(pkg => {
                const row = document.createElement('tr');
                row.className = 'align-top';
                const displayId = pkg.packageId ?? pkg.id_val;
                const safeIdAttr = escapeHtml(displayId);
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="text-sm font-medium text-slate-800">${escapeHtml(pkg.name || 'Untitled Package')}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-600">${escapeHtml(displayId)}</td>
                    <td class="px-6 py-4 text-sm text-slate-600">${formatContentsSummary(pkg)}</td>
                    <td class="px-4 py-4 text-right">
                        <div class="inline-flex items-center gap-2">
                            <button class="text-sm font-semibold text-orange-600 hover:text-orange-700" data-action="edit" data-id="${safeIdAttr}">Edit</button>
                            <button class="text-sm text-slate-400 hover:text-red-600" data-action="delete" data-id="${safeIdAttr}">Delete</button>
                        </div>
                    </td>
                `;
                packagesTable.appendChild(row);
            });
        };

        const loadPackages = async () => {
            try {
                const response = await fetch('/api/packages');
                if (!response.ok) throw new Error('Failed to load packages');
                const data = await response.json();
                packagesCache = data || {};
                const packagesArray = Object.values(packagesCache).sort((a, b) => {
                    return (a.name || '').localeCompare(b.name || '', undefined, { sensitivity: 'base' });
                });
                renderPackages(packagesArray);
            } catch (error) {
                console.error('Error loading packages:', error);
                packagesTable.innerHTML = `<tr><td colspan="4" class="px-6 py-6 text-center text-sm text-red-500">Unable to load packages. Please try again later.</td></tr>`;
            }
        };

        const prepareModalForNew = () => {
            resetForm();
            packageModalTitle.textContent = 'New Package';
            packageContentsInput.placeholder = "Example:\nITEM-ID-123:2\nHoliday Candle:1";
        };

        const prepareModalForEdit = (pkg) => {
            resetForm();
            packageModalTitle.textContent = 'Edit Package';
            originalPackageIdInput.value = pkg.packageId ?? pkg.id_val ?? '';
            packageNameInput.value = pkg.name || '';
            packageIdInput.value = pkg.packageId ?? pkg.id_val ?? '';
            packageContentsInput.value = (pkg.contents || []).map(entry => `${entry.itemId}:${entry.quantity}`).join('\n');
            packageMeta.textContent = pkg.updatedAt ? `Last updated: ${pkg.updatedAt}` : '';
        };

        const openNewPackageModal = () => {
            prepareModalForNew();
            showModal();
            packageNameInput.focus();
        };

        const openEditPackageModal = (packageId) => {
            const pkg = packagesCache[packageId];
            if (!pkg) {
                alert('Unable to find that package.');
                return;
            }
            prepareModalForEdit(pkg);
            showModal();
            packageNameInput.focus();
        };

        const savePackage = async () => {
            const originalId = originalPackageIdInput.value.trim();
            const name = packageNameInput.value.trim();
            const packageIdValue = packageIdInput.value.trim();
            const contentsValue = packageContentsInput.value.trim();

            if (!name) {
                alert('Name is required.');
                return;
            }

            if (!packageIdValue) {
                alert('Package ID is required.');
                return;
            }

            const payload = {
                name,
                packageId: packageIdValue,
                id_val: packageIdValue,
                contents_raw_text: contentsValue,
            };

            const requestConfig = {
                method: originalId ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            };

            const url = originalId ? `/api/packages/${originalId}` : '/api/packages';

            try {
                const response = await fetch(url, requestConfig);
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || 'Failed to save package');
                }
                hideModal();
                await loadPackages();
                alert(result.message || 'Package saved successfully.');
            } catch (error) {
                console.error('Error saving package:', error);
                alert(error.message || 'Unable to save package.');
            }
        };

        const deletePackage = async (packageId) => {
            if (!confirm('Delete this package? This cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/packages/${packageId}`, { method: 'DELETE' });
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || 'Failed to delete package');
                }
                await loadPackages();
                alert(result.message || 'Package deleted.');
            } catch (error) {
                console.error('Error deleting package:', error);
                alert(error.message || 'Unable to delete package.');
            }
        };

        addPackageButton.addEventListener('click', (event) => {
            event.preventDefault();
            openNewPackageModal();
        });

        closeModalButton.addEventListener('click', (event) => {
            event.preventDefault();
            hideModal();
        });

        cancelPackageButton.addEventListener('click', (event) => {
            event.preventDefault();
            hideModal();
        });

        savePackageButton.addEventListener('click', (event) => {
            event.preventDefault();
            savePackage();
        });

        packageModal.addEventListener('click', (event) => {
            if (event.target === packageModal) {
                hideModal();
            }
        });

        packagesTable.addEventListener('click', (event) => {
            const { action, id } = event.target.dataset;
            if (!action || !id) return;
            if (action === 'edit') {
                openEditPackageModal(id);
            }
            if (action === 'delete') {
                deletePackage(id);
            }
        });

        loadPackages();
    </script>
</body>
</html>
