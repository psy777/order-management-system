<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Items - FireCoast OMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/assets/css/styles.css">
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    <nav class="bg-slate-900 text-white shadow">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex h-16 items-center justify-between">
                <div class="flex items-center space-x-10">
                    <a href="/dashboard" class="text-lg font-semibold tracking-wide">FireCoast OMS</a>
                    <div class="hidden md:flex items-center space-x-6 text-sm font-medium">
                        <a href="/orders" class="hover:text-orange-300 transition">Orders</a>
                        <a href="/contacts" class="hover:text-orange-300 transition">Contacts</a>
                        <a href="/analytics" class="hover:text-orange-300 transition">Analytics</a>
                        <a href="/reminders" class="hover:text-orange-300 transition">Reminders</a>
                        <a href="/calendar" class="hover:text-orange-300 transition">Calendar</a>
                        <a href="/passwords" class="hover:text-orange-300 transition">Password Manager</a>
                    </div>
                </div>
                <div class="flex items-center space-x-3 text-sm font-medium">
                    <a href="/settings" class="text-orange-300">Settings</a>
                    <a href="/logout" class="hover:text-orange-300 transition">Log Out</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="py-10">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="mb-6 flex items-center justify-between">
                <div>
                    <p class="text-sm text-slate-500"><a href="/settings" class="text-orange-600 hover:text-orange-700">&larr; Back to Settings</a></p>
                    <h1 class="text-2xl font-semibold text-slate-800 mt-1">Manage Items</h1>
                    <p class="text-sm text-slate-500 mt-1">Create and maintain the catalog entries that appear in orders. Items only need a name, description, and price.</p>
                </div>
                <button id="addItemButton" class="inline-flex items-center rounded-md bg-orange-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2">
                    + New Item
                </button>
            </div>

            <div class="bg-white shadow-sm border border-slate-200 rounded-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-100">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">Description</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-semibold uppercase tracking-wide text-slate-500">Price</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wide text-slate-500">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTable" class="divide-y divide-slate-200 bg-white"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="itemModal" class="fixed inset-0 z-40 hidden">
        <div class="absolute inset-0 bg-black/40" aria-hidden="true"></div>
        <div class="absolute inset-0 flex items-center justify-center px-4">
            <div class="w-full max-w-lg rounded-lg bg-white shadow-xl">
                <div class="flex items-center justify-between border-b border-slate-200 px-6 py-4">
                    <h2 id="itemModalTitle" class="text-lg font-semibold text-slate-800">New Item</h2>
                    <button id="closeModalButton" class="text-slate-400 hover:text-slate-600 text-xl leading-none">&times;</button>
                </div>
                <form id="itemForm" class="px-6 py-5 space-y-4">
                    <input type="hidden" id="itemId">
                    <div>
                        <label for="itemName" class="block text-sm font-medium text-slate-700">Name</label>
                        <input type="text" id="itemName" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500" required>
                    </div>
                    <div>
                        <label for="itemDescription" class="block text-sm font-medium text-slate-700">Description</label>
                        <textarea id="itemDescription" rows="3" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500"></textarea>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="itemPrice" class="block text-sm font-medium text-slate-700">Price ($)</label>
                            <input type="number" id="itemPrice" min="0" step="0.01" class="mt-1 w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500" required>
                        </div>
                    </div>
                </form>
                <div class="flex items-center justify-between border-t border-slate-200 px-6 py-4">
                    <div id="itemMeta" class="text-xs text-slate-400"></div>
                    <div class="space-x-2">
                        <button id="cancelItemButton" class="rounded-md border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100">Cancel</button>
                        <button id="saveItemButton" class="rounded-md bg-orange-600 px-4 py-2 text-sm font-semibold text-white hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2">Save Item</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const itemsTable = document.getElementById('itemsTable');
        const itemModal = document.getElementById('itemModal');
        const itemForm = document.getElementById('itemForm');
        const itemModalTitle = document.getElementById('itemModalTitle');
        const itemMeta = document.getElementById('itemMeta');

        const itemIdInput = document.getElementById('itemId');
        const itemNameInput = document.getElementById('itemName');
        const itemDescriptionInput = document.getElementById('itemDescription');
        const itemPriceInput = document.getElementById('itemPrice');

        const openModalButton = document.getElementById('addItemButton');
        const closeModalButton = document.getElementById('closeModalButton');
        const cancelItemButton = document.getElementById('cancelItemButton');
        const saveItemButton = document.getElementById('saveItemButton');

        const hideModal = () => {
            itemModal.classList.add('hidden');
        };

        const showModal = () => {
            itemModal.classList.remove('hidden');
        };

        const resetForm = () => {
            itemForm.reset();
            itemIdInput.value = '';
            itemMeta.textContent = '';
        };

        const formatPrice = (priceInCents) => {
            if (typeof priceInCents !== 'number') return '$0.00';
            return `$${(priceInCents / 100).toFixed(2)}`;
        };

        const populateTable = (items) => {
            itemsTable.innerHTML = '';
            if (!Array.isArray(items) || items.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="4" class="px-6 py-6 text-center text-sm text-slate-500">No catalog items yet. Create your first item to get started.</td>`;
                itemsTable.appendChild(emptyRow);
                return;
            }

            items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 align-top">
                        <div class="text-sm font-medium text-slate-800">${item.name || 'Untitled Item'}</div>
                    </td>
                    <td class="px-6 py-4 align-top">
                        <div class="text-sm text-slate-600 whitespace-pre-line">${item.description ? item.description : '<span class="text-slate-400">No description</span>'}</div>
                    </td>
                    <td class="px-6 py-4 text-right align-top">
                        <div class="text-sm font-semibold text-slate-800">${formatPrice(item.price)}</div>
                    </td>
                    <td class="px-4 py-4 text-right align-top">
                        <div class="inline-flex items-center gap-2">
                            <button class="text-sm font-semibold text-orange-600 hover:text-orange-700" data-action="edit" data-id="${item.id}">Edit</button>
                            <button class="text-sm text-slate-400 hover:text-red-600" data-action="delete" data-id="${item.id}">Delete</button>
                        </div>
                    </td>
                `;
                itemsTable.appendChild(row);
            });
        };

        const loadItems = async () => {
            try {
                const response = await fetch('/api/items');
                if (!response.ok) throw new Error('Failed to load items');
                const items = await response.json();
                populateTable(items);
            } catch (error) {
                console.error('Error loading items:', error);
                itemsTable.innerHTML = `<tr><td colspan="4" class="px-6 py-6 text-center text-sm text-red-500">Unable to load items. Please try again later.</td></tr>`;
            }
        };

        const prepareModalForNew = () => {
            resetForm();
            itemModalTitle.textContent = 'New Item';
        };

        const prepareModalForEdit = (item) => {
            resetForm();
            itemModalTitle.textContent = 'Edit Item';
            itemIdInput.value = item.id || '';
            itemNameInput.value = item.name || '';
            itemDescriptionInput.value = item.description || '';
            itemPriceInput.value = item.price ? (item.price / 100).toFixed(2) : '';
            itemMeta.textContent = item.id ? `Item ID: ${item.id}` : '';
        };

        const openNewItemModal = () => {
            prepareModalForNew();
            showModal();
            itemNameInput.focus();
        };

        const openEditItemModal = async (itemId) => {
            try {
                const response = await fetch('/api/items');
                const items = await response.json();
                const item = items.find(i => i.id === itemId);
                if (!item) {
                    alert('Unable to find that item.');
                    return;
                }
                prepareModalForEdit(item);
                showModal();
                itemNameInput.focus();
            } catch (error) {
                console.error('Error preparing edit modal:', error);
                alert('Unable to load item details for editing.');
            }
        };

        const saveItem = async () => {
            const id = itemIdInput.value.trim();
            const name = itemNameInput.value.trim();
            const description = itemDescriptionInput.value.trim();
            const priceValue = itemPriceInput.value.trim();

            if (!name) {
                alert('Name is required.');
                return;
            }

            if (!priceValue || Number(priceValue) < 0) {
                alert('Please provide a valid price.');
                return;
            }

            const payload = {
                name,
                description,
                price: priceValue,
            };

            const requestConfig = {
                method: id ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            };

            const url = id ? `/api/items/${id}` : '/api/items';

            try {
                const response = await fetch(url, requestConfig);
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || 'Failed to save item');
                }
                hideModal();
                await loadItems();
                alert(result.message || 'Item saved successfully.');
            } catch (error) {
                console.error('Error saving item:', error);
                alert(error.message || 'Unable to save item.');
            }
        };

        const deleteItem = async (itemId) => {
            if (!confirm('Delete this item? This cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/items/${itemId}`, { method: 'DELETE' });
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || 'Failed to delete item');
                }
                await loadItems();
                alert(result.message || 'Item deleted.');
            } catch (error) {
                console.error('Error deleting item:', error);
                alert(error.message || 'Unable to delete item.');
            }
        };

        openModalButton.addEventListener('click', (event) => {
            event.preventDefault();
            openNewItemModal();
        });

        closeModalButton.addEventListener('click', (event) => {
            event.preventDefault();
            hideModal();
        });

        cancelItemButton.addEventListener('click', (event) => {
            event.preventDefault();
            hideModal();
        });

        saveItemButton.addEventListener('click', (event) => {
            event.preventDefault();
            saveItem();
        });

        itemModal.addEventListener('click', (event) => {
            if (event.target === itemModal) {
                hideModal();
            }
        });

        itemsTable.addEventListener('click', (event) => {
            const { action, id } = event.target.dataset;
            if (!action || !id) return;
            if (action === 'edit') {
                openEditItemModal(id);
            }
            if (action === 'delete') {
                deleteItem(id);
            }
        });

        loadItems();
    </script>
</body>
</html>
