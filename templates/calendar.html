<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel" src="/assets/js/record_mentions.jsx"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="../assets/css/styles.css">
    <style>
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 0.5rem;
        }
        .calendar-day {
            transition: all 0.2s ease;
        }
        .calendar-day:hover {
            transform: translateY(-2px);
        }
        .day-scroller {
            max-height: 32rem;
            overflow-y: auto;
        }
        .day-scroller::-webkit-scrollbar {
            width: 6px;
        }
        .day-scroller::-webkit-scrollbar-thumb {
            background-color: rgba(100, 116, 139, 0.4);
            border-radius: 9999px;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    <nav class="bg-slate-900 text-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex h-16 items-center justify-between">
                <div class="flex items-center space-x-10">
                    <a href="/dashboard" id="nav-home-link" class="text-lg font-semibold tracking-wide">FireNotes OMS</a>
                    <div class="hidden md:flex items-center space-x-6 text-sm font-medium">
                        <a href="/orders" class="hover:text-orange-300 transition">Orders</a>
                        <a href="/contacts" class="hover:text-orange-300 transition">Contacts</a>
                        <a href="/analytics" class="hover:text-orange-300 transition">Analytics</a>
                        <a href="/passwords" class="hover:text-orange-300 transition">Password Manager</a>
                        <a href="/calendar" class="text-orange-300">Calendar</a>
                    </div>
                </div>
                <div class="flex items-center space-x-3 text-sm font-medium">
                    <a href="/settings" class="hover:text-orange-300 transition">Settings</a>
                    <a href="#" id="nav-log-out" class="hover:text-orange-300 transition">Log Out</a>
                </div>
            </div>
        </div>
    </nav>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const brandLink = document.getElementById('nav-home-link');
            if (brandLink) {
                brandLink.addEventListener('click', (event) => {
                    event.preventDefault();
                    window.location.href = '/dashboard';
                });
            }
            const logoutLink = document.getElementById('nav-log-out');
            if (logoutLink) {
                logoutLink.addEventListener('click', async (event) => {
                    event.preventDefault();
                    if (window.fireCoastLogout) {
                        window.fireCoastLogout();
                        return;
                    }
                    try {
                        const response = await fetch('/shutdown', { method: 'POST' });
                        if (response.ok) {
                            document.body.innerHTML = '<div class="min-h-screen flex items-center justify-center text-slate-700 text-lg">Application has been shut down. You can now close this tab.</div>';
                        } else {
                            alert('Failed to log out.');
                        }
                    } catch (error) {
                        console.error('Error logging out:', error);
                        alert('Error attempting to log out.');
                    }
                });
            }
        });
    </script>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <div id="calendar-root"></div>
    </main>

    <div id="calendar-modal-root"></div>


    {% raw %}
    <script type="text/babel">
        const { useCallback, useEffect, useMemo, useRef, useState } = React;

        const monthNames = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];
        const weekdayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const mentionComponents = window.RecordMentionComponents || {};
        const MentionTextarea = mentionComponents.RecordMentionTextarea;
        const MentionText = mentionComponents.RecordMentionText;

        const defaultTimeZone = (() => {
            try {
                return Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
            } catch (error) {
                return 'UTC';
            }
        })();

        const startOfMonth = (date) => new Date(date.getFullYear(), date.getMonth(), 1);
        const startOfDay = (date) => new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0, 0);
        const endOfDay = (date) => new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 59, 999);
        const addDays = (date, days) => new Date(date.getFullYear(), date.getMonth(), date.getDate() + days);
        const isSameDay = (a, b) => a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
        const formatDateKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

        const parseEventDate = (value) => {
            if (!value) return null;
            const date = new Date(value);
            return Number.isNaN(date.getTime()) ? null : date;
        };

        const occursOnDay = (event, targetDate) => {
            const start = parseEventDate(event.start_at);
            const end = parseEventDate(event.end_at || event.start_at);
            if (!start || !end) return false;
            const dayStart = startOfDay(targetDate);
            const dayEnd = endOfDay(targetDate);
            const normalizedEnd = end < start ? start : end;
            return normalizedEnd >= dayStart && start <= dayEnd;
        };

        const parseReminderDate = (value) => {
            if (!value) return null;
            const date = new Date(value);
            return Number.isNaN(date.getTime()) ? null : date;
        };

        const reminderOccursOnDay = (reminder, targetDate) => {
            const due = parseReminderDate(reminder.due_at);
            if (!due) return false;
            const dayStart = startOfDay(targetDate);
            const dayEnd = endOfDay(targetDate);
            return due >= dayStart && due <= dayEnd;
        };

        const sortRemindersByDue = (a, b) => {
            const aDue = parseReminderDate(a.due_at);
            const bDue = parseReminderDate(b.due_at);
            if (aDue && bDue && aDue.getTime() !== bDue.getTime()) {
                return aDue.getTime() - bDue.getTime();
            }
            if (aDue && !bDue) return -1;
            if (!aDue && bDue) return 1;
            return (a.title || '').localeCompare(b.title || '', undefined, { sensitivity: 'base' });
        };

        const formatReminderDueSummary = (reminder) => {
            if (!reminder.due_at) {
                return 'No due date';
            }
            try {
                const tz = reminder.timezone || defaultTimeZone;
                const date = parseReminderDate(reminder.due_at);
                if (!date) {
                    return 'Due soon';
                }
                const dateFormatter = new Intl.DateTimeFormat('en-US', {
                    timeZone: tz,
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                });
                const datePart = dateFormatter.format(date);
                if (!reminder.due_has_time) {
                    return `Due ${datePart}`;
                }
                const timeFormatter = new Intl.DateTimeFormat('en-US', {
                    timeZone: tz,
                    hour: 'numeric',
                    minute: '2-digit',
                });
                return `Due ${datePart} · ${timeFormatter.format(date)}`;
            } catch (error) {
                return 'Due soon';
            }
        };

        const sanitizeHandle = (text) => {
            if (!text) return '';
            return text.toLowerCase().replace(/[^a-z0-9.-]+/g, '-').replace(/^-+|-+$/g, '').slice(0, 64);
        };

        const buildHandleSuggestion = (title, dateString) => {
            const base = sanitizeHandle(title);
            const datePart = dateString ? dateString.replace(/-/g, '') : '';
            if (base && datePart) {
                return `${base.slice(0, 40)}-${datePart}`;
            }
            if (base) {
                return base.slice(0, 48);
            }
            if (datePart) {
                return `event-${datePart}`;
            }
            return `event-${Math.random().toString(36).slice(2, 10)}`;
        };

        const getTimezoneOffsetMinutes = (date, timeZone) => {
            try {
                const parts = new Intl.DateTimeFormat('en-US', {
                    timeZone,
                    hour12: false,
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                }).formatToParts(date);
                const lookup = (type) => Number(parts.find((part) => part.type === type)?.value || 0);
                const asUtc = Date.UTC(
                    lookup('year'),
                    lookup('month') - 1,
                    lookup('day'),
                    lookup('hour'),
                    lookup('minute'),
                    lookup('second'),
                );
                return (asUtc - date.getTime()) / 60000;
            } catch (error) {
                console.error('Failed to determine timezone offset', error);
                return -date.getTimezoneOffset();
            }
        };

        const zonedDateTimeToUTCISO = (dateStr, timeStr, timeZone, allDay = false) => {
            if (!dateStr) return null;
            const safeTime = (timeStr && !allDay) ? timeStr : '00:00';
            const [year, month, day] = dateStr.split('-').map(Number);
            const [hour, minute] = safeTime.split(':').map((value) => Number(value || 0));
            const candidate = new Date(Date.UTC(year, month - 1, day, hour, minute, 0));
            const offsetMinutes = getTimezoneOffsetMinutes(candidate, timeZone || defaultTimeZone);
            const adjusted = new Date(candidate.getTime() - offsetMinutes * 60000);
            return adjusted.toISOString();
        };

        const extractDateParts = (isoValue, timeZone) => {
            const date = parseEventDate(isoValue);
            if (!date) {
                return { date: '', time: '' };
            }
            const tz = timeZone || defaultTimeZone;
            const dateFormatter = new Intl.DateTimeFormat('en-CA', {
                timeZone: tz,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
            });
            const timeFormatter = new Intl.DateTimeFormat('en-GB', {
                timeZone: tz,
                hour: '2-digit',
                minute: '2-digit',
                hour12: false,
            });
            return {
                date: dateFormatter.format(date),
                time: timeFormatter.format(date),
            };
        };

        const formatEventTimeRange = (event) => {
            if (event.all_day) {
                return 'All day';
            }
            const start = parseEventDate(event.start_at);
            const end = parseEventDate(event.end_at || event.start_at);
            if (!start) {
                return 'Time TBA';
            }
            const tz = event.timezone || defaultTimeZone;
            const formatter = new Intl.DateTimeFormat('en-US', {
                timeZone: tz,
                hour: 'numeric',
                minute: '2-digit',
            });
            const startLabel = formatter.format(start);
            if (!end || end.getTime() === start.getTime()) {
                return startLabel;
            }
            return `${startLabel} – ${formatter.format(end)}`;
        };

        const sortEventsByStart = (a, b) => {
            const aStart = parseEventDate(a.start_at);
            const bStart = parseEventDate(b.start_at);
            if (!aStart || !bStart) return 0;
            return aStart.getTime() - bStart.getTime();
        };

        const EventModal = ({ open, onClose, onSubmit, initialDate, event, isSaving }) => {
            const [formState, setFormState] = useState({
                title: '',
                handle: '',
                startDate: '',
                startTime: '09:00',
                endDate: '',
                endTime: '10:00',
                allDay: false,
                location: '',
                timezone: defaultTimeZone,
                notes: '',
            });
            const [formError, setFormError] = useState('');
            const [handleTouched, setHandleTouched] = useState(false);

            useEffect(() => {
                if (!open) {
                    return;
                }
                if (event) {
                    const startParts = extractDateParts(event.start_at, event.timezone);
                    const endParts = extractDateParts(event.end_at, event.timezone);
                    setFormState({
                        title: event.title || '',
                        handle: event.handle || '',
                        startDate: startParts.date,
                        startTime: startParts.time || '09:00',
                        endDate: endParts.date || startParts.date,
                        endTime: endParts.time || startParts.time || '10:00',
                        allDay: Boolean(event.all_day),
                        location: event.location || '',
                        timezone: event.timezone || defaultTimeZone,
                        notes: event.notes || '',
                    });
                    setHandleTouched(true);
                    setFormError('');
                } else {
                    const baseDate = initialDate ? startOfDay(initialDate) : new Date();
                    const baseDateStr = extractDateParts(baseDate.toISOString(), defaultTimeZone).date;
                    const suggestedHandle = buildHandleSuggestion('', baseDateStr);
                    setFormState({
                        title: '',
                        handle: suggestedHandle,
                        startDate: baseDateStr,
                        startTime: '09:00',
                        endDate: baseDateStr,
                        endTime: '10:00',
                        allDay: false,
                        location: '',
                        timezone: defaultTimeZone,
                        notes: '',
                    });
                    setHandleTouched(false);
                    setFormError('');
                }
            }, [open, event, initialDate]);

            useEffect(() => {
                if (!open || event || handleTouched) {
                    return;
                }
                setFormState((prev) => ({
                    ...prev,
                    handle: buildHandleSuggestion(prev.title, prev.startDate),
                }));
            }, [open, event, handleTouched, formState.title, formState.startDate]);

            const updateField = (field, value) => {
                setFormState((prev) => ({ ...prev, [field]: value }));
            };

            const submitForm = async (submitEvent) => {
                submitEvent.preventDefault();
                setFormError('');
                if (!formState.title.trim()) {
                    setFormError('Title is required.');
                    return;
                }
                if (!formState.startDate) {
                    setFormError('Start date is required.');
                    return;
                }
                try {
                    const timezone = formState.timezone || defaultTimeZone;
                    const startIso = zonedDateTimeToUTCISO(
                        formState.startDate,
                        formState.startTime || '00:00',
                        timezone,
                        formState.allDay,
                    );
                    if (!startIso) {
                        throw new Error('Unable to determine start time.');
                    }
                    let endIso = null;
                    const hasExplicitEnd = Boolean(formState.endDate) && (!formState.allDay || formState.endTime);
                    if (hasExplicitEnd) {
                        endIso = zonedDateTimeToUTCISO(
                            formState.endDate || formState.startDate,
                            formState.allDay ? '00:00' : (formState.endTime || formState.startTime),
                            timezone,
                            formState.allDay,
                        );
                    }
                    const payload = {
                        title: formState.title.trim(),
                        handle: formState.handle ? formState.handle.trim() : undefined,
                        start_at: startIso,
                        end_at: endIso,
                        all_day: formState.allDay,
                        location: formState.location.trim(),
                        timezone,
                        notes: formState.notes,
                    };
                    await onSubmit(payload, event ? event.id : null);
                } catch (error) {
                    console.error('Failed to save event', error);
                    setFormError(error.message || 'Failed to save event.');
                }
            };

            if (!open) {
                return null;
            }

            return ReactDOM.createPortal(
                <div className="fixed inset-0 z-40 flex items-center justify-center bg-slate-900/50 px-4">
                    <div className="w-full max-w-2xl rounded-2xl bg-white p-6 shadow-2xl">
                        <div className="flex items-center justify-between">
                            <h2 className="text-2xl font-semibold text-slate-800">{event ? 'Edit Event' : 'Schedule Event'}</h2>
                            <button
                                type="button"
                                className="rounded-full p-2 text-slate-500 transition hover:bg-slate-100"
                                onClick={() => { if (!isSaving) onClose(); }}
                                aria-label="Close"
                                disabled={isSaving}
                            >
                                <svg className="h-5 w-5" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <p className="mt-1 text-sm text-slate-500">Keep production, logistics, and review cadences aligned.</p>
                        {formError && (
                            <div className="mt-4 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
                                {formError}
                            </div>
                        )}
                        <form className="mt-6 space-y-5" onSubmit={submitForm}>
                            <div className="grid gap-4 md:grid-cols-2">
                                <label className="space-y-2">
                                    <span className="text-sm font-medium text-slate-600">Title</span>
                                    <input
                                        type="text"
                                        className="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500"
                                        value={formState.title}
                                        onChange={(event) => updateField('title', event.target.value)}
                                        required
                                        disabled={isSaving}
                                    />
                                </label>
                                <label className="space-y-2">
                                    <span className="text-sm font-medium text-slate-600">Handle</span>
                                    <input
                                        type="text"
                                        className="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500"
                                        value={formState.handle}
                                        onChange={(event) => {
                                            setHandleTouched(true);
                                            updateField('handle', sanitizeHandle(event.target.value));
                                        }}
                                        placeholder="event-handle"
                                        disabled={isSaving}
                                    />
                                </label>
                            </div>
                            <div className="grid gap-4 md:grid-cols-2">
                                <label className="space-y-2">
                                    <span className="text-sm font-medium text-slate-600">Start Date</span>
                                    <input
                                        type="date"
                                        className="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500"
                                        value={formState.startDate}
                                        onChange={(event) => updateField('startDate', event.target.value)}
                                        required
                                        disabled={isSaving}
                                    />
                                </label>
                                <label className="space-y-2">
                                    <span className="text-sm font-medium text-slate-600">Start Time</span>
                                    <input
                                        type="time"
                                        className="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500"
                                        value={formState.startTime}
                                        onChange={(event) => updateField('startTime', event.target.value)}
                                        disabled={formState.allDay || isSaving}
                                    />
                                </label>
                            </div>
                            <div className="grid gap-4 md:grid-cols-2">
                                <label className="space-y-2">
                                    <span className="text-sm font-medium text-slate-600">End Date</span>
                                    <input
                                        type="date"
                                        className="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500"
                                        value={formState.endDate}
                                        onChange={(event) => updateField('endDate', event.target.value)}
                                        disabled={isSaving}
                                    />
                                </label>
                                <label className="space-y-2">
                                    <span className="text-sm font-medium text-slate-600">End Time</span>
                                    <input
                                        type="time"
                                        className="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500"
                                        value={formState.endTime}
                                        onChange={(event) => updateField('endTime', event.target.value)}
                                        disabled={formState.allDay || isSaving}
                                    />
                                </label>
                            </div>
                            <div className="flex flex-wrap items-center gap-4">
                                <label className="inline-flex items-center gap-2 text-sm font-medium text-slate-600">
                                    <input
                                        type="checkbox"
                                        className="h-4 w-4 rounded border-slate-300 text-orange-600 focus:ring-orange-500"
                                        checked={formState.allDay}
                                        onChange={(event) => updateField('allDay', event.target.checked)}
                                        disabled={isSaving}
                                    />
                                    All day event
                                </label>
                                <label className="flex-1 space-y-2">
                                    <span className="text-sm font-medium text-slate-600">Timezone</span>
                                    <input
                                        type="text"
                                        className="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500"
                                        value={formState.timezone}
                                        onChange={(event) => updateField('timezone', event.target.value)}
                                        disabled={isSaving}
                                    />
                                </label>
                            </div>
                            <label className="space-y-2">
                                <span className="text-sm font-medium text-slate-600">Location</span>
                                <input
                                    type="text"
                                    className="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500"
                                    value={formState.location}
                                    onChange={(event) => updateField('location', event.target.value)}
                                    placeholder="HQ West Studio"
                                    disabled={isSaving}
                                />
                            </label>
                            <label className="space-y-2">
                                <span className="text-sm font-medium text-slate-600">Notes</span>
                                {MentionTextarea ? (
                                    <MentionTextarea
                                        value={formState.notes}
                                        onChange={(value) => updateField('notes', value)}
                                        entityTypes={['contact', 'order', 'note', 'calendar_event', 'reminder']}
                                        rows={4}
                                        disabled={isSaving}
                                        placeholder="Mention teammates and linked notes with @handle"
                                    />
                                ) : (
                                    <textarea
                                        className="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-orange-500 focus:outline-none focus:ring-2 focus:ring-orange-500"
                                        rows={4}
                                        value={formState.notes}
                                        onChange={(event) => updateField('notes', event.target.value)}
                                        disabled={isSaving}
                                        placeholder="Mention teammates and linked notes with @handle"
                                    />
                                )}
                            </label>
                            <div className="flex items-center justify-end gap-3">
                                <button
                                    type="button"
                                    className="rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 transition hover:bg-slate-100"
                                    onClick={() => onClose()}
                                    disabled={isSaving}
                                >
                                    Cancel
                                </button>
                                <button
                                    type="submit"
                                    className="rounded-lg bg-orange-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-orange-500 disabled:cursor-not-allowed disabled:opacity-60"
                                    disabled={isSaving}
                                >
                                    {isSaving ? 'Saving…' : (event ? 'Save Changes' : 'Create Event')}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>,
                document.getElementById('calendar-modal-root')
            );
        };

        const CalendarApp = () => {
            const [activeMonth, setActiveMonth] = useState(() => startOfMonth(new Date()));
            const [selectedDate, setSelectedDate] = useState(() => new Date());
            const [events, setEvents] = useState([]);
            const [reminders, setReminders] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [loadError, setLoadError] = useState('');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingEvent, setEditingEvent] = useState(null);
            const [modalSaving, setModalSaving] = useState(false);
            const [initialModalDate, setInitialModalDate] = useState(null);
            const [monthPickerOpen, setMonthPickerOpen] = useState(false);
            const [pickerYear, setPickerYear] = useState(() => activeMonth.getFullYear());
            const [updatingReminderId, setUpdatingReminderId] = useState(null);
            const pickerMenuRef = useRef(null);
            const pickerToggleRef = useRef(null);

            const firstVisibleDate = useMemo(() => {
                const firstOfMonth = startOfMonth(activeMonth);
                const offset = firstOfMonth.getDay();
                return addDays(firstOfMonth, -offset);
            }, [activeMonth]);

            const fetchEvents = useCallback(async (monthDate) => {
                const firstVisible = (() => {
                    const first = startOfMonth(monthDate);
                    const offset = first.getDay();
                    return addDays(first, -offset);
                })();
                const lastVisible = addDays(firstVisible, 41);
                const params = new URLSearchParams();
                params.set('start', startOfDay(firstVisible).toISOString());
                params.set('end', endOfDay(lastVisible).toISOString());
                const reminderParams = new URLSearchParams(params);
                reminderParams.set('status', 'active');
                reminderParams.set('scheduled_only', '1');
                setIsLoading(true);
                setLoadError('');
                try {
                    const [eventsResponse, remindersResponse] = await Promise.all([
                        fetch(`/api/calendar/events?${params.toString()}`),
                        fetch(`/api/reminders?${reminderParams.toString()}`),
                    ]);
                    if (!eventsResponse.ok) {
                        const result = await eventsResponse.json().catch(() => ({}));
                        throw new Error(result.message || 'Failed to load events');
                    }
                    if (!remindersResponse.ok) {
                        const result = await remindersResponse.json().catch(() => ({}));
                        throw new Error(result.message || 'Failed to load reminders');
                    }
                    const eventsResult = await eventsResponse.json();
                    const remindersResult = await remindersResponse.json();
                    const eventRecords = Array.isArray(eventsResult.events) ? eventsResult.events.slice() : [];
                    eventRecords.sort(sortEventsByStart);
                    setEvents(eventRecords);
                    const reminderRecords = Array.isArray(remindersResult.reminders) ? remindersResult.reminders.slice() : [];
                    reminderRecords.sort(sortRemindersByDue);
                    setReminders(reminderRecords);
                } catch (error) {
                    console.error('Failed to load calendar data', error);
                    setLoadError(error.message || 'Failed to load calendar data');
                    setEvents([]);
                    setReminders([]);
                } finally {
                    setIsLoading(false);
                }
            }, []);

            useEffect(() => {
                fetchEvents(activeMonth);
            }, [activeMonth, fetchEvents]);

            useEffect(() => {
                setPickerYear(activeMonth.getFullYear());
            }, [activeMonth]);

            useEffect(() => {
                if (!monthPickerOpen) {
                    return;
                }
                const handleClickOutside = (event) => {
                    if (!pickerMenuRef.current || !pickerToggleRef.current) {
                        return;
                    }
                    if (pickerMenuRef.current.contains(event.target)) {
                        return;
                    }
                    if (pickerToggleRef.current.contains(event.target)) {
                        return;
                    }
                    setMonthPickerOpen(false);
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [monthPickerOpen]);

            const eventsByDate = useMemo(() => {
                const map = new Map();
                events.forEach((event) => {
                    const start = parseEventDate(event.start_at);
                    const end = parseEventDate(event.end_at || event.start_at) || start;
                    if (!start) {
                        return;
                    }
                    const normalizedEnd = end && end > start ? end : start;
                    const maxDays = 366;
                    let iteration = 0;
                    for (let cursor = startOfDay(start); cursor <= normalizedEnd && iteration < maxDays; cursor = addDays(cursor, 1)) {
                        const key = formatDateKey(cursor);
                        const existing = map.get(key) || [];
                        existing.push(event);
                        map.set(key, existing);
                        iteration += 1;
                    }
                });
                return map;
            }, [events]);

            const remindersByDate = useMemo(() => {
                const map = new Map();
                reminders.forEach((reminder) => {
                    const due = parseReminderDate(reminder.due_at);
                    if (!due) {
                        return;
                    }
                    const key = formatDateKey(due);
                    const existing = map.get(key) || [];
                    existing.push(reminder);
                    existing.sort(sortRemindersByDue);
                    map.set(key, existing);
                });
                return map;
            }, [reminders]);

            const selectedDayEvents = useMemo(() => {
                return events.filter((event) => occursOnDay(event, selectedDate)).sort(sortEventsByStart);
            }, [events, selectedDate]);

            const selectedDayReminders = useMemo(() => {
                return reminders
                    .filter((reminder) => reminderOccursOnDay(reminder, selectedDate))
                    .sort(sortRemindersByDue);
            }, [reminders, selectedDate]);

            const dayRangeLabel = useMemo(() => {
                if (!selectedDayEvents.length) {
                    if (selectedDayReminders.length) {
                        if (selectedDayReminders.every((reminder) => !reminder.due_has_time)) {
                            return 'Reminders due';
                        }
                        const firstDue = parseReminderDate(selectedDayReminders[0].due_at);
                        const lastDue = parseReminderDate(selectedDayReminders[selectedDayReminders.length - 1].due_at);
                        if (!firstDue) {
                            return 'Reminders due';
                        }
                        const formatter = new Intl.DateTimeFormat('en-US', {
                            timeZone: defaultTimeZone,
                            hour: 'numeric',
                            minute: '2-digit',
                        });
                        if (!lastDue || !selectedDayReminders[selectedDayReminders.length - 1].due_has_time) {
                            return formatter.format(firstDue);
                        }
                        const endDue = lastDue && lastDue > firstDue ? lastDue : firstDue;
                        return `${formatter.format(firstDue)} – ${formatter.format(endDue)}`;
                    }
                    return 'All day';
                }
                if (selectedDayEvents.some((event) => event.all_day)) {
                    return 'All day';
                }
                const earliest = parseEventDate(selectedDayEvents[0].start_at);
                const latest = parseEventDate(selectedDayEvents[selectedDayEvents.length - 1].end_at || selectedDayEvents[selectedDayEvents.length - 1].start_at);
                if (!earliest) {
                    return 'Scheduled';
                }
                const formatter = new Intl.DateTimeFormat('en-US', {
                    timeZone: defaultTimeZone,
                    hour: 'numeric',
                    minute: '2-digit',
                });
                const latestResolved = latest && latest > earliest ? latest : earliest;
                return `${formatter.format(earliest)} – ${formatter.format(latestResolved)}`;
            }, [selectedDayEvents, selectedDayReminders]);

            const dayCountLabel = (() => {
                const eventCount = selectedDayEvents.length;
                const reminderCount = selectedDayReminders.length;
                if (!eventCount && !reminderCount) {
                    return '';
                }
                const parts = [];
                if (eventCount) {
                    parts.push(`${eventCount} scheduled ${eventCount === 1 ? 'item' : 'items'}`);
                }
                if (reminderCount) {
                    parts.push(`${reminderCount} reminder${reminderCount === 1 ? '' : 's'}`);
                }
                return parts.join(' · ');
            })();

            const toggleMonthPicker = (value) => {
                setMonthPickerOpen((prev) => typeof value === 'boolean' ? value : !prev);
            };

            const goToMonth = (date) => {
                setActiveMonth(startOfMonth(date));
                setMonthPickerOpen(false);
            };

            const openCreateModal = (date) => {
                setEditingEvent(null);
                setInitialModalDate(date ? new Date(date) : new Date());
                setIsModalOpen(true);
            };

            const openEditModal = (event) => {
                setEditingEvent(event);
                const start = parseEventDate(event.start_at);
                setInitialModalDate(start || new Date());
                setIsModalOpen(true);
            };

            const handleModalClose = () => {
                setIsModalOpen(false);
                setEditingEvent(null);
                setModalSaving(false);
            };

            const handleSaveEvent = async (payload, eventId) => {
                setModalSaving(true);
                try {
                    const endpoint = eventId ? `/api/calendar/events/${eventId}` : '/api/calendar/events';
                    const method = eventId ? 'PUT' : 'POST';
                    const response = await fetch(endpoint, {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    if (!response.ok) {
                        const result = await response.json().catch(() => ({}));
                        throw new Error(result.message || 'Failed to save event');
                    }
                    const result = await response.json();
                    const savedEvent = result.event || payload;
                    handleModalClose();
                    const start = parseEventDate(savedEvent.start_at);
                    if (start) {
                        setSelectedDate(start);
                        setActiveMonth(startOfMonth(start));
                    }
                    await fetchEvents(start ? startOfMonth(start) : activeMonth);
                } finally {
                    setModalSaving(false);
                }
            };

            const handleDeleteEvent = async (event) => {
                if (!event || !event.id) {
                    return;
                }
                if (!window.confirm(`Delete "${event.title}"?`)) {
                    return;
                }
                try {
                    const response = await fetch(`/api/calendar/events/${event.id}`, { method: 'DELETE' });
                    if (!response.ok) {
                        const result = await response.json().catch(() => ({}));
                        throw new Error(result.message || 'Failed to delete event');
                    }
                    await fetchEvents(activeMonth);
                } catch (error) {
                    console.error('Failed to delete event', error);
                    alert(error.message || 'Failed to delete event.');
                }
            };

            const handleToggleReminderCompletion = async (reminder) => {
                const nextCompleted = !reminder.completed;
                setUpdatingReminderId(reminder.id);
                try {
                    const response = await fetch(`/api/reminders/${reminder.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ completed: nextCompleted }),
                    });
                    if (!response.ok) {
                        const result = await response.json().catch(() => ({}));
                        throw new Error(result.message || 'Failed to update reminder');
                    }
                    await fetchEvents(activeMonth);
                } catch (error) {
                    console.error('Failed to update reminder', error);
                    alert(error.message || 'Failed to update reminder.');
                } finally {
                    setUpdatingReminderId(null);
                }
            };

            const today = useMemo(() => new Date(), []);
            const monthDates = useMemo(() => {
                return Array.from({ length: 42 }, (_, index) => addDays(firstVisibleDate, index));
            }, [firstVisibleDate]);

            const hasDayItems = selectedDayEvents.length > 0 || selectedDayReminders.length > 0;

            return (
                <div className="space-y-10">
                    <header className="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
                        <div className="space-y-2">
                            <p className="text-sm uppercase tracking-[0.3em] text-slate-500">Scheduling</p>
                            <h1 className="text-3xl sm:text-4xl font-bold text-slate-800">Calendar</h1>
                            <p className="text-slate-600 max-w-2xl">Plan production, reviews, and deliveries with a clean calendar experience tailored for the FireNotes operations team.</p>
                        </div>
                        <div className="flex flex-wrap items-center gap-3">
                            <button
                                type="button"
                                className="rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-700 transition hover:bg-slate-100"
                                onClick={() => {
                                    const todayStart = startOfDay(today);
                                    setActiveMonth(startOfMonth(todayStart));
                                    setSelectedDate(todayStart);
                                }}
                            >
                                Today
                            </button>
                            <a
                                href="/reminders"
                                className="rounded-lg border border-indigo-200 px-4 py-2 text-sm font-medium text-indigo-600 transition hover:bg-indigo-50"
                            >
                                Reminders App
                            </a>
                            <div className="relative">
                                <button
                                    type="button"
                                    ref={pickerToggleRef}
                                    onClick={() => toggleMonthPicker()}
                                    className="flex items-center gap-2 rounded-lg bg-slate-900 px-4 py-2 text-sm font-medium text-white shadow hover:bg-slate-800"
                                >
                                    <span>{monthNames[activeMonth.getMonth()]} {activeMonth.getFullYear()}</span>
                                    <svg className="h-4 w-4" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                    </svg>
                                </button>
                                {monthPickerOpen && (
                                    <div
                                        ref={pickerMenuRef}
                                        className="absolute right-0 z-30 mt-2 w-72 rounded-xl border border-slate-200 bg-white p-4 shadow-lg"
                                    >
                                        <div className="mb-3 flex items-center justify-between">
                                            <button
                                                type="button"
                                                className="rounded-full p-1.5 hover:bg-slate-100"
                                                onClick={() => setPickerYear((prev) => prev - 1)}
                                            >
                                                <svg className="h-4 w-4" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                                                </svg>
                                            </button>
                                            <span className="text-sm font-semibold text-slate-700">{pickerYear}</span>
                                            <button
                                                type="button"
                                                className="rounded-full p-1.5 hover:bg-slate-100"
                                                onClick={() => setPickerYear((prev) => prev + 1)}
                                            >
                                                <svg className="h-4 w-4" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" d="M8.25 4.5L15.75 12 8.25 19.5" />
                                                </svg>
                                            </button>
                                        </div>
                                        <div className="grid grid-cols-3 gap-2">
                                            {monthNames.map((name, index) => (
                                                <button
                                                    key={name}
                                                    type="button"
                                                    onClick={() => goToMonth(new Date(pickerYear, index, 1))}
                                                    className={`rounded-lg px-3 py-2 text-sm font-medium transition ${
                                                        activeMonth.getFullYear() === pickerYear && activeMonth.getMonth() === index
                                                            ? 'bg-slate-900 text-white shadow'
                                                            : 'text-slate-600 hover:bg-slate-100'
                                                    }`}
                                                >
                                                    {name.slice(0, 3)}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="flex items-center gap-2">
                                <button
                                    type="button"
                                    className="rounded-full p-2 hover:bg-slate-100"
                                    aria-label="Previous month"
                                    onClick={() => {
                                        const prevMonth = new Date(activeMonth.getFullYear(), activeMonth.getMonth() - 1, 1);
                                        setActiveMonth(prevMonth);
                                        setSelectedDate(prevMonth);
                                    }}
                                >
                                    <svg className="h-5 w-5 text-slate-600" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                                    </svg>
                                </button>
                                <button
                                    type="button"
                                    className="rounded-full p-2 hover:bg-slate-100"
                                    aria-label="Next month"
                                    onClick={() => {
                                        const nextMonth = new Date(activeMonth.getFullYear(), activeMonth.getMonth() + 1, 1);
                                        setActiveMonth(nextMonth);
                                        setSelectedDate(nextMonth);
                                    }}
                                >
                                    <svg className="h-5 w-5 text-slate-600" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" d="M8.25 4.5L15.75 12 8.25 19.5" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </header>

                    <section className="grid gap-8 lg:grid-cols-3">
                        <div className="lg:col-span-2">
                            <div className="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
                                <div className="grid grid-cols-7 text-xs font-semibold uppercase tracking-wide text-slate-500">
                                    {weekdayNames.map((name) => (
                                        <span key={name}>{name}</span>
                                    ))}
                                </div>
                                <div className="calendar-grid mt-3">
                                    {monthDates.map((date) => {
                                        const key = formatDateKey(date);
                                        const dayEvents = eventsByDate.get(key) || [];
                                        const dayReminders = remindersByDate.get(key) || [];
                                        const isCurrentMonth = date.getMonth() === activeMonth.getMonth();
                                        const isTodayDate = isSameDay(date, today);
                                        const isSelected = isSameDay(date, selectedDate);
                                        return (
                                            <button
                                                key={key}
                                                type="button"
                                                className={[
                                                    'calendar-day flex h-28 flex-col rounded-xl border p-3 text-left transition',
                                                    'focus:outline-none focus:ring-2 focus:ring-orange-400',
                                                    isCurrentMonth ? 'bg-white border-slate-200' : 'bg-slate-50 border-slate-100 text-slate-400',
                                                    isSelected ? 'ring-2 ring-orange-400 border-orange-300 shadow-inner' : '',
                                                    isTodayDate ? 'border-orange-500' : '',
                                                ].join(' ')}
                                                onClick={() => setSelectedDate(date)}
                                            >
                                                <div className="flex items-center justify-between">
                                                    <span className="text-sm font-semibold">{date.getDate()}</span>
                                                    {isTodayDate && (
                                                        <span className="rounded-full bg-orange-100 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-orange-600">Today</span>
                                                    )}
                                                </div>
                                                <div className="mt-2 flex-1 space-y-1 overflow-hidden">
                                                    {dayEvents.slice(0, 3).map((event) => (
                                                        <span
                                                            key={event.id}
                                                            className="block truncate rounded-md bg-orange-50 px-2 py-1 text-xs font-medium text-orange-700"
                                                        >
                                                            {event.title}
                                                        </span>
                                                    ))}
                                                    {dayEvents.length > 3 && (
                                                        <span className="text-[10px] font-medium text-slate-400">+{dayEvents.length - 3} more</span>
                                                    )}
                                                    {dayReminders.slice(0, 2).map((reminder, index) => (
                                                        <span
                                                            key={reminder.id || reminder.handle || `reminder-${key}-${index}`}
                                                            className="block truncate rounded-md bg-indigo-50 px-2 py-1 text-xs font-medium text-indigo-700"
                                                        >
                                                            {reminder.title || 'Reminder'}
                                                        </span>
                                                    ))}
                                                    {dayReminders.length > 2 && (
                                                        <span className="text-[10px] font-medium text-indigo-500">+{dayReminders.length - 2} reminders</span>
                                                    )}
                                                </div>
                                            </button>
                                        );
                                    })}
                                </div>
                                {isLoading && (
                                    <div className="mt-4 rounded-lg border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-600">
                                        Loading schedule…
                                    </div>
                                )}
                                {loadError && (
                                    <div className="mt-4 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
                                        {loadError}
                                    </div>
                                )}
                            </div>
                        </div>
                        <aside className="flex flex-col rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm uppercase tracking-[0.3em] text-slate-500">Day View</p>
                                    <h2 className="text-2xl font-semibold text-slate-800">
                                        {selectedDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}
                                    </h2>
                                </div>
                                <div className="text-right">
                                    <p className="text-sm text-slate-500">{dayRangeLabel}</p>
                                    {dayCountLabel && <p className="text-xs font-medium text-orange-500">{dayCountLabel}</p>}
                                </div>
                            </div>
                            <div className="day-scroller mt-6 flex-1 space-y-4">
                                {hasDayItems ? (
                                    <>
                                        {selectedDayEvents.map((event) => (
                                            <div key={event.id} className="rounded-2xl border border-orange-100 bg-gradient-to-br from-orange-50 to-white p-5 shadow-sm">
                                                <div className="flex items-start justify-between gap-4">
                                                    <div>
                                                        <p className="text-lg font-semibold text-slate-800">{event.title}</p>
                                                        <p className="text-sm font-medium text-orange-600">{formatEventTimeRange(event)}</p>
                                                        {event.location && (
                                                            <p className="mt-1 text-sm text-slate-500">{event.location}</p>
                                                        )}
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button
                                                            type="button"
                                                            className="rounded-lg border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 transition hover:bg-slate-100"
                                                            onClick={() => openEditModal(event)}
                                                        >
                                                            Edit
                                                        </button>
                                                        <button
                                                            type="button"
                                                            className="rounded-lg border border-red-200 px-3 py-1 text-xs font-semibold text-red-600 transition hover:bg-red-50"
                                                            onClick={() => handleDeleteEvent(event)}
                                                        >
                                                            Delete
                                                        </button>
                                                    </div>
                                                </div>
                                                <div className="mt-4 text-sm text-slate-600">
                                                    {MentionText ? (
                                                        <MentionText
                                                            text={event.notes || ''}
                                                            entityTypes={['contact', 'order', 'note', 'calendar_event', 'reminder']}
                                                            className="space-y-2"
                                                        />
                                                    ) : (
                                                        <p className="whitespace-pre-wrap text-sm text-slate-600">{event.notes || ''}</p>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                        {selectedDayReminders.map((reminder) => (
                                            <div key={reminder.id || reminder.handle} className="rounded-2xl border border-indigo-100 bg-gradient-to-br from-indigo-50 to-white p-5 shadow-sm">
                                                <div className="flex items-start justify-between gap-4">
                                                    <div>
                                                        <div className="flex items-center gap-3">
                                                            <p className="text-lg font-semibold text-slate-800">{reminder.title || 'Reminder'}</p>
                                                            {reminder.completed && (
                                                                <span className="rounded-full bg-emerald-100 px-2 py-0.5 text-xs font-semibold text-emerald-700">Completed</span>
                                                            )}
                                                        </div>
                                                        <p className="text-sm font-medium text-indigo-600">{formatReminderDueSummary(reminder)}</p>
                                                        {reminder.handle && (
                                                            <p className="text-xs uppercase tracking-wide text-slate-400">@{reminder.handle}</p>
                                                        )}
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button
                                                            type="button"
                                                            className="rounded-lg border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 transition hover:bg-slate-100 disabled:opacity-60"
                                                            onClick={() => handleToggleReminderCompletion(reminder)}
                                                            disabled={updatingReminderId === reminder.id}
                                                        >
                                                            {reminder.completed ? 'Mark active' : 'Complete'}
                                                        </button>
                                                        <a
                                                            href="/reminders"
                                                            className="rounded-lg border border-indigo-200 px-3 py-1 text-xs font-semibold text-indigo-600 transition hover:bg-indigo-50"
                                                        >
                                                            Reminders
                                                        </a>
                                                    </div>
                                                </div>
                                                <div className="mt-4 text-sm text-slate-600">
                                                    {MentionText ? (
                                                        <MentionText
                                                            text={reminder.notes || ''}
                                                            entityTypes={['contact', 'order', 'note', 'calendar_event', 'reminder']}
                                                            className="space-y-2"
                                                        />
                                                    ) : (
                                                        <p className="whitespace-pre-wrap text-sm text-slate-600">{reminder.notes || 'No notes added.'}</p>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </>
                                ) : (
                                    <div className="flex flex-col items-center justify-center rounded-xl border border-dashed border-slate-200 py-16 text-center text-slate-500">
                                        <svg className="mb-4 h-12 w-12 text-slate-400" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" d="M8 7V3m8 4V3m-9 8h10m-8 4h6M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2z" />
                                        </svg>
                                        <p className="text-sm font-medium">There are no scheduled items</p>
                                        <p className="mt-1 text-xs text-slate-400">Add an event or reminder to populate this day.</p>
                                    </div>
                                )}
                            </div>
                            <button
                                type="button"
                                className="mt-6 w-full rounded-xl border border-dashed border-orange-200 px-4 py-3 text-sm font-semibold text-orange-600 transition hover:bg-orange-50"
                                onClick={() => openCreateModal(selectedDate)}
                            >
                                Add event for this day
                            </button>
                        </aside>
                    </section>

                    <button
                        type="button"
                        className="fixed bottom-8 right-8 flex h-14 w-14 items-center justify-center rounded-full bg-orange-500 text-3xl text-white shadow-lg transition hover:bg-orange-400"
                        onClick={() => openCreateModal(selectedDate)}
                        aria-label="Add event"
                    >
                        +
                    </button>

                    <EventModal
                        open={isModalOpen}
                        onClose={handleModalClose}
                        onSubmit={handleSaveEvent}
                        initialDate={initialModalDate}
                        event={editingEvent}
                        isSaving={modalSaving}
                    />
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('calendar-root')).render(<CalendarApp />);
    </script>
    {% endraw %}
</body>
</html>
