<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FireCoast DM</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="stylesheet" href="/assets/css/firecoast_chat.css">
</head>
<body class="fc-body">
    <a class="fc-screen-reader-only" href="#fc-chat-log">Skip to chat</a>
    <nav class="fc-top-nav">
        <div class="fc-top-nav__inner">
            <div class="fc-nav-brand">
                <a id="nav-home-link" href="/dashboard" aria-label="Return to dashboard">FireCoast OMS</a>
            </div>
            <div class="fc-nav-links" aria-label="Primary navigation">
                <a href="/orders">Orders</a>
                <a href="/contacts">Contacts</a>
                <a href="/analytics">Analytics</a>
                <a href="/passwords">Password Manager</a>
                <a href="/reminders">Reminders</a>
                <a href="/calendar">Calendar</a>
                <a href="/firecoast" aria-current="page">FireCoast Chat</a>
            </div>
            <div class="fc-nav-links-secondary">
                <a href="/settings">Settings</a>
                <a id="nav-log-out" href="#">Log Out</a>
            </div>
        </div>
    </nav>

    <main class="fc-main">
        <div class="fc-workspace">
            <aside class="fc-sidebar" aria-label="Your notes">
                <div class="fc-sidebar__search">
                    <label class="fc-screen-reader-only" for="fc-thread-search">Search notes</label>
                    <input id="fc-thread-search" class="fc-sidebar__search-input" type="search" placeholder="Search notes" autocomplete="off">
                </div>
                <div class="fc-sidebar__threads" id="fc-thread-list" role="list"></div>
                <p id="fc-thread-empty" class="fc-sidebar__empty">Notes you send will show up here.</p>
            </aside>
            <section class="fc-conversation" aria-label="Conversation with @firecoast">
                <header class="fc-conversation__header">
                    <h2 class="fc-conversation__title">@firecoast</h2>
                    <div class="fc-conversation__controls">
                        <div class="fc-search">
                            <label class="fc-screen-reader-only" for="fc-search-input">Search messages</label>
                            <input id="fc-search-input" class="fc-search__input" type="search" placeholder="Search" autocomplete="off">
                        </div>
                        <button type="button" id="fc-refresh" class="fc-refresh-button" aria-label="Refresh conversation">
                            <span class="fc-refresh-button__icon" aria-hidden="true">↺</span>
                        </button>
                    </div>
                </header>
                <div class="fc-conversation__body">
                    <div id="fc-chat-log" class="fc-chat-log" role="log" aria-live="polite" aria-busy="false"></div>
                </div>
                <footer class="fc-chat-footer">
                    <p id="fc-error" class="fc-error" role="status" aria-live="assertive" hidden></p>
                    <div class="fc-composer">
                        <label for="fc-input" class="fc-screen-reader-only">Message @firecoast</label>
                        <textarea id="fc-input" class="fc-textarea" placeholder="Message @firecoast" rows="1"></textarea>
                        <button type="button" id="fc-send" class="fc-send-button" disabled>
                            <span class="fc-send-button__icon" aria-hidden="true">↩</span>
                        </button>
                    </div>
                </footer>
            </section>
        </div>
    </main>

    <script>
        (function () {
            const logoutLink = document.getElementById('nav-log-out');
            const brandLink = document.getElementById('nav-home-link');
            if (brandLink) {
                brandLink.addEventListener('click', (event) => {
                    event.preventDefault();
                    window.location.href = '/dashboard';
                });
            }
            if (logoutLink) {
                logoutLink.addEventListener('click', async (event) => {
                    event.preventDefault();
                    if (window.fireCoastLogout) {
                        window.fireCoastLogout();
                        return;
                    }
                    try {
                        const response = await fetch('/shutdown', { method: 'POST' });
                        if (response.ok) {
                            document.body.innerHTML = '<div class="fc-main" style="color:#1f2933;text-align:center;">Application has been shut down. You can now close this tab.</div>';
                        } else {
                            alert('Failed to log out.');
                        }
                    } catch (error) {
                        console.error('Error logging out:', error);
                        alert('Error attempting to log out.');
                    }
                });
            }
        })();
    </script>

    <script>
        (function () {
            const logEl = document.getElementById('fc-chat-log');
            const inputEl = document.getElementById('fc-input');
            const sendButton = document.getElementById('fc-send');
            const refreshButton = document.getElementById('fc-refresh');
            const errorEl = document.getElementById('fc-error');
            const threadListEl = document.getElementById('fc-thread-list');
            const threadEmptyEl = document.getElementById('fc-thread-empty');
            const searchInput = document.getElementById('fc-search-input');
            const threadSearchInput = document.getElementById('fc-thread-search');
            const state = {
                messages: [],
                isLoading: false,
                isSending: false,
                error: null,
                refreshTimer: null,
                searchQuery: '',
                threadQuery: '',
            };

            const MAX_COMPOSER_HEIGHT = 220;

            const formatTimestamp = (value, withTime = true) => {
                if (!value) {
                    return '';
                }
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) {
                    return value;
                }
                const options = withTime
                    ? { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }
                    : { year: 'numeric', month: 'short', day: 'numeric' };
                return new Intl.DateTimeFormat(undefined, options).format(date);
            };

            const formatEventWindow = (event) => {
                if (!event || !event.start_at) {
                    return '';
                }
                const start = new Date(event.start_at);
                const end = new Date(event.end_at || event.start_at);
                if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) {
                    return formatTimestamp(event.start_at, !event.all_day);
                }
                const sameDay = start.toDateString() === end.toDateString();
                if (event.all_day || (start.getHours() === 0 && start.getMinutes() === 0 && sameDay)) {
                    return sameDay
                        ? formatTimestamp(start.toISOString(), false)
                        : `${formatTimestamp(start.toISOString(), false)} – ${formatTimestamp(end.toISOString(), false)}`;
                }
                if (sameDay) {
                    const timeFormatter = new Intl.DateTimeFormat(undefined, {
                        hour: 'numeric',
                        minute: '2-digit',
                    });
                    return `${formatTimestamp(start.toISOString(), true)} – ${timeFormatter.format(end)}`;
                }
                return `${formatTimestamp(start.toISOString(), true)} – ${formatTimestamp(end.toISOString(), true)}`;
            };

            const normalizePreview = (value) => {
                if (!value) {
                    return '';
                }
                return String(value).replace(/\s+/g, ' ').trim();
            };

            const matchesSearch = (message, query) => {
                if (!query) {
                    return true;
                }
                const lowered = query.toLowerCase();
                const content = normalizePreview(message.content || '').toLowerCase();
                if (content.includes(lowered)) {
                    return true;
                }
                try {
                    const metadataText = JSON.stringify(message.metadata || {});
                    if (metadataText && metadataText.toLowerCase().includes(lowered)) {
                        return true;
                    }
                } catch (error) {
                    console.debug('Unable to stringify message metadata for search', error);
                }
                return false;
            };

            const clearError = () => {
                state.error = null;
                if (errorEl) {
                    errorEl.hidden = true;
                    errorEl.textContent = '';
                }
            };

            const showError = (message) => {
                state.error = message;
                if (errorEl) {
                    errorEl.hidden = !message;
                    errorEl.textContent = message || '';
                }
            };

            const setBusy = (isBusy) => {
                if (logEl) {
                    logEl.setAttribute('aria-busy', String(isBusy));
                }
            };

            const createMetadataDetails = (metadata) => {
                if (!metadata || !metadata.action) {
                    return null;
                }

                const container = document.createElement('div');
                container.className = 'fc-message__details';
                let hasContent = false;

                const addLine = (text) => {
                    if (!text) {
                        return;
                    }
                    const line = document.createElement('div');
                    line.textContent = text;
                    container.appendChild(line);
                    hasContent = true;
                };

                const addList = (items) => {
                    if (!items.length) {
                        return;
                    }
                    const list = document.createElement('ul');
                    list.className = 'fc-message__details-list';
                    items.forEach((entry) => {
                        const item = document.createElement('li');
                        item.textContent = entry;
                        list.appendChild(item);
                    });
                    container.appendChild(list);
                    hasContent = true;
                };

                const addLink = (href, label) => {
                    if (!href || !label) {
                        return;
                    }
                    const link = document.createElement('a');
                    link.href = href;
                    link.textContent = label;
                    link.setAttribute('target', '_self');
                    container.appendChild(link);
                    hasContent = true;
                };

                const action = metadata.action;

                if (action === 'calendar_event_created') {
                    addLine('Calendar event saved');
                    const event = metadata.event || {};
                    if (event.title) {
                        addLine(event.title);
                    }
                    const windowText = formatEventWindow(event);
                    if (windowText) {
                        addLine(windowText);
                    }
                    addLink('/calendar', 'Open calendar');
                    return hasContent ? container : null;
                }

                if (action === 'reminder_created') {
                    addLine('Reminder saved');
                    const reminder = metadata.reminder || {};
                    if (reminder.title) {
                        addLine(reminder.title);
                    }
                    const due = reminder.due_at
                        ? formatTimestamp(reminder.due_at, reminder.due_has_time)
                        : 'No due date';
                    addLine(due);
                    addLink('/reminders', 'Open reminders');
                    return hasContent ? container : null;
                }

                if (action === 'password_lookup') {
                    addLine('Saved passwords');
                    const matches = Array.isArray(metadata.matches) ? metadata.matches : [];
                    const items = matches.slice(0, 5).map((entry) => {
                        const service = entry.service || 'Service';
                        const username = entry.username || 'Unknown user';
                        const password = entry.password ? `Password: ${entry.password}` : 'No password saved';
                        return `${service} • ${username} • ${password}`;
                    });
                    addList(items);
                    if (matches.length > 5) {
                        addLine(`…and ${matches.length - 5} more saved credentials.`);
                    }
                    addLink('/passwords', 'Open password vault');
                    return hasContent ? container : null;
                }

                if (action === 'report_run') {
                    const report = metadata.report || {};
                    addLine('Report generated');
                    if (report.name || report.id) {
                        addLine(report.name || report.id);
                    }
                    const summary = Array.isArray(report.summary) ? report.summary.slice(0, 4) : [];
                    if (summary.length) {
                        addList(
                            summary.map((entry) => {
                                const label = entry.label || entry.id || 'Metric';
                                const display = entry.display || entry.value;
                                return display ? `${label}: ${display}` : label;
                            })
                        );
                    }
                    addLink('/analytics', 'Open analytics');
                    return hasContent ? container : null;
                }

                if (action === 'report_list') {
                    addLine('Available reports');
                    const reports = Array.isArray(metadata.reports) ? metadata.reports : [];
                    if (reports.length) {
                        addList(
                            reports.map((report) => {
                                const suffix = report.name ? ` — ${report.name}` : '';
                                return `${report.id}${suffix}`;
                            })
                        );
                    } else {
                        addLine('No saved analytics reports yet.');
                    }
                    return hasContent ? container : null;
                }

                if (action === 'error') {
                    addLine('Something went wrong');
                    addLine(metadata.reason || 'Unable to process the request.');
                    return hasContent ? container : null;
                }

                if (action === 'help') {
                    addLine('Assistant capabilities');
                    addList([
                        'Use .reminder to save follow-ups.',
                        'Use .event to schedule calendar blocks.',
                        'Ask @firecoast about reports or saved passwords.',
                    ]);
                    return hasContent ? container : null;
                }

                return null;
            };

            const scrollToMessage = (targetId) => {
                if (!targetId) {
                    return;
                }
                const element = document.getElementById(targetId);
                if (!element) {
                    return;
                }
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                element.classList.add('fc-message--active');
                window.setTimeout(() => {
                    element.classList.remove('fc-message--active');
                }, 1200);
            };

            const createThreadButton = (message) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'fc-thread';
                const messageId = message.id ? `message-${message.id}` : '';
                if (messageId) {
                    button.setAttribute('data-target', messageId);
                }

                const title = document.createElement('div');
                title.className = 'fc-thread__title';
                title.textContent = 'You';

                const preview = document.createElement('div');
                preview.className = 'fc-thread__preview';
                const previewText = normalizePreview(message.content || '') || 'Untitled note';
                preview.textContent = previewText.length > 80 ? `${previewText.slice(0, 77)}…` : previewText;

                const timestamp = document.createElement('time');
                timestamp.className = 'fc-thread__timestamp';
                if (message.created_at) {
                    timestamp.dateTime = message.created_at;
                    timestamp.textContent = formatTimestamp(message.created_at, true);
                }

                button.appendChild(title);
                button.appendChild(preview);
                button.appendChild(timestamp);
                button.addEventListener('click', () => {
                    const target = button.getAttribute('data-target');
                    if (target) {
                        scrollToMessage(target);
                    }
                });

                return button;
            };

            const renderThreads = () => {
                if (!threadListEl) {
                    return;
                }
                threadListEl.innerHTML = '';

                const trimmedQuery = normalizePreview(state.threadQuery || '');
                const userMessages = state.messages.filter(
                    (message) => (message.author || '').toLowerCase() === 'user'
                );
                const source = trimmedQuery
                    ? userMessages.filter((message) => matchesSearch(message, trimmedQuery))
                    : userMessages;

                if (!source.length) {
                    if (threadEmptyEl) {
                        threadEmptyEl.hidden = false;
                        threadEmptyEl.textContent = trimmedQuery
                            ? 'No matches yet.'
                            : 'Notes you send will show up here.';
                    }
                    return;
                }

                if (threadEmptyEl) {
                    threadEmptyEl.hidden = true;
                    threadEmptyEl.textContent = 'Notes you send will show up here.';
                }

                const sorted = source
                    .slice()
                    .sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
                const fragment = document.createDocumentFragment();
                sorted.slice(0, 40).forEach((message) => {
                    fragment.appendChild(createThreadButton(message));
                });
                threadListEl.appendChild(fragment);
            };

            const renderMessage = (message) => {
                const author = (message.author || '').toLowerCase();
                const isUser = author === 'user';

                const wrapper = document.createElement('article');
                const messageId = message.id ? `message-${message.id}` : '';
                if (messageId) {
                    wrapper.id = messageId;
                }
                wrapper.className = 'fc-message ' + (isUser ? 'fc-message--user' : 'fc-message--assistant');

                const avatar = document.createElement('div');
                avatar.className = 'fc-avatar ' + (isUser ? 'fc-avatar--user' : 'fc-avatar--assistant');
                avatar.textContent = isUser ? 'Y' : 'F';
                avatar.setAttribute('aria-hidden', 'true');

                const body = document.createElement('div');
                body.className = 'fc-message__body';

                const header = document.createElement('div');
                header.className = 'fc-message__header';
                const authorLabel = document.createElement('span');
                authorLabel.className = 'fc-message__author';
                authorLabel.textContent = isUser ? 'You' : '@firecoast';
                const timestamp = document.createElement('time');
                timestamp.className = 'fc-message__timestamp';
                if (message.created_at) {
                    timestamp.dateTime = message.created_at;
                }
                const timestampText = formatTimestamp(message.created_at, true);
                if (timestampText) {
                    timestamp.textContent = timestampText;
                }
                header.appendChild(authorLabel);
                header.appendChild(timestamp);
                body.appendChild(header);

                if (message.content) {
                    const text = document.createElement('div');
                    text.className = 'fc-message__text';
                    text.textContent = message.content;
                    body.appendChild(text);
                }

                const metadataDetails = createMetadataDetails(message.metadata);
                if (metadataDetails) {
                    body.appendChild(metadataDetails);
                }

                wrapper.appendChild(avatar);
                wrapper.appendChild(body);

                return wrapper;
            };

            const renderMessages = () => {
                if (!logEl) {
                    return;
                }
                logEl.innerHTML = '';

                if (state.isLoading) {
                    setBusy(true);
                    const loading = document.createElement('div');
                    loading.className = 'fc-loading-state';
                    loading.textContent = 'Loading your conversation…';
                    logEl.appendChild(loading);
                    return;
                }

                setBusy(false);

                const trimmedQuery = normalizePreview(state.searchQuery || '');
                const visibleMessages = trimmedQuery
                    ? state.messages.filter((message) => matchesSearch(message, trimmedQuery))
                    : state.messages.slice();

                if (!visibleMessages.length) {
                    const empty = document.createElement('div');
                    empty.className = 'fc-empty-state' + (trimmedQuery ? ' fc-empty-state--search' : '');
                    const text = document.createElement('p');
                    text.textContent = trimmedQuery
                        ? `No messages matched "${trimmedQuery}".`
                        : 'Drop a note to start the thread.';
                    empty.appendChild(text);
                    logEl.appendChild(empty);
                    return;
                }

                const fragments = document.createDocumentFragment();
                visibleMessages.forEach((message) => {
                    fragments.appendChild(renderMessage(message));
                });
                logEl.appendChild(fragments);
                if (!trimmedQuery) {
                    logEl.scrollTop = logEl.scrollHeight;
                }
            };

            const updateSendButton = () => {
                if (!sendButton || !inputEl) {
                    return;
                }
                const trimmed = inputEl.value.trim();
                sendButton.disabled = !trimmed || state.isSending;
            };

            const loadMessages = async (options = {}) => {
                const silent = Boolean(options.silent);
                if (!silent) {
                    state.isLoading = true;
                    renderMessages();
                }
                try {
                    const response = await fetch('/api/firecoast/chat?limit=200');
                    if (!response.ok) {
                        throw new Error('Failed to load conversation');
                    }
                    const payload = await response.json();
                    const incoming = Array.isArray(payload.messages) ? payload.messages : [];
                    state.messages = incoming;
                    clearError();
                } catch (error) {
                    console.error('Failed to load messages', error);
                    if (!silent) {
                        showError('Unable to load your messages.');
                    }
                } finally {
                    state.isLoading = false;
                    renderMessages();
                    renderThreads();
                }
            };

            const autoResizeInput = () => {
                if (!inputEl) {
                    return;
                }
                inputEl.style.height = 'auto';
                const targetHeight = Math.min(MAX_COMPOSER_HEIGHT, inputEl.scrollHeight);
                inputEl.style.height = `${Math.max(targetHeight, 44)}px`;
            };

            const sendMessage = async () => {
                if (!inputEl) {
                    return;
                }
                const content = inputEl.value.trim();
                if (!content || state.isSending) {
                    return;
                }
                state.isSending = true;
                updateSendButton();
                clearError();

                try {
                    const response = await fetch('/api/firecoast/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content }),
                    });
                    if (!response.ok) {
                        throw new Error('Chat request failed');
                    }
                    const payload = await response.json();
                    const incoming = Array.isArray(payload.messages) ? payload.messages : [];
                    state.messages = state.messages.concat(incoming);
                    inputEl.value = '';
                    autoResizeInput();
                    updateSendButton();
                    clearError();
                    renderMessages();
                    renderThreads();
                } catch (error) {
                    console.error('Failed to send message', error);
                    showError('Unable to send that message. Please try again.');
                } finally {
                    state.isSending = false;
                    updateSendButton();
                    if (logEl) {
                        logEl.scrollTop = logEl.scrollHeight;
                    }
                }
            };

            if (inputEl) {
                autoResizeInput();
                inputEl.addEventListener('input', () => {
                    autoResizeInput();
                    updateSendButton();
                });
                inputEl.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        sendMessage();
                    }
                });
                updateSendButton();
            }

            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            }

            if (refreshButton) {
                refreshButton.addEventListener('click', () => {
                    loadMessages();
                });
            }

            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    state.searchQuery = searchInput.value || '';
                    renderMessages();
                });
            }

            if (threadSearchInput) {
                threadSearchInput.addEventListener('input', () => {
                    state.threadQuery = threadSearchInput.value || '';
                    renderThreads();
                });
            }

            renderThreads();
            loadMessages();
            state.refreshTimer = window.setInterval(() => loadMessages({ silent: true }), 25000);

            window.addEventListener('beforeunload', () => {
                if (state.refreshTimer) {
                    window.clearInterval(state.refreshTimer);
                }
            });
        })();
    </script>
</body>
</html>
