<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FireCoast DM</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="stylesheet" href="/assets/css/firecoast_chat.css">
</head>
<body class="fc-body">
    <a class="fc-screen-reader-only" href="#firecoast-chat-root">Skip to chat</a>
    <nav class="fc-top-nav">
        <div class="fc-top-nav__inner">
            <div class="fc-nav-brand">
                <a id="nav-home-link" href="/dashboard" aria-label="Return to dashboard">FireCoast OMS</a>
            </div>
            <div class="fc-nav-links" aria-label="Primary navigation">
                <a href="/orders">Orders</a>
                <a href="/contacts">Contacts</a>
                <a href="/analytics">Analytics</a>
                <a href="/passwords">Password Manager</a>
                <a href="/reminders">Reminders</a>
                <a href="/calendar">Calendar</a>
                <a href="/firecoast" aria-current="page">FireCoast Chat</a>
            </div>
            <div class="fc-nav-links-secondary">
                <a href="/settings">Settings</a>
                <a id="nav-log-out" href="#">Log Out</a>
            </div>
        </div>
    </nav>

    <main class="fc-main">
        <header class="fc-header">
            <div class="fc-header__eyebrow">FireCoast Assistant</div>
            <h1 class="fc-header__title">Direct Messages</h1>
            <p class="fc-header__subtitle">
                Keep private notes, queue reminders and events, and chat with <strong>@firecoast</strong> just like a personal Discord DM.
            </p>
        </header>
        <section class="fc-chat-shell" aria-label="FireCoast conversation">
            <div id="firecoast-chat-root" class="fc-chat-panel">
                <div class="fc-chat-toolbar">
                    <div class="fc-toolbar-copy">
                        <div class="fc-toolbar-chip-row">
                            <div class="fc-chip">@firecoast</div>
                            <div class="fc-chip fc-chip--muted" aria-hidden="true">always on</div>
                        </div>
                        <h2>Personal Console</h2>
                        <p>Messages stay private to you. Ask for passwords, spin up reminders, or jot quick thoughts.</p>
                    </div>
                    <button type="button" id="fc-refresh" class="fc-refresh-button" aria-label="Refresh conversation">
                        <span>Refresh</span>
                        <span aria-hidden="true">↺</span>
                    </button>
                </div>
                <div id="fc-chat-log" class="fc-chat-log" role="log" aria-live="polite" aria-busy="false"></div>
                <div class="fc-chat-footer">
                    <p id="fc-error" class="fc-error" role="status" aria-live="assertive" hidden></p>
                    <div class="fc-quick-actions" aria-label="Quick message templates">
                        <button type="button" class="fc-quick-button" data-template=".reminder Follow up | tomorrow 9am | add tracking number">.reminder</button>
                        <button type="button" class="fc-quick-button" data-template=".event Project kickoff | next Tuesday 2pm | next Tuesday 3:30pm | HQ West | finalize agenda">.event</button>
                        <button type="button" class="fc-quick-button" data-template="@firecoast what's my password for Example">Passwords</button>
                        <button type="button" class="fc-quick-button" data-template=".report orders_overview from 2024-01-01 to 2024-03-31">Reports</button>
                    </div>
                    <div class="fc-composer">
                        <label for="fc-input" class="fc-screen-reader-only">Message the FireCoast assistant</label>
                        <textarea id="fc-input" class="fc-textarea" placeholder="Type a message. Use Shift+Enter for a new line." rows="4"></textarea>
                        <button type="button" id="fc-send" class="fc-send-button" disabled>
                            <span>Send</span>
                            <span class="fc-send-button__icon" aria-hidden="true">↩</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        (function () {
            const logoutLink = document.getElementById('nav-log-out');
            const brandLink = document.getElementById('nav-home-link');
            if (brandLink) {
                brandLink.addEventListener('click', (event) => {
                    event.preventDefault();
                    window.location.href = '/dashboard';
                });
            }
            if (logoutLink) {
                logoutLink.addEventListener('click', async (event) => {
                    event.preventDefault();
                    if (window.fireCoastLogout) {
                        window.fireCoastLogout();
                        return;
                    }
                    try {
                        const response = await fetch('/shutdown', { method: 'POST' });
                        if (response.ok) {
                            document.body.innerHTML = '<div class="fc-main" style="color:#1f2933;text-align:center;">Application has been shut down. You can now close this tab.</div>';
                        } else {
                            alert('Failed to log out.');
                        }
                    } catch (error) {
                        console.error('Error logging out:', error);
                        alert('Error attempting to log out.');
                    }
                });
            }
        })();
    </script>

    <script>
        (function () {
            const logEl = document.getElementById('fc-chat-log');
            const inputEl = document.getElementById('fc-input');
            const sendButton = document.getElementById('fc-send');
            const refreshButton = document.getElementById('fc-refresh');
            const errorEl = document.getElementById('fc-error');
            const quickButtons = Array.from(document.querySelectorAll('.fc-quick-button'));

            const state = {
                messages: [],
                isLoading: false,
                isSending: false,
                error: null,
                refreshTimer: null,
            };

            const QUICK_TEMPLATE_FOCUS_DELAY = 10;

            const formatTimestamp = (value, withTime = true) => {
                if (!value) {
                    return '';
                }
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) {
                    return value;
                }
                const options = withTime
                    ? { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }
                    : { year: 'numeric', month: 'short', day: 'numeric' };
                return new Intl.DateTimeFormat(undefined, options).format(date);
            };

            const formatEventWindow = (event) => {
                if (!event || !event.start_at) {
                    return '';
                }
                const start = new Date(event.start_at);
                const end = new Date(event.end_at || event.start_at);
                if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) {
                    return formatTimestamp(event.start_at, !event.all_day);
                }
                const sameDay = start.toDateString() === end.toDateString();
                if (event.all_day || (start.getHours() === 0 && start.getMinutes() === 0 && sameDay)) {
                    return sameDay
                        ? formatTimestamp(start.toISOString(), false)
                        : `${formatTimestamp(start.toISOString(), false)} – ${formatTimestamp(end.toISOString(), false)}`;
                }
                if (sameDay) {
                    const timeFormatter = new Intl.DateTimeFormat(undefined, {
                        hour: 'numeric',
                        minute: '2-digit',
                    });
                    return `${formatTimestamp(start.toISOString(), true)} – ${timeFormatter.format(end)}`;
                }
                return `${formatTimestamp(start.toISOString(), true)} – ${formatTimestamp(end.toISOString(), true)}`;
            };

            const clearError = () => {
                state.error = null;
                if (errorEl) {
                    errorEl.hidden = true;
                    errorEl.textContent = '';
                }
            };

            const showError = (message) => {
                state.error = message;
                if (errorEl) {
                    errorEl.hidden = !message;
                    errorEl.textContent = message || '';
                }
            };

            const setBusy = (isBusy) => {
                if (logEl) {
                    logEl.setAttribute('aria-busy', String(isBusy));
                }
            };

            const createMetadataCard = (metadata, isUser) => {
                if (!metadata || !metadata.action) {
                    return null;
                }
                const wrapper = document.createElement('div');
                wrapper.className = 'fc-metadata-card' + (isUser ? ' fc-metadata-card--user' : '');

                const title = document.createElement('div');
                title.className = 'fc-metadata-card__title' + (isUser ? ' fc-metadata-card__title--user' : '');

                const addLink = (href, label) => {
                    const link = document.createElement('a');
                    link.className = 'fc-metadata-link';
                    link.href = href;
                    link.textContent = label;
                    link.setAttribute('target', '_self');
                    return link;
                };

                const action = metadata.action;
                if (action === 'calendar_event_created') {
                    title.textContent = 'Calendar event created';
                    wrapper.appendChild(title);

                    const subtitle = document.createElement('div');
                    subtitle.className = 'fc-metadata-card__subtitle';
                    subtitle.textContent = (metadata.event && metadata.event.title) || 'Event';
                    wrapper.appendChild(subtitle);

                    const metaLine = document.createElement('div');
                    metaLine.className = 'fc-metadata-card__muted';
                    metaLine.textContent = formatEventWindow(metadata.event || {});
                    wrapper.appendChild(metaLine);

                    wrapper.appendChild(addLink('/calendar', 'Open calendar →'));
                    return wrapper;
                }

                if (action === 'reminder_created') {
                    title.textContent = 'Reminder created';
                    wrapper.appendChild(title);

                    const subtitle = document.createElement('div');
                    subtitle.className = 'fc-metadata-card__subtitle';
                    const reminder = metadata.reminder || {};
                    subtitle.textContent = reminder.title || 'Reminder';
                    wrapper.appendChild(subtitle);

                    const metaLine = document.createElement('div');
                    metaLine.className = 'fc-metadata-card__muted';
                    const due = reminder.due_at ? formatTimestamp(reminder.due_at, reminder.due_has_time) : 'No due date';
                    metaLine.textContent = due;
                    wrapper.appendChild(metaLine);

                    wrapper.appendChild(addLink('/reminders', 'View reminders →'));
                    return wrapper;
                }

                if (action === 'password_lookup') {
                    title.textContent = 'Saved passwords';
                    wrapper.appendChild(title);

                    const matches = Array.isArray(metadata.matches) ? metadata.matches : [];
                    matches.slice(0, 5).forEach((entry) => {
                        const row = document.createElement('div');
                        row.className = 'fc-password-entry';

                        const service = document.createElement('span');
                        service.className = 'fc-password-entry__service';
                        service.textContent = entry.service || 'Service';
                        row.appendChild(service);

                        const username = document.createElement('span');
                        username.className = 'fc-password-entry__username';
                        username.textContent = (entry.username || 'no user').toUpperCase();
                        row.appendChild(username);

                        const passwordLine = document.createElement('div');
                        passwordLine.className = 'fc-password-entry__password';
                        passwordLine.textContent = entry.password ? `Password: ${entry.password}` : 'No password saved';
                        row.appendChild(passwordLine);

                        wrapper.appendChild(row);
                    });

                    if (matches.length > 5) {
                        const more = document.createElement('div');
                        more.className = 'fc-metadata-card__muted';
                        more.textContent = `…and ${matches.length - 5} more saved credentials.`;
                        wrapper.appendChild(more);
                    }

                    wrapper.appendChild(addLink('/passwords', 'Open password vault →'));
                    return wrapper;
                }

                if (action === 'report_run') {
                    title.textContent = 'Report generated';
                    wrapper.appendChild(title);

                    const report = metadata.report || {};
                    const subtitle = document.createElement('div');
                    subtitle.className = 'fc-metadata-card__subtitle';
                    subtitle.textContent = report.name || report.id || 'Analytics report';
                    wrapper.appendChild(subtitle);

                    const summary = Array.isArray(report.summary) ? report.summary.slice(0, 4) : [];
                    if (summary.length) {
                        const list = document.createElement('ul');
                        summary.forEach((entry) => {
                            const item = document.createElement('li');
                            const label = entry.label || entry.id || 'Metric';
                            const display = entry.display || entry.value;
                            item.textContent = `${label}: ${display}`;
                            list.appendChild(item);
                        });
                        wrapper.appendChild(list);
                    }

                    wrapper.appendChild(addLink('/analytics', 'Open analytics →'));
                    return wrapper;
                }

                if (action === 'report_list') {
                    title.textContent = 'Available reports';
                    wrapper.appendChild(title);

                    const reports = Array.isArray(metadata.reports) ? metadata.reports : [];
                    if (reports.length) {
                        const list = document.createElement('ul');
                        reports.forEach((report) => {
                            const item = document.createElement('li');
                            const name = report.name ? ` — ${report.name}` : '';
                            item.textContent = `${report.id}${name}`;
                            list.appendChild(item);
                        });
                        wrapper.appendChild(list);
                    } else {
                        const empty = document.createElement('div');
                        empty.className = 'fc-metadata-card__muted';
                        empty.textContent = 'No saved analytics reports yet.';
                        wrapper.appendChild(empty);
                    }
                    return wrapper;
                }

                if (action === 'error') {
                    wrapper.classList.add('fc-metadata-card--error');
                    title.textContent = 'Something went wrong';
                    wrapper.appendChild(title);

                    const message = document.createElement('div');
                    message.textContent = metadata.reason || 'Unable to process the request.';
                    wrapper.appendChild(message);
                    return wrapper;
                }

                if (action === 'help') {
                    title.textContent = 'Assistant capabilities';
                    wrapper.appendChild(title);

                    const list = document.createElement('ul');
                    const entries = [
                        'Use .reminder to save follow-ups.',
                        'Use .event to schedule calendar blocks.',
                        'Ask @firecoast about reports or saved passwords.',
                    ];
                    entries.forEach((text) => {
                        const item = document.createElement('li');
                        item.textContent = text;
                        list.appendChild(item);
                    });
                    wrapper.appendChild(list);
                    return wrapper;
                }

                return null;
            };

            const renderMessage = (message) => {
                const author = (message.author || '').toLowerCase();
                const isUser = author === 'user';

                const wrapper = document.createElement('div');
                wrapper.className = 'fc-message' + (isUser ? ' fc-message--user' : '');

                const avatar = document.createElement('div');
                avatar.className = 'fc-avatar ' + (isUser ? 'fc-avatar--user' : 'fc-avatar--assistant');
                avatar.textContent = isUser ? 'Y' : 'F';
                avatar.setAttribute('aria-hidden', 'true');

                const bubble = document.createElement('div');
                bubble.className = 'fc-bubble ' + (isUser ? 'fc-bubble--user' : 'fc-bubble--assistant');

                const meta = document.createElement('div');
                meta.className = 'fc-bubble__meta';
                const authorLabel = document.createElement('span');
                authorLabel.textContent = isUser ? 'You' : '@firecoast';
                const timestamp = document.createElement('span');
                timestamp.textContent = formatTimestamp(message.created_at, true);
                meta.appendChild(authorLabel);
                meta.appendChild(timestamp);
                bubble.appendChild(meta);

                const text = document.createElement('div');
                text.className = 'fc-message__text';
                text.textContent = message.content || '';
                bubble.appendChild(text);

                const metadataCard = createMetadataCard(message.metadata, isUser);
                if (metadataCard) {
                    bubble.appendChild(metadataCard);
                }

                wrapper.appendChild(avatar);
                wrapper.appendChild(bubble);

                return wrapper;
            };

            const renderMessages = () => {
                if (!logEl) {
                    return;
                }
                logEl.innerHTML = '';

                if (state.isLoading) {
                    setBusy(true);
                    const loading = document.createElement('div');
                    loading.className = 'fc-loading-state';
                    loading.textContent = 'Loading your conversation…';
                    logEl.appendChild(loading);
                    return;
                }

                setBusy(false);

                if (!state.messages.length) {
                    const empty = document.createElement('div');
                    empty.className = 'fc-empty-state';
                    const pill = document.createElement('div');
                    pill.className = 'fc-empty-pill';
                    pill.textContent = 'Start chatting';
                    empty.appendChild(pill);
                    const text = document.createElement('p');
                    text.innerHTML = 'Send yourself notes and tasks. Try <code>.reminder Send invoices | tomorrow 9am</code> to see it in action.';
                    empty.appendChild(text);
                    logEl.appendChild(empty);
                    return;
                }

                const fragments = document.createDocumentFragment();
                state.messages.forEach((message) => {
                    fragments.appendChild(renderMessage(message));
                });
                logEl.appendChild(fragments);
                logEl.scrollTop = logEl.scrollHeight;
            };

            const updateSendButton = () => {
                if (!sendButton || !inputEl) {
                    return;
                }
                const trimmed = inputEl.value.trim();
                sendButton.disabled = !trimmed || state.isSending;
            };

            const loadMessages = async (options = {}) => {
                const silent = Boolean(options.silent);
                if (!silent) {
                    state.isLoading = true;
                    renderMessages();
                }
                try {
                    const response = await fetch('/api/firecoast/chat?limit=200');
                    if (!response.ok) {
                        throw new Error('Failed to load conversation');
                    }
                    const payload = await response.json();
                    const incoming = Array.isArray(payload.messages) ? payload.messages : [];
                    state.messages = incoming;
                    clearError();
                } catch (error) {
                    console.error('Failed to load messages', error);
                    if (!silent) {
                        showError('Unable to load your messages.');
                    }
                } finally {
                    state.isLoading = false;
                    renderMessages();
                }
            };

            const sendMessage = async () => {
                if (!inputEl) {
                    return;
                }
                const content = inputEl.value.trim();
                if (!content || state.isSending) {
                    return;
                }
                state.isSending = true;
                updateSendButton();
                clearError();

                try {
                    const response = await fetch('/api/firecoast/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content }),
                    });
                    if (!response.ok) {
                        throw new Error('Chat request failed');
                    }
                    const payload = await response.json();
                    const incoming = Array.isArray(payload.messages) ? payload.messages : [];
                    state.messages = state.messages.concat(incoming);
                    inputEl.value = '';
                    updateSendButton();
                    clearError();
                    renderMessages();
                } catch (error) {
                    console.error('Failed to send message', error);
                    showError('Unable to send that message. Please try again.');
                } finally {
                    state.isSending = false;
                    updateSendButton();
                    if (logEl) {
                        logEl.scrollTop = logEl.scrollHeight;
                    }
                }
            };

            if (inputEl) {
                inputEl.addEventListener('input', updateSendButton);
                inputEl.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        sendMessage();
                    }
                });
            }

            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            }

            if (refreshButton) {
                refreshButton.addEventListener('click', () => {
                    loadMessages();
                });
            }

            quickButtons.forEach((button) => {
                button.addEventListener('click', () => {
                    const value = button.getAttribute('data-template') || '';
                    if (inputEl) {
                        inputEl.value = value;
                        updateSendButton();
                        setTimeout(() => inputEl.focus(), QUICK_TEMPLATE_FOCUS_DELAY);
                    }
                });
            });

            loadMessages();
            state.refreshTimer = window.setInterval(() => loadMessages({ silent: true }), 25000);

            window.addEventListener('beforeunload', () => {
                if (state.refreshTimer) {
                    window.clearInterval(state.refreshTimer);
                }
            });
        })();
    </script>
</body>
</html>
