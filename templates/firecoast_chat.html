<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FireCoast DM</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/assets/css/styles.css">
</head>
<body class="bg-[#313338] min-h-screen font-sans text-[#f2f3f5]">
    <nav class="bg-[#1e1f22] text-[#f2f3f5] shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex h-16 items-center justify-between">
                <div class="flex items-center space-x-10">
                    <a href="/dashboard" id="nav-home-link" class="text-lg font-semibold tracking-wide text-white">FireCoast OMS</a>
                    <div class="hidden md:flex items-center space-x-6 text-sm font-medium text-[#b5bac1]">
                        <a href="/orders" class="hover:text-white transition">Orders</a>
                        <a href="/contacts" class="hover:text-white transition">Contacts</a>
                        <a href="/analytics" class="hover:text-white transition">Analytics</a>
                        <a href="/passwords" class="hover:text-white transition">Password Manager</a>
                        <a href="/reminders" class="hover:text-white transition">Reminders</a>
                        <a href="/calendar" class="hover:text-white transition">Calendar</a>
                        <a href="/firecoast" class="text-white">FireCoast Chat</a>
                    </div>
                </div>
                <div class="flex items-center space-x-3 text-sm font-medium">
                    <a href="/settings" class="text-[#b5bac1] hover:text-white transition">Settings</a>
                    <a href="#" id="nav-log-out" class="text-[#b5bac1] hover:text-white transition">Log Out</a>
                </div>
            </div>
        </div>
    </nav>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const brandLink = document.getElementById('nav-home-link');
            if (brandLink) {
                brandLink.addEventListener('click', (event) => {
                    event.preventDefault();
                    window.location.href = '/dashboard';
                });
            }
            const logoutLink = document.getElementById('nav-log-out');
            if (logoutLink) {
                logoutLink.addEventListener('click', async (event) => {
                    event.preventDefault();
                    if (window.fireCoastLogout) {
                        window.fireCoastLogout();
                        return;
                    }
                    try {
                        const response = await fetch('/shutdown', { method: 'POST' });
                        if (response.ok) {
                            document.body.innerHTML = '<div class="min-h-screen flex items-center justify-center text-slate-700 text-lg">Application has been shut down. You can now close this tab.</div>';
                        } else {
                            alert('Failed to log out.');
                        }
                    } catch (error) {
                        console.error('Error logging out:', error);
                        alert('Error attempting to log out.');
                    }
                });
            }
        });
    </script>

    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-8">
        <header class="space-y-3">
            <p class="text-sm uppercase tracking-[0.3em] text-[#949ba4]">FireCoast Assistant</p>
            <h1 class="text-3xl sm:text-4xl font-bold text-white">Direct Messages</h1>
            <p class="text-[#b5bac1] max-w-2xl">
                Keep private notes, queue reminders and events, and chat with <span class="font-semibold text-white">@firecoast</span> just like a personal Discord DM.
            </p>
        </header>
        <section class="rounded-3xl border border-white/10 shadow-xl shadow-black/20 bg-gradient-to-br from-[#2b2d31] via-[#313338] to-[#232428]">
            <div id="firecoast-chat-root" class="flex h-[720px] flex-col"></div>
        </section>
    </main>

    <script type="text/babel" data-presets="env,react">
        const { useCallback, useEffect, useRef, useState } = React;

        const QUICK_TEMPLATES = [
            { label: '.reminder', value: '.reminder Follow up | tomorrow 9am | add tracking number' },
            { label: '.event', value: '.event Project kickoff | next Tuesday 2pm | next Tuesday 3:30pm | HQ West | finalize agenda' },
            { label: 'Passwords', value: '@firecoast what\'s my password for Example' },
            { label: 'Reports', value: '.report orders_overview from 2024-01-01 to 2024-03-31' },
        ];

        const formatDateTime = (iso, withTime = true) => {
            if (!iso) return '';
            try {
                const date = new Date(iso);
                if (Number.isNaN(date.getTime())) {
                    return iso;
                }
                const options = withTime
                    ? { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }
                    : { year: 'numeric', month: 'short', day: 'numeric' };
                return new Intl.DateTimeFormat(undefined, options).format(date);
            } catch (error) {
                return iso;
            }
        };

        const formatEventWindow = (event) => {
            if (!event || !event.start_at) {
                return '';
            }
            const start = new Date(event.start_at);
            const end = new Date(event.end_at || event.start_at);
            if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) {
                return formatDateTime(event.start_at, !event.all_day);
            }
            const sameDay = start.toDateString() === end.toDateString();
            if (event.all_day || (start.getHours() === 0 && start.getMinutes() === 0 && sameDay)) {
                return sameDay
                    ? formatDateTime(start.toISOString(), false)
                    : `${formatDateTime(start.toISOString(), false)} – ${formatDateTime(end.toISOString(), false)}`;
            }
            if (sameDay) {
                return `${formatDateTime(start.toISOString(), true)} – ${new Intl.DateTimeFormat(undefined, {
                    hour: 'numeric',
                    minute: '2-digit',
                }).format(end)}`;
            }
            return `${formatDateTime(start.toISOString(), true)} – ${formatDateTime(end.toISOString(), true)}`;
        };

        const MetadataPanel = ({ metadata, isUser }) => {
            if (!metadata || !metadata.action) {
                return null;
            }
            const baseClasses = isUser
                ? 'bg-[#5865f2]/30 border border-[#5865f2]/40 text-[#f2f3f5]'
                : 'bg-[#1e1f22]/90 border border-white/5 text-[#dbdee1]';
            const titleClasses = isUser ? 'text-[#c7cdfd]' : 'text-[#aeb0b7]';

            if (metadata.action === 'calendar_event_created') {
                const event = metadata.event || {};
                return (
                    <div className={`mt-3 rounded-xl px-3 py-2 ${baseClasses}`}>
                        <div className={`text-xs font-semibold uppercase ${titleClasses}`}>Calendar event created</div>
                        <div className={`mt-1 text-sm font-medium ${isUser ? 'text-white' : 'text-[#f2f3f5]'}`}>{event.title || 'Event'}</div>
                        <div className={`text-sm ${isUser ? 'text-white/80' : 'text-[#b5bac1]'}`}>{formatEventWindow(event)}</div>
                        <a href="/calendar" className={`mt-2 inline-flex items-center gap-1 text-xs font-medium ${isUser ? 'text-white/80 hover:text-white' : 'text-[#00a3ff] hover:text-[#66c6ff]'}`}>Open calendar →</a>
                    </div>
                );
            }

            if (metadata.action === 'reminder_created') {
                const reminder = metadata.reminder || {};
                const dueText = reminder.due_at ? formatDateTime(reminder.due_at, reminder.due_has_time) : 'No due date';
                return (
                    <div className={`mt-3 rounded-xl px-3 py-2 ${baseClasses}`}>
                        <div className={`text-xs font-semibold uppercase ${titleClasses}`}>Reminder created</div>
                        <div className={`mt-1 text-sm font-medium ${isUser ? 'text-white' : 'text-[#f2f3f5]'}`}>{reminder.title || 'Reminder'}</div>
                        <div className={`text-sm ${isUser ? 'text-white/80' : 'text-[#b5bac1]'}`}>{dueText}</div>
                        <a href="/reminders" className={`mt-2 inline-flex items-center gap-1 text-xs font-medium ${isUser ? 'text-white/80 hover:text-white' : 'text-[#00a3ff] hover:text-[#66c6ff]'}`}>View reminders →</a>
                    </div>
                );
            }

            if (metadata.action === 'password_lookup') {
                const matches = Array.isArray(metadata.matches) ? metadata.matches : [];
                if (!matches.length) {
                    return null;
                }
                return (
                    <div className={`mt-3 rounded-xl px-3 py-2 ${baseClasses}`}>
                        <div className={`text-xs font-semibold uppercase ${titleClasses}`}>Saved passwords</div>
                        <div className="mt-2 space-y-1 text-sm">
                            {matches.slice(0, 5).map((entry) => (
                                <div key={entry.id || `${entry.service}-${entry.username}`} className={isUser ? 'text-white/80' : 'text-[#dbdee1]'}>
                                    <span className="font-medium">{entry.service || 'Service'}</span>
                                    <span className="ml-2 text-xs uppercase tracking-wide align-middle px-2 py-0.5 rounded-full bg-[#3f4147] text-[#f2f3f5]">{entry.username || 'no user'}</span>
                                    <div className={`text-xs mt-1 ${isUser ? 'text-white/80' : 'text-[#b5bac1]'}`}>{entry.password ? `Password: ${entry.password}` : 'No password saved'}</div>
                                </div>
                            ))}
                            {matches.length > 5 && (
                                <div className={`text-xs ${isUser ? 'text-white/70' : 'text-[#aeb0b7]'}`}>…and {matches.length - 5} more saved credentials.</div>
                            )}
                        </div>
                        <a href="/passwords" className={`mt-2 inline-flex items-center gap-1 text-xs font-medium ${isUser ? 'text-white/80 hover:text-white' : 'text-[#00a3ff] hover:text-[#66c6ff]'}`}>Open password vault →</a>
                    </div>
                );
            }

            if (metadata.action === 'report_run') {
                const report = metadata.report || {};
                const summary = Array.isArray(report.summary) ? report.summary.slice(0, 4) : [];
                return (
                    <div className={`mt-3 rounded-xl px-3 py-2 ${baseClasses}`}>
                        <div className={`text-xs font-semibold uppercase ${titleClasses}`}>Report generated</div>
                        <div className={`mt-1 text-sm font-medium ${isUser ? 'text-white' : 'text-[#f2f3f5]'}`}>{report.name || report.id || 'Analytics report'}</div>
                        <ul className={`mt-2 space-y-1 text-sm ${isUser ? 'text-white/80' : 'text-[#dbdee1]'}`}>
                            {summary.map((entry) => (
                                <li key={entry.id || entry.label}>{entry.label || entry.id}: <span className="font-semibold">{entry.display || entry.value}</span></li>
                            ))}
                        </ul>
                        <a href="/analytics" className={`mt-2 inline-flex items-center gap-1 text-xs font-medium ${isUser ? 'text-white/80 hover:text-white' : 'text-[#00a3ff] hover:text-[#66c6ff]'}`}>Open analytics →</a>
                    </div>
                );
            }

            if (metadata.action === 'report_list') {
                const reports = Array.isArray(metadata.reports) ? metadata.reports : [];
                return (
                    <div className={`mt-3 rounded-xl px-3 py-2 ${baseClasses}`}>
                        <div className={`text-xs font-semibold uppercase ${titleClasses}`}>Available reports</div>
                        <ul className={`mt-2 space-y-1 text-sm ${isUser ? 'text-white/80' : 'text-[#dbdee1]'}`}>
                            {reports.map((report) => (
                                <li key={report.id}><span className="font-medium">{report.id}</span> — {report.name}</li>
                            ))}
                        </ul>
                    </div>
                );
            }

            if (metadata.action === 'error') {
                return (
                    <div className={`mt-3 rounded-xl px-3 py-2 ${isUser ? 'bg-[#db4b4b]/20 text-white' : 'bg-[#4e2727] border border-[#f47070]/50 text-[#f47070]'}`}>
                        <div className={`text-xs font-semibold uppercase ${isUser ? 'text-white/80' : 'text-[#f47070]'}`}>Something went wrong</div>
                        <div className={`text-sm ${isUser ? 'text-white' : 'text-[#f2f3f5]'}`}>{metadata.reason || 'Unable to process the request.'}</div>
                    </div>
                );
            }

            return null;
        };

        const MessageBubble = ({ message }) => {
            const isUser = (message.author || '').toLowerCase() === 'user';
            const containerClasses = isUser
                ? 'flex flex-row-reverse items-start gap-3'
                : 'flex items-start gap-3';
            const bubbleClasses = isUser
                ? 'bg-[#5865f2]/30 border border-[#5865f2]/40 text-[#f2f3f5]'
                : 'bg-[#1e1f22] border border-white/5 text-[#dbdee1]';
            const avatarClasses = isUser
                ? 'bg-[#5865f2] text-white'
                : 'bg-[#404249] text-[#f2f3f5]';
            const label = isUser ? 'You' : '@firecoast';
            const timestamp = formatDateTime(message.created_at, true);

            return (
                <div className={containerClasses}>
                    <div className={`mt-1 flex h-10 w-10 shrink-0 select-none items-center justify-center rounded-full text-sm font-semibold uppercase ${avatarClasses}`}>
                        {isUser ? 'Y' : 'F'}
                    </div>
                    <div className={`max-w-2xl rounded-2xl px-4 py-3 shadow-md shadow-black/20 ${bubbleClasses}`}>
                        <div className={`mb-1 flex items-baseline justify-between gap-4 text-xs uppercase tracking-wide ${isUser ? 'text-[#c7cdfd]' : 'text-[#aeb0b7]'}`}>
                            <span>{label}</span>
                            <span className="text-[0.65rem] normal-case">{timestamp}</span>
                        </div>
                        <div className="whitespace-pre-wrap leading-relaxed">
                            {message.content || ''}
                        </div>
                        <MetadataPanel metadata={message.metadata} isUser={isUser} />
                    </div>
                </div>
            );
        };

        const ChatApp = () => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [isSending, setIsSending] = useState(false);
            const [error, setError] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const scrollRef = useRef(null);

            const fetchMessages = useCallback(async (options = {}) => {
                const silent = Boolean(options.silent);
                if (!silent) {
                    setIsLoading(true);
                }
                try {
                    const response = await fetch('/api/firecoast/chat?limit=200');
                    if (!response.ok) {
                        throw new Error('Failed to load conversation');
                    }
                    const data = await response.json();
                    setMessages(Array.isArray(data.messages) ? data.messages : []);
                    setError(null);
                } catch (err) {
                    console.error(err);
                    if (!silent) {
                        setError('Unable to load your messages.');
                    }
                }
                if (!silent) {
                    setIsLoading(false);
                }
            }, []);

            useEffect(() => {
                fetchMessages();
            }, [fetchMessages]);

            useEffect(() => {
                const interval = setInterval(() => {
                    fetchMessages({ silent: true });
                }, 25000);
                return () => clearInterval(interval);
            }, [fetchMessages]);

            useEffect(() => {
                const el = scrollRef.current;
                if (!el) return;
                el.scrollTop = el.scrollHeight;
            }, [messages]);

            const sendMessage = useCallback(async () => {
                const trimmed = input.trim();
                if (!trimmed || isSending) {
                    return;
                }
                setIsSending(true);
                setError(null);
                try {
                    const response = await fetch('/api/firecoast/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: trimmed }),
                    });
                    if (!response.ok) {
                        throw new Error('Chat request failed');
                    }
                    const data = await response.json();
                    const incoming = Array.isArray(data.messages) ? data.messages : [];
                    setMessages((prev) => [...prev, ...incoming]);
                    setInput('');
                } catch (err) {
                    console.error(err);
                    setError('Unable to send that message. Please try again.');
                } finally {
                    setIsSending(false);
                }
            }, [input, isSending]);

            const handleKeyDown = useCallback((event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            }, [sendMessage]);

            const canSend = input.trim().length > 0 && !isSending;

            return (
                <div className="flex h-full flex-col">
                    <div className="flex items-center justify-between border-b border-white/10 px-8 py-5">
                        <div className="space-y-1">
                            <div className="flex items-center gap-2 text-white">
                                <span className="rounded-full bg-[#5865f2] px-3 py-1 text-xs uppercase tracking-wide">@firecoast</span>
                                <span className="text-xs font-medium text-[#b5bac1]">always on</span>
                            </div>
                            <h2 className="text-2xl font-semibold text-white">Personal Console</h2>
                            <p className="text-sm text-[#b5bac1]">Messages stay private to you. Ask for passwords, spin up reminders, or jot quick thoughts.</p>
                        </div>
                        <button
                            type="button"
                            onClick={fetchMessages}
                            className="inline-flex items-center gap-2 rounded-xl border border-white/10 px-4 py-2 text-sm font-medium text-[#b5bac1] hover:border-white/30 hover:text-white transition"
                        >
                            <span>Refresh</span>
                            <span className="text-lg">↺</span>
                        </button>
                    </div>
                    <div ref={scrollRef} className="flex-1 overflow-y-auto px-8 py-6 space-y-4 bg-[#313338]/40 backdrop-blur">
                        {isLoading ? (
                            <div className="flex h-full items-center justify-center text-sm text-[#b5bac1]">Loading your conversation…</div>
                        ) : messages.length === 0 ? (
                            <div className="flex h-full flex-col items-center justify-center gap-4 text-center text-sm text-[#b5bac1]">
                                <div className="rounded-full bg-[#404249] px-4 py-2 text-xs uppercase tracking-[0.3em] text-[#f2f3f5]">Start chatting</div>
                                <p>Send yourself notes and tasks. Try <code className="rounded bg-[#1e1f22] px-2 py-1 text-xs">.reminder Send invoices | tomorrow 9am</code> to see it in action.</p>
                            </div>
                        ) : (
                            messages.map((message) => <MessageBubble key={message.id} message={message} />)
                        )}
                    </div>
                    <div className="space-y-4 border-t border-white/10 bg-[#2b2d31] px-8 py-6">
                        {error && <p className="text-sm text-[#f47070]">{error}</p>}
                        <div className="flex flex-wrap gap-2">
                            {QUICK_TEMPLATES.map((template) => (
                                <button
                                    key={template.label}
                                    type="button"
                                    className="rounded-full border border-white/10 px-4 py-1.5 text-sm text-[#b5bac1] transition hover:border-[#5865f2] hover:text-white"
                                    onClick={() => setInput(template.value)}
                                >
                                    {template.label}
                                </button>
                            ))}
                        </div>
                        <div className="flex items-end gap-3">
                            <textarea
                                className="flex-1 resize-none rounded-2xl border border-white/10 bg-[#1e1f22] px-4 py-3 text-sm text-[#f2f3f5] outline-none transition focus:border-[#5865f2] focus:ring-1 focus:ring-[#5865f2]/60"
                                rows={3}
                                value={input}
                                onChange={(event) => setInput(event.target.value)}
                                onKeyDown={handleKeyDown}
                                placeholder="Type a message. Use Shift+Enter for a new line."
                            />
                            <button
                                type="button"
                                onClick={sendMessage}
                                disabled={!canSend}
                                className="inline-flex items-center gap-2 rounded-2xl bg-[#5865f2] px-5 py-3 text-sm font-semibold text-white shadow-lg shadow-[#000]/30 transition hover:bg-[#4752c4] disabled:cursor-not-allowed disabled:opacity-40"
                            >
                                <span>Send</span>
                                <span className="text-lg">↩</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        document.addEventListener('DOMContentLoaded', () => {
            const rootEl = document.getElementById('firecoast-chat-root');
            if (rootEl) {
                const root = ReactDOM.createRoot(rootEl);
                root.render(<ChatApp />);
            }
        });
    </script>
</body>
</html>
