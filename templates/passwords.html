<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Manager - FireCoast OMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    <nav class="bg-slate-900 text-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex h-16 items-center justify-between">
                <div class="flex items-center space-x-10">
                    <a href="/dashboard" id="nav-home-link" class="text-lg font-semibold tracking-wide">FireCoast OMS</a>
                    <div class="hidden md:flex items-center space-x-6 text-sm font-medium">
                        <a href="/orders" class="hover:text-orange-300 transition">Orders</a>
                        <a href="/contacts" class="hover:text-orange-300 transition">Contacts</a>
                        <a href="/analytics" class="hover:text-orange-300 transition">Analytics</a>
                        <a href="/passwords" class="text-orange-300">Password Manager</a>
                    </div>
                </div>
                <div class="flex items-center space-x-3 text-sm font-medium">
                    <a href="/settings" class="hover:text-orange-300 transition">Settings</a>
                    <a href="#" id="nav-log-out" class="hover:text-orange-300 transition">Log Out</a>
                </div>
            </div>
        </div>
    </nav>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const brandLink = document.getElementById('nav-home-link');
            if (brandLink) {
                brandLink.addEventListener('click', (event) => {
                    event.preventDefault();
                    window.location.href = '/dashboard';
                });
            }

            const logoutLink = document.getElementById('nav-log-out');
            if (logoutLink) {
                logoutLink.addEventListener('click', async (event) => {
                    event.preventDefault();
                    try {
                        const response = await fetch('/shutdown', { method: 'POST' });
                        if (response.ok) {
                            document.body.innerHTML = '<div class="min-h-screen flex items-center justify-center text-slate-700 text-lg">Application has been shut down. You can now close this tab.</div>';
                        } else {
                            alert('Failed to log out.');
                        }
                    } catch (error) {
                        console.error('Error logging out:', error);
                        alert('Error attempting to log out.');
                    }
                });
            }
        });
    </script>

    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-8">
        <header class="space-y-2">
            <p class="text-sm uppercase tracking-[0.3em] text-slate-500">Security</p>
            <h1 class="text-3xl font-bold text-slate-800">Password Manager</h1>
            <p class="text-slate-600 max-w-3xl">Store and share service credentials securely within FireCoast OMS. Entries are scoped to your team and can be edited or removed as responsibilities change.</p>
        </header>

        <section class="bg-white border border-slate-200 rounded-xl shadow-sm p-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                <div>
                    <h2 class="text-xl font-semibold text-slate-800" id="passwordFormTitle">Add Credential</h2>
                    <p class="text-sm text-slate-500">Keep the form concise—only the fields you complete will be saved.</p>
                </div>
                <div id="passwordAlert" class="text-sm"></div>
            </div>
            <form id="passwordForm" class="space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600" for="passwordService">Service</label>
                        <input type="text" id="passwordService" name="service" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md focus:outline-none focus:ring-orange-500 focus:border-orange-500" placeholder="e.g. ShipStation" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600" for="passwordUsername">Username / Email</label>
                        <input type="text" id="passwordUsername" name="username" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md focus:outline-none focus:ring-orange-500 focus:border-orange-500" placeholder="login@example.com" />
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600" for="passwordValue">Password</label>
                        <input type="text" id="passwordValue" name="password" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md focus:outline-none focus:ring-orange-500 focus:border-orange-500" placeholder="••••••••" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600" for="passwordNotes">Notes</label>
                        <input type="text" id="passwordNotes" name="notes" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md focus:outline-none focus:ring-orange-500 focus:border-orange-500" placeholder="Optional context" />
                    </div>
                </div>
                <div class="flex flex-wrap items-center gap-3 justify-end">
                    <button type="button" id="cancelEditButton" class="hidden px-4 py-2 text-sm font-semibold text-slate-600 border border-slate-300 rounded-md hover:bg-slate-100 transition-colors">Cancel</button>
                    <button type="submit" id="passwordSubmitButton" class="px-4 py-2 bg-orange-600 text-white font-semibold rounded-md shadow-sm hover:bg-orange-700 transition-colors">Save Entry</button>
                </div>
            </form>
        </section>

        <section class="bg-white border border-slate-200 rounded-xl shadow-sm">
            <div class="px-6 py-4 border-b border-slate-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h2 class="text-lg font-semibold text-slate-800">Stored Credentials</h2>
                    <p class="text-sm text-slate-500">Passwords are stored locally in the OMS data directory.</p>
                </div>
                <input type="search" id="passwordSearch" placeholder="Filter by service or username" class="w-full sm:w-72 rounded-md border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500" />
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600" id="passwordTable">
                    <thead class="text-xs uppercase bg-slate-100 text-slate-700">
                        <tr>
                            <th class="px-6 py-3">Service</th>
                            <th class="px-6 py-3">Username</th>
                            <th class="px-6 py-3">Password</th>
                            <th class="px-6 py-3">Notes</th>
                            <th class="px-6 py-3">Updated</th>
                            <th class="px-6 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="passwordRows"></tbody>
                </table>
            </div>
            <div id="passwordEmpty" class="hidden px-6 py-10 text-center text-slate-500 border-t border-slate-200">
                No credentials stored yet. Add your first entry above.
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('passwordForm');
            const submitButton = document.getElementById('passwordSubmitButton');
            const cancelButton = document.getElementById('cancelEditButton');
            const alertBox = document.getElementById('passwordAlert');
            const tableBody = document.getElementById('passwordRows');
            const emptyState = document.getElementById('passwordEmpty');
            const searchInput = document.getElementById('passwordSearch');

            let entries = [];
            let editingId = null;

            const showAlert = (message, tone = 'info') => {
                if (!alertBox) return;
                const toneClass = tone === 'error' ? 'text-red-600' : tone === 'success' ? 'text-green-600' : 'text-slate-400';
                alertBox.className = `text-sm ${toneClass}`;
                alertBox.textContent = message;
                if (message) {
                    setTimeout(() => {
                        alertBox.textContent = '';
                        alertBox.className = 'text-sm';
                    }, 4000);
                }
            };

            const maskPassword = (value) => {
                if (!value) return '••••••••';
                return '•'.repeat(Math.max(8, Math.min(12, value.length)));
            };

            const escapeHtml = (value = '') => String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');

            const encodeDataset = (value = '') => encodeURIComponent(value);
            const decodeDataset = (value = '') => {
                try {
                    return decodeURIComponent(value);
                } catch (error) {
                    return value;
                }
            };

            const renderEntries = () => {
                if (!Array.isArray(entries)) {
                    entries = [];
                }
                const filtered = entries.filter(entry => {
                    const term = (searchInput.value || '').toLowerCase();
                    if (!term) return true;
                    return (
                        entry.service.toLowerCase().includes(term) ||
                        (entry.username || '').toLowerCase().includes(term)
                    );
                });

                if (filtered.length === 0) {
                    tableBody.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }

                emptyState.classList.add('hidden');
                const rows = filtered
                    .slice()
                    .sort((a, b) => a.service.localeCompare(b.service))
                    .map((entry) => {
                        const updated = entry.updatedAt ? new Date(entry.updatedAt).toLocaleString() : '—';
                        const notes = escapeHtml(entry.notes || '—');
                        const masked = maskPassword(entry.password || '');
                        const encodedPassword = encodeDataset(entry.password || '');
                        const service = escapeHtml(entry.service);
                        const username = escapeHtml(entry.username || '—');
                        return `
                            <tr class="border-t border-slate-200" data-entry-id="${entry.id}">
                                <td class="px-6 py-3 font-medium text-slate-800">${service}</td>
                                <td class="px-6 py-3 text-slate-600">${username}</td>
                                <td class="px-6 py-3">
                                    <span class="font-mono text-slate-800" data-password-value="${encodedPassword}" data-password-visible="false">${masked}</span>
                                </td>
                                <td class="px-6 py-3 text-slate-500">${notes}</td>
                                <td class="px-6 py-3 text-slate-500">${escapeHtml(updated)}</td>
                                <td class="px-6 py-3">
                                    <div class="flex flex-wrap justify-end gap-2">
                                        <button type="button" class="text-xs text-slate-500 hover:text-orange-600" data-action="toggle" data-entry-id="${entry.id}">Show</button>
                                        <button type="button" class="text-xs text-slate-500 hover:text-orange-600" data-action="copy-password" data-entry-id="${entry.id}">Copy Password</button>
                                        <button type="button" class="text-xs text-slate-500 hover:text-orange-600" data-action="copy-username" data-entry-id="${entry.id}">Copy Username</button>
                                        <button type="button" class="text-xs text-slate-500 hover:text-orange-600" data-action="edit" data-entry-id="${entry.id}">Edit</button>
                                        <button type="button" class="text-xs text-red-600 hover:text-red-700" data-action="delete" data-entry-id="${entry.id}">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    })
                    .join('');
                tableBody.innerHTML = rows;
            };

            const loadEntries = async () => {
                try {
                    const response = await fetch('/api/passwords');
                    if (!response.ok) {
                        throw new Error('Failed to load passwords');
                    }
                    const data = await response.json();
                    entries = Array.isArray(data) ? data : [];
                    renderEntries();
                } catch (error) {
                    console.error(error);
                    showAlert('Unable to load password entries.', 'error');
                }
            };

            const resetForm = () => {
                editingId = null;
                form.reset();
                submitButton.textContent = 'Save Entry';
                document.getElementById('passwordFormTitle').textContent = 'Add Credential';
                cancelButton.classList.add('hidden');
            };

            const populateForm = (entry) => {
                document.getElementById('passwordService').value = entry.service || '';
                document.getElementById('passwordUsername').value = entry.username || '';
                document.getElementById('passwordValue').value = entry.password || '';
                document.getElementById('passwordNotes').value = entry.notes || '';
            };

            tableBody.addEventListener('click', async (event) => {
                const button = event.target.closest('button[data-action]');
                if (!button) return;
                const entryId = button.getAttribute('data-entry-id');
                const action = button.getAttribute('data-action');
                const entry = entries.find(e => e.id === entryId);
                if (!entry) return;

                if (action === 'toggle') {
                    const span = button.closest('tr').querySelector('span[data-password-value]');
                    const isVisible = span.getAttribute('data-password-visible') === 'true';
                    const rawPassword = decodeDataset(span.getAttribute('data-password-value') || '');
                    if (isVisible) {
                        span.textContent = maskPassword(rawPassword);
                        span.setAttribute('data-password-visible', 'false');
                        button.textContent = 'Show';
                    } else {
                        span.textContent = rawPassword;
                        span.setAttribute('data-password-visible', 'true');
                        button.textContent = 'Hide';
                    }
                } else if (action === 'copy-password') {
                    try {
                        await navigator.clipboard.writeText(entry.password || '');
                        showAlert('Password copied to clipboard.', 'success');
                    } catch (error) {
                        console.error(error);
                        showAlert('Unable to copy password.', 'error');
                    }
                } else if (action === 'copy-username') {
                    try {
                        await navigator.clipboard.writeText(entry.username || '');
                        showAlert('Username copied to clipboard.', 'success');
                    } catch (error) {
                        console.error(error);
                        showAlert('Unable to copy username.', 'error');
                    }
                } else if (action === 'edit') {
                    editingId = entry.id;
                    populateForm(entry);
                    submitButton.textContent = 'Update Entry';
                    document.getElementById('passwordFormTitle').textContent = `Edit ${entry.service}`;
                    cancelButton.classList.remove('hidden');
                    window.scrollTo({ top: form.offsetTop - 80, behavior: 'smooth' });
                } else if (action === 'delete') {
                    if (!confirm(`Delete credentials for ${entry.service}?`)) {
                        return;
                    }
                    try {
                        const response = await fetch(`/api/passwords/${entry.id}`, { method: 'DELETE' });
                        if (!response.ok) {
                            throw new Error('Delete failed');
                        }
                        showAlert('Entry deleted.', 'success');
                        await loadEntries();
                        if (editingId === entry.id) {
                            resetForm();
                        }
                    } catch (error) {
                        console.error(error);
                        showAlert('Unable to delete entry.', 'error');
                    }
                }
            });

            cancelButton.addEventListener('click', (event) => {
                event.preventDefault();
                resetForm();
            });

            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                submitButton.disabled = true;
                submitButton.textContent = editingId ? 'Updating…' : 'Saving…';
                const payload = {
                    service: document.getElementById('passwordService').value.trim(),
                    username: document.getElementById('passwordUsername').value.trim(),
                    password: document.getElementById('passwordValue').value,
                    notes: document.getElementById('passwordNotes').value.trim(),
                };
                try {
                    const url = editingId ? `/api/passwords/${editingId}` : '/api/passwords';
                    const method = editingId ? 'PUT' : 'POST';
                    const response = await fetch(url, {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    if (!response.ok) {
                        throw new Error('Failed to save entry');
                    }
                    showAlert(editingId ? 'Entry updated.' : 'Entry saved.', 'success');
                    await loadEntries();
                    resetForm();
                } catch (error) {
                    console.error(error);
                    showAlert('Unable to save entry.', 'error');
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = editingId ? 'Update Entry' : 'Save Entry';
                }
            });

            searchInput.addEventListener('input', () => {
                renderEntries();
            });

            loadEntries();
        });
    </script>
</body>
</html>
