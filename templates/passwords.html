<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passwords</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body class="bg-slate-50 min-h-screen font-sans">
    {% include 'partials/navbar.html' %}

    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <h1 class="text-3xl font-bold text-slate-800">Password Manager</h1>
            <button
                type="button"
                id="openPasswordModal"
                class="inline-flex items-center justify-center gap-2 rounded-md px-4 py-2 text-sm font-semibold shadow-sm bg-orange-600 text-white hover:bg-orange-700 transition"
            >
                + New Entry
            </button>
        </div>

        <section class="bg-white border border-slate-200 rounded-xl shadow-sm">
            <div class="px-6 py-4 border-b border-slate-200 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h2 class="text-lg font-semibold text-slate-800">Stored Credentials</h2>
                </div>
                <input type="search" id="passwordSearch" placeholder="Filter by service or username" class="w-full sm:w-72 rounded-md border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500" />
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600" id="passwordTable">
                    <thead class="text-xs uppercase bg-slate-100 text-slate-700">
                        <tr>
                            <th class="px-6 py-3">Service</th>
                            <th class="px-6 py-3">Username</th>
                            <th class="px-6 py-3">Password</th>
                            <th class="px-6 py-3">Notes</th>
                            <th class="px-6 py-3">Updated</th>
                            <th class="px-6 py-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="passwordRows"></tbody>
                </table>
            </div>
            <div id="passwordEmpty" class="hidden px-6 py-10 text-center text-slate-500 border-t border-slate-200">
                No credentials stored yet. Add your first entry above.
            </div>
        </section>
    </main>

    <div id="passwordModal" class="hidden fixed inset-0 z-40 flex items-center justify-center px-4">
        <div id="passwordModalBackdrop" class="absolute inset-0 bg-slate-900/60"></div>
        <div id="passwordModalDialog" class="relative w-full max-w-2xl bg-white rounded-xl shadow-2xl border border-slate-200">
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200">
                <h2 id="passwordFormTitle" class="text-xl font-semibold text-slate-800">New Credential</h2>
                <button type="button" id="closePasswordModal" class="rounded-md p-2 text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition" aria-label="Close">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <form id="passwordForm" class="px-6 py-6 space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600" for="passwordService">Service</label>
                        <input type="text" id="passwordService" name="service" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md focus:outline-none focus:ring-orange-500 focus:border-orange-500" placeholder="e.g. ShipStation" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600" for="passwordUsername">Username / Email</label>
                        <input type="text" id="passwordUsername" name="username" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md focus:outline-none focus:ring-orange-500 focus:border-orange-500" placeholder="login@example.com" />
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600" for="passwordValue">Password</label>
                        <input type="text" id="passwordValue" name="password" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md focus:outline-none focus:ring-orange-500 focus:border-orange-500" placeholder="••••••••" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600" for="passwordNotes">Notes</label>
                        <input type="text" id="passwordNotes" name="notes" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md focus:outline-none focus:ring-orange-500 focus:border-orange-500" placeholder="Optional context" />
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 pt-2">
                    <button type="button" id="deletePasswordButton" class="hidden text-sm font-semibold text-red-600 hover:text-red-700 transition">Delete Credential</button>
                    <div class="flex items-center gap-3 sm:ml-auto">
                        <button type="button" id="cancelPasswordModal" class="px-4 py-2 text-sm font-semibold text-slate-600 border border-slate-300 rounded-md hover:bg-slate-100 transition">Cancel</button>
                        <button type="submit" id="passwordSubmitButton" class="px-4 py-2 bg-orange-600 text-white text-sm font-semibold rounded-md shadow-sm hover:bg-orange-700 transition">Save Entry</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="passwordToast" class="pointer-events-none fixed top-6 left-1/2 -translate-x-1/2 z-50 hidden">
        <div id="passwordToastMessage" class="text-sm"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('passwordForm');
            const submitButton = document.getElementById('passwordSubmitButton');
            const tableBody = document.getElementById('passwordRows');
            const emptyState = document.getElementById('passwordEmpty');
            const searchInput = document.getElementById('passwordSearch');
            const openModalButton = document.getElementById('openPasswordModal');
            const modal = document.getElementById('passwordModal');
            const modalBackdrop = document.getElementById('passwordModalBackdrop');
            const closeModalButton = document.getElementById('closePasswordModal');
            const cancelModalButton = document.getElementById('cancelPasswordModal');
            const deleteButton = document.getElementById('deletePasswordButton');
            const modalTitle = document.getElementById('passwordFormTitle');
            const toast = document.getElementById('passwordToast');
            const toastMessage = document.getElementById('passwordToastMessage');

            let entries = [];
            let editingId = null;
            let toastTimer = null;

            const successIcon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-emerald-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-7.25 9a.75.75 0 0 1-1.154.057l-3.25-3.5a.75.75 0 1 1 1.102-1.018l2.65 2.852 6.7-8.322a.75.75 0 0 1 1.059-.121z" clip-rule="evenodd" /></svg>';
            const errorIcon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-.75-11.5a.75.75 0 011.5 0v4.5a.75.75 0 01-1.5 0V6.5zm.75 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>';

            const showToast = (message, tone = 'info') => {
                if (!toast || !toastMessage || !message) {
                    return;
                }
                const safeMessage = escapeHtml(message);
                let className = 'inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-medium shadow-lg';
                let content = safeMessage;
                if (tone === 'success') {
                    className += ' border border-slate-200 bg-white text-slate-700';
                    content = `<span class="inline-flex items-center gap-2">${successIcon}${safeMessage}</span>`;
                } else if (tone === 'error') {
                    className += ' bg-red-600 text-white';
                    content = `<span class="inline-flex items-center gap-2">${errorIcon}${safeMessage}</span>`;
                } else {
                    className += ' border border-slate-200 bg-white text-slate-700';
                }
                toastMessage.className = className;
                toastMessage.innerHTML = content;
                toast.classList.remove('hidden');
                if (toastTimer) {
                    clearTimeout(toastTimer);
                }
                toastTimer = setTimeout(() => {
                    toast.classList.add('hidden');
                    toastTimer = null;
                }, 3200);
            };

            const maskPassword = (value) => {
                if (!value) return '••••••••';
                return '•'.repeat(Math.max(8, Math.min(12, value.length)));
            };

            const escapeHtml = (value = '') => String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');

            const encodeDataset = (value = '') => encodeURIComponent(value);
            const decodeDataset = (value = '') => {
                try {
                    return decodeURIComponent(value);
                } catch (error) {
                    return value;
                }
            };

            const renderEntries = () => {
                if (!Array.isArray(entries)) {
                    entries = [];
                }
                const filtered = entries.filter(entry => {
                    const term = (searchInput.value || '').toLowerCase();
                    if (!term) return true;
                    return (
                        entry.service.toLowerCase().includes(term) ||
                        (entry.username || '').toLowerCase().includes(term)
                    );
                });

                if (filtered.length === 0) {
                    tableBody.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }

                emptyState.classList.add('hidden');
                const rows = filtered
                    .slice()
                    .sort((a, b) => a.service.localeCompare(b.service))
                    .map((entry) => {
                        const updated = entry.updatedAt ? new Date(entry.updatedAt).toLocaleString() : '—';
                        const notes = escapeHtml(entry.notes || '—');
                        const masked = maskPassword(entry.password || '');
                        const encodedPassword = encodeDataset(entry.password || '');
                        const hasUsername = Boolean(entry.username);
                        const encodedUsername = hasUsername ? encodeDataset(entry.username) : '';
                        const service = escapeHtml(entry.service);
                        const username = escapeHtml(entry.username || '—');
                        const usernameSpanClass = hasUsername ? 'cursor-pointer hover:text-orange-600' : 'text-slate-400';
                        const usernameDataAttr = hasUsername ? ` data-username-value="${encodedUsername}" title="Click to copy username"` : '';
                        return `
                            <tr class="border-t border-slate-200" data-entry-id="${entry.id}">
                                <td class="px-6 py-3 font-medium text-slate-800">${service}</td>
                                <td class="px-6 py-3 text-slate-600">
                                    <span class="${usernameSpanClass}"${usernameDataAttr}>${username}</span>
                                </td>
                                <td class="px-6 py-3">
                                    <span class="font-mono text-slate-800 cursor-pointer hover:text-orange-600 select-none" data-password-value="${encodedPassword}" data-password-visible="false" title="Click to copy password when visible">${masked}</span>
                                </td>
                                <td class="px-6 py-3 text-slate-500">${notes}</td>
                                <td class="px-6 py-3 text-slate-500">${escapeHtml(updated)}</td>
                                <td class="px-6 py-3">
                                    <div class="flex justify-end gap-2">
                                        <button type="button" class="inline-flex items-center justify-center rounded-full p-2 text-slate-500 hover:text-orange-600 hover:bg-orange-50 transition" data-action="toggle" data-entry-id="${entry.id}" aria-label="Show password">
                                            <svg data-icon="show" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M2.25 12s3.75-6 9.75-6 9.75 6 9.75 6-3.75 6-9.75 6-9.75-6-9.75-6z" />
                                                <circle cx="12" cy="12" r="2.25" />
                                            </svg>
                                            <svg data-icon="hide" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M3 3l18 18" />
                                                <path d="M10.58 10.58A2 2 0 0012 14a2 2 0 001.42-.58" />
                                                <path d="M9.88 4.24A10.13 10.13 0 0112 4c6 0 9.75 6 9.75 6a18.42 18.42 0 01-2.21 2.88" />
                                                <path d="M6.12 6.12A18.39 18.39 0 002.25 10s3.75 6 9.75 6a10.49 10.49 0 004.24-.88" />
                                            </svg>
                                            <span class="sr-only">Toggle password visibility</span>
                                        </button>
                                        <button type="button" class="inline-flex items-center justify-center rounded-full p-2 text-slate-500 hover:text-orange-600 hover:bg-orange-50 transition" data-action="edit" data-entry-id="${entry.id}" aria-label="Edit credential">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.77.77-2.685a4.5 4.5 0 011.13-1.897L16.862 4.487z" />
                                                <path d="M19.5 7.125L17.377 5" />
                                            </svg>
                                            <span class="sr-only">Edit credential</span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    })
                    .join('');
                tableBody.innerHTML = rows;
            };

            const loadEntries = async () => {
                try {
                    const response = await fetch('/api/passwords');
                    if (!response.ok) {
                        throw new Error('Failed to load passwords');
                    }
                    const data = await response.json();
                    entries = Array.isArray(data) ? data : [];
                    renderEntries();
                } catch (error) {
                    console.error(error);
                    showToast('Unable to load password entries.', 'error');
                }
            };

            const populateForm = (entry) => {
                document.getElementById('passwordService').value = entry.service || '';
                document.getElementById('passwordUsername').value = entry.username || '';
                document.getElementById('passwordValue').value = entry.password || '';
                document.getElementById('passwordNotes').value = entry.notes || '';
            };

            const openModal = (entry = null) => {
                form.reset();
                editingId = entry ? entry.id : null;
                if (entry) {
                    populateForm(entry);
                    modalTitle.textContent = `Edit ${entry.service || 'Credential'}`;
                    submitButton.textContent = 'Save Changes';
                    deleteButton.classList.remove('hidden');
                } else {
                    modalTitle.textContent = 'New Credential';
                    submitButton.textContent = 'Save Entry';
                    deleteButton.classList.add('hidden');
                }
                submitButton.disabled = false;
                modal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
                setTimeout(() => {
                    document.getElementById('passwordService').focus();
                }, 50);
            };

            const closeModal = () => {
                modal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
                editingId = null;
                form.reset();
                submitButton.textContent = 'Save Entry';
                submitButton.disabled = false;
                deleteButton.classList.add('hidden');
            };

            openModalButton.addEventListener('click', () => openModal());
            closeModalButton.addEventListener('click', closeModal);
            cancelModalButton.addEventListener('click', (event) => {
                event.preventDefault();
                closeModal();
            });
            modal.addEventListener('click', (event) => {
                if (event.target === modal || event.target === modalBackdrop) {
                    closeModal();
                }
            });
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && !modal.classList.contains('hidden')) {
                    closeModal();
                }
            });

            tableBody.addEventListener('click', async (event) => {
                const button = event.target.closest('button[data-action]');
                if (button) {
                    const entryId = button.getAttribute('data-entry-id');
                    const action = button.getAttribute('data-action');
                    const entry = entries.find(e => e.id === entryId);
                    if (!entry) return;

                    if (action === 'toggle') {
                        const span = button.closest('tr').querySelector('span[data-password-value]');
                        const isVisible = span.getAttribute('data-password-visible') === 'true';
                        const rawPassword = decodeDataset(span.getAttribute('data-password-value') || '');
                        const showIcon = button.querySelector('[data-icon="show"]');
                        const hideIcon = button.querySelector('[data-icon="hide"]');
                        if (isVisible) {
                            span.textContent = maskPassword(rawPassword);
                            span.setAttribute('data-password-visible', 'false');
                            if (showIcon) showIcon.classList.remove('hidden');
                            if (hideIcon) hideIcon.classList.add('hidden');
                            button.setAttribute('aria-label', 'Show password');
                        } else {
                            span.textContent = rawPassword;
                            span.setAttribute('data-password-visible', 'true');
                            if (showIcon) showIcon.classList.add('hidden');
                            if (hideIcon) hideIcon.classList.remove('hidden');
                            button.setAttribute('aria-label', 'Hide password');
                        }
                    } else if (action === 'edit') {
                        openModal(entry);
                    }
                    return;
                }

                const usernameTarget = event.target.closest('[data-username-value]');
                if (usernameTarget) {
                    const rawUsername = decodeDataset(usernameTarget.getAttribute('data-username-value') || '');
                    if (!rawUsername) {
                        return;
                    }
                    try {
                        await navigator.clipboard.writeText(rawUsername);
                        showToast('Copied to clipboard', 'success');
                    } catch (error) {
                        console.error(error);
                        showToast('Unable to copy username.', 'error');
                    }
                    return;
                }

                const passwordTarget = event.target.closest('span[data-password-value]');
                if (passwordTarget) {
                    const isVisible = passwordTarget.getAttribute('data-password-visible') === 'true';
                    if (!isVisible) {
                        showToast('Reveal the password to copy it.', 'info');
                        return;
                    }
                    const rawPassword = decodeDataset(passwordTarget.getAttribute('data-password-value') || '');
                    if (!rawPassword) {
                        return;
                    }
                    try {
                        await navigator.clipboard.writeText(rawPassword);
                        showToast('Copied to clipboard', 'success');
                    } catch (error) {
                        console.error(error);
                        showToast('Unable to copy password.', 'error');
                    }
                }
            });

            deleteButton.addEventListener('click', async () => {
                if (!editingId) {
                    return;
                }
                const entry = entries.find(e => e.id === editingId);
                const serviceName = entry ? entry.service : 'this credential';
                if (!confirm(`Delete credentials for ${serviceName}?`)) {
                    return;
                }
                try {
                    const response = await fetch(`/api/passwords/${editingId}`, { method: 'DELETE' });
                    if (!response.ok) {
                        throw new Error('Delete failed');
                    }
                    showToast('Entry deleted.', 'success');
                    await loadEntries();
                    closeModal();
                } catch (error) {
                    console.error(error);
                    showToast('Unable to delete entry.', 'error');
                }
            });

            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                submitButton.disabled = true;
                submitButton.textContent = 'Saving…';
                const payload = {
                    service: document.getElementById('passwordService').value.trim(),
                    username: document.getElementById('passwordUsername').value.trim(),
                    password: document.getElementById('passwordValue').value,
                    notes: document.getElementById('passwordNotes').value.trim(),
                };
                try {
                    const url = editingId ? `/api/passwords/${editingId}` : '/api/passwords';
                    const method = editingId ? 'PUT' : 'POST';
                    const response = await fetch(url, {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    if (!response.ok) {
                        throw new Error('Failed to save entry');
                    }
                    showToast(editingId ? 'Entry updated.' : 'Entry saved.', 'success');
                    await loadEntries();
                    closeModal();
                } catch (error) {
                    console.error(error);
                    showToast('Unable to save entry.', 'error');
                    submitButton.disabled = false;
                    submitButton.textContent = editingId ? 'Save Changes' : 'Save Entry';
                    return;
                }
                submitButton.disabled = false;
                submitButton.textContent = editingId ? 'Save Changes' : 'Save Entry';
            });

            searchInput.addEventListener('input', () => {
                renderEntries();
            });

            loadEntries();
        });
    </script>
</body>
</html>
